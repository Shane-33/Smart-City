/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../geometry.js";import t from"../request.js";import{normalizeCentralMeridian as e}from"../geometry/support/normalizeUtils.js";import{srToRESTValue as o}from"../geometry/support/spatialReferenceUtils.js";import{parseUrl as n,encode as a,asValidOptions as r}from"./utils.js";import s from"./support/ImageAngleResult.js";import i from"./support/ImageAreaResult.js";import m from"./support/ImageDistanceResult.js";import u from"./support/ImageHeightResult.js";import c from"./support/ImageIdentifyResult.js";import l from"./support/ImagePixelLocationResult.js";import p from"./support/ImagePointResult.js";import f from"./support/ImageSampleResult.js";import g from"../geometry/SpatialReference.js";function y(t){const e=t?.time;if(e&&(null!=e.start||null!=e.end)){const o=[];null!=e.start&&o.push(e.start),null==e.end||o.includes(e.end)||o.push(e.end),t.time=o.join(",")}}async function d(t,o,s){const i=n(t),m=o.geometry?[o.geometry]:[],u=await e(m),c=o.toJSON();y(c);const l=u?.[0];null!=l&&(c.geometry=l.toJSON());const p=a({...i.query,f:"json",...c});return r(p,s)}async function S(e,o,i){const m=o.toJSON();null!=m.angleName&&(m.angleName=m.angleName.join(",")),o?.point?.spatialReference?.imageCoordinateSystem&&(m.point.spatialReference=G(o.point.spatialReference)),o?.spatialReference?.imageCoordinateSystem&&(m.spatialReference=$(o.spatialReference));const u=n(e),c=a({...u.query,f:"json",...m}),l=r(c,i),{data:p}=await t(`${u.path}/computeAngles`,l);return p.spatialReference=p.spatialReference?null!=p.spatialReference.geodataXform?new g({wkid:0,imageCoordinateSystem:p.spatialReference}):g.fromJSON(p.spatialReference):null,"NaN"===p.north&&(p.north=null),"NaN"===p.up&&(p.up=null),new s(p)}async function N(e,o,s){const i=o.toJSON(),{geometries:m}=o;if(m)for(let t=0;t<m.length;t++)m[t].spatialReference?.imageCoordinateSystem&&(i.geometries.geometries[t].spatialReference=G(m[t].spatialReference));const u=n(e),c=a({...u.query,f:"json",...i}),p=r(c,s),{data:f}=await t(`${u.path}/computePixelLocation`,p);return l.fromJSON(f)}async function R(e,o,a){const r=await d(e,o,a),s=n(e),{data:i}=await t(`${s.path}/computeStatisticsHistograms`,r),{statistics:m}=i;return m?.length&&m.forEach((t=>{t.avg=t.mean,t.stddev=t.standardDeviation})),{statistics:m,histograms:i.histograms}}async function j(e,o,a){const r=await d(e,o,a),s=n(e),{data:i}=await t(`${s.path}/computeHistograms`,r);return{histograms:i.histograms}}async function J(o,s,i){const m=s.toJSON();y(m),m.outFields?.length&&(m.outFields=m.outFields.join(","));const u=await e(s.geometry),c=u?.[0];null!=c&&(m.geometry=c.toJSON());const l=n(o),p=a({...l.query,f:"json",...m}),g=r(p,i),{data:d}=await t(`${l.path}/getSamples`,g),S=d?.samples?.map((t=>{const e="NaN"===t.value||""===t.value?null:t.value.split(" ").map((t=>Number(t)));return{...t,pixelValue:e}}));return f.fromJSON({samples:S})}async function O(o,s,i){const m=n(o),u=s.geometry?[s.geometry]:[];return e(u).then((e=>{const o=s.toJSON(),n=e?.[0];null!=n&&(o.geometry=JSON.stringify(n.toJSON()));const u=a({...m.query,f:"json",...o}),c=r(u,i);return t(m.path+"/identify",c)})).then((t=>c.fromJSON(t.data)))}async function h(t,e,o){const n=await q(t,e,[e.fromGeometry,e.toGeometry],o);return u.fromJSON(n)}async function w(t,e,o){const n=await q(t,e,[e.geometry],o);return i.fromJSON(n)}async function C(t,e,o){const n=await q(t,e,[e.geometry],o);return p.fromJSON(n)}async function I(t,e,o){const n=await q(t,e,[e.fromGeometry,e.toGeometry],o);return m.fromJSON(n)}async function q(o,s,i,m){const u=n(o),c=await e(i),l=s.toJSON();null!=c[0]&&(l.fromGeometry=JSON.stringify(v(c[0]))),null!=c[1]&&(l.toGeometry=JSON.stringify(v(c[1])));const p=a({...u.query,f:"json",...l}),f=r(p,m),{data:g}=await t(u.path+"/measure",f);return g}function v(t){const e=t.toJSON();return t.spatialReference?.imageCoordinateSystem&&(e.spatialReference=G(t.spatialReference)),e}function G(t){const{imageCoordinateSystem:e}=t;if(e){const{id:t,referenceServiceName:o}=e;return null!=t?o?{icsid:t,icsns:o}:{icsid:t}:{ics:e}}return t.toJSON()}function $(t,e){if(!t.imageCoordinateSystem)return o(t);const n=G(t),{icsid:a,icsns:r}=n;return null==a||null!=r&&!e?.toLowerCase().includes("/"+r.toLowerCase()+"/")?JSON.stringify(n):`0:${a}`}export{S as computeAngles,j as computeHistograms,N as computePixelSpaceLocations,R as computeStatisticsHistograms,G as getImageSpatialReferenceJSON,$ as getImageSpatialReferenceQueryParameter,J as getSamples,O as identify,w as measureAreaAndPerimeter,I as measureDistanceAndAngle,h as measureHeight,C as measurePointOrCentroid};
