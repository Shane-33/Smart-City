/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import s from"../../request.js";import"../../core/has.js";import{strict as t}from"../../core/jsonMap.js";import{JSONSupport as o}from"../../core/JSONSupport.js";import{onAbort as r,createAbortError as i}from"../../core/promiseUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import{enumeration as c}from"../../core/accessorSupport/decorators/enumeration.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{parseUrl as u}from"../utils.js";import l from"../geoprocessor/GPOptions.js";import{gpEncode as p,decode as b}from"../geoprocessor/utils.js";import j from"./GPMessage.js";var m;const h=t()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1});let d=m=class extends o{constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.progress=null,this.requestOptions=null,this.sourceUrl=null,this._timer=void 0}async cancelJob(e){const{jobId:t,sourceUrl:o}=this,{path:r}=u(o),i={...this.requestOptions,...e,query:{f:"json"}};this._clearTimer();const a=`${r}/jobs/${t}/cancel`,{data:c}=await s(a,i),{messages:n,jobStatus:l,progress:p}=m.fromJSON(c);return this.set({messages:n,jobStatus:l,progress:p}),this}destroy(){clearInterval(this._timer)}async checkJobStatus(e){const{path:t}=u(this.sourceUrl),o={...this.requestOptions,...e,query:{f:"json"}},r=`${t}/jobs/${this.jobId}`,{data:i}=await s(r,o),{messages:a,jobStatus:c,progress:n}=m.fromJSON(i);return this.set({messages:a,jobStatus:c,progress:n}),this}async fetchResultData(e,t,o){t=l.from(t||{});const{returnFeatureCollection:r,returnM:i,returnZ:a,outSpatialReference:c}=t,{path:n}=u(this.sourceUrl),j=p({returnFeatureCollection:r,returnM:i,returnZ:a,outSR:c,returnType:"data",f:"json"},null),m={...this.requestOptions,...o,query:j},h=`${n}/jobs/${this.jobId}/results/${e}`,{data:d}=await s(h,m);return b(d)}async fetchResultImage(e,t,o){const{path:r}=u(this.sourceUrl),i={...t.toJSON(),f:"json"},a=p(i),c={...this.requestOptions,...o,query:a},n=`${r}/jobs/${this.jobId}/results/${e}`,{data:l}=await s(n,c);return b(l)}async fetchResultMapImageLayer(){const{path:e}=u(this.sourceUrl),s=e.indexOf("/GPServer/"),t=`${e.substring(0,s)}/MapServer/jobs/${this.jobId}`;return new(0,(await import("../../layers/MapImageLayer.js")).default)({url:t})}async waitForJobCompletion(e={}){const{interval:s=1e3,signal:t,statusCallback:o}=e;return new Promise(((e,a)=>{r(t,(()=>{this._clearTimer(),a(i())})),this._clearTimer();const c=setInterval((()=>{this._timer||a(i()),this.checkJobStatus(this.requestOptions).then((s=>{const{jobStatus:t}=s;switch(this.jobStatus=t,t){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":o&&o(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),a(this)}}))}),s);this._timer=c}))}_clearTimer(){clearInterval(this._timer),this._timer=void 0}};e([a()],d.prototype,"jobId",void 0),e([c(h,{ignoreUnknown:!1})],d.prototype,"jobStatus",void 0),e([a({type:[j]})],d.prototype,"messages",void 0),e([a()],d.prototype,"progress",void 0),e([a()],d.prototype,"requestOptions",void 0),e([a({json:{write:!0}})],d.prototype,"sourceUrl",void 0),d=m=e([n("esri.rest.support.JobInfo")],d);const g=d;export{g as default};
