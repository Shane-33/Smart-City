/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../Dictionary.js";import{ArcadeExecutionError as t,ExecutionErrorCodes as n}from"../executionError.js";import r from"../Feature.js";import a from"../ImmutablePathArray.js";import i from"../ImmutablePointArray.js";import{E as o,o as s,q as l,A as c,Q as f,F as u,x as m,c as h,j as p,k as w,b as d,n as y,m as g,a as I,i as R,f as v,L as P,r as b,C as F,J as x}from"../../chunks/languageUtils.js";import{angle2D as O,angleBetween2D as j,bearing2D as S,bearingBetween2D as k,pathsSelfIntersecting as N}from"./centroid.js";import J from"../../geometry/Extent.js";import D from"../../geometry/Geometry.js";import z from"../../geometry/Multipoint.js";import G from"../../geometry/Point.js";import Z from"../../geometry/Polygon.js";import C from"../../geometry/Polyline.js";import{isClockwise as _}from"../../geometry/support/coordsUtils.js";import{fromJSON as M}from"../../geometry/support/jsonUtils.js";function A(e){return e&&"esri.arcade.Feature"===e.arcadeDeclaredClass}function W(a,W){a.ringisclockwise=function(e,r){return W(e,r,((a,c,f)=>{o(f,1,1,e,r);let u=[];if(null===f[0])return!1;if(s(f[0]))for(const i of f[0]){if(!(i instanceof G))throw new t(e,n.InvalidParameter,r);u.push(i.hasZ?i.hasM?[i.x,i.y,i.z,i.m]:[i.x,i.y,i.z]:[i.x,i.y])}else if(f[0]instanceof i)u=f[0]._elements;else{if(!l(f[0]))throw new t(e,n.InvalidParameter,r);for(const a of f[0].toArray()){if(!(a instanceof G))throw new t(e,n.InvalidParameter,r);u.push(a.hasZ?a.hasM?[a.x,a.y,a.z,a.m]:[a.x,a.y,a.z]:[a.x,a.y])}}return!(u.length<3)&&_(u)}))},a.polygon=function(a,i){return W(a,i,((s,l,u)=>{o(u,1,1,a,i);let m=null;if(u[0]instanceof e){if(m=c(r.parseGeometryFromDictionary(u[0]),a.spatialReference),m instanceof Z==!1)throw new t(a,n.InvalidParameter,i)}else m=u[0]instanceof Z?M(u[0].toJSON()):c(new Z(JSON.parse(u[0])),a.spatialReference);if(null!==m&&!1===m.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(m)}))},a.polyline=function(a,i){return W(a,i,((s,l,u)=>{o(u,1,1,a,i);let m=null;if(u[0]instanceof e){if(m=c(r.parseGeometryFromDictionary(u[0]),a.spatialReference),m instanceof C==!1)throw new t(a,n.InvalidParameter,i)}else m=u[0]instanceof C?M(u[0].toJSON()):c(new C(JSON.parse(u[0])),a.spatialReference);if(null!==m&&!1===m.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(m)}))},a.point=function(a,i){return W(a,i,((s,l,u)=>{o(u,1,1,a,i);let m=null;if(u[0]instanceof e){if(m=c(r.parseGeometryFromDictionary(u[0]),a.spatialReference),m instanceof G==!1)throw new t(a,n.InvalidParameter,i)}else m=u[0]instanceof G?M(u[0].toJSON()):c(new G(JSON.parse(u[0])),a.spatialReference);if(null!==m&&!1===m.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(m)}))},a.multipoint=function(a,i){return W(a,i,((s,l,u)=>{o(u,1,1,a,i);let m=null;if(u[0]instanceof e){if(m=c(r.parseGeometryFromDictionary(u[0]),a.spatialReference),m instanceof z==!1)throw new t(a,n.InvalidParameter,i)}else m=u[0]instanceof z?M(u[0].toJSON()):c(new z(JSON.parse(u[0])),a.spatialReference);if(null!==m&&!1===m.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(m)}))},a.extent=function(a,i){return W(a,i,((s,l,m)=>{m=u(m),o(m,1,1,a,i);let h=null;if(m[0]instanceof e)h=c(r.parseGeometryFromDictionary(m[0]),a.spatialReference);else if(m[0]instanceof G){const e={xmin:m[0].x,ymin:m[0].y,xmax:m[0].x,ymax:m[0].y,spatialReference:m[0].spatialReference.toJSON()},t=m[0];t.hasZ?(e.zmin=t.z,e.zmax=t.z):t.hasM&&(e.mmin=t.m,e.mmax=t.m),h=M(e)}else h=m[0]instanceof Z||m[0]instanceof C||m[0]instanceof z?M(m[0].extent?.toJSON()):m[0]instanceof J?M(m[0].toJSON()):c(new J(JSON.parse(m[0])),a.spatialReference);if(null!==h&&!1===h.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(h)}))},a.geometry=function(a,i){return W(a,i,((s,l,u)=>{o(u,1,1,a,i);let m=null;if(null===u[0])return null;if(m=A(u[0])?c(u[0].geometry(),a.spatialReference):u[0]instanceof e?c(r.parseGeometryFromDictionary(u[0]),a.spatialReference):c(M(JSON.parse(u[0])),a.spatialReference),null!==m&&!1===m.spatialReference.equals(a.spatialReference))throw new t(a,n.WrongSpatialReference,i);return f(m)}))},a.setgeometry=function(e,r){return W(e,r,((a,i,s)=>{if(o(s,2,2,e,r),!A(s[0]))throw new t(e,n.InvalidParameter,r);if(!0===s[0].immutable)throw new t(e,n.Immutable,r);if(!(s[1]instanceof D||null===s[1]))throw new t(e,n.InvalidParameter,r);return s[0]._geometry=s[1],m}))},a.feature=function(a,i){return W(a,i,((o,s,l)=>{if(0===l.length)throw new t(a,n.WrongNumberOfParameters,i);let f=null;if(1===l.length)if(h(l[0]))f=r.fromJson(JSON.parse(l[0]),a.timeZone);else if(A(l[0]))f=r.createFromArcadeFeature(l[0]);else if(l[0]instanceof D)f=r.createFromGraphicLikeObject(l[0],null,null,a.timeZone);else{if(!(l[0]instanceof e))throw new t(a,n.InvalidParameter,i);{let t=l[0].hasField("geometry")?l[0].field("geometry"):null,n=l[0].hasField("attributes")?l[0].field("attributes"):null;null!==t&&t instanceof e&&(t=r.parseGeometryFromDictionary(t)),null!==n&&(n=r.parseAttributesFromDictionary(n)),f=r.createFromGraphicLikeObject(t,n,null,a.timeZone)}}else if(2===l.length){let o=null,s=null;if(null!==l[0])if(l[0]instanceof D)o=l[0];else{if(!(o instanceof e))throw new t(a,n.InvalidParameter,i);o=r.parseGeometryFromDictionary(l[0])}if(null!==l[1]){if(!(l[1]instanceof e))throw new t(a,n.InvalidParameter,i);s=r.parseAttributesFromDictionary(l[1])}f=r.createFromGraphicLikeObject(o,s,null,a.timeZone)}else{let o=null;const s={};if(null!==l[0])if(l[0]instanceof D)o=l[0];else{if(!(o instanceof e))throw new t(a,n.InvalidParameter,i);o=r.parseGeometryFromDictionary(l[0])}for(let e=1;e<l.length;e+=2){const r=p(l[e]),o=l[e+1];if(!(null==o||h(o)||isNaN(o)||w(o)||d(o)||y(o)||g(o)||I(o)))throw new t(a,n.InvalidParameter,i);if(R(o)||!1===v(o))throw new t(a,n.InvalidParameter,i);s[r]=o===m?null:o}f=r.createFromGraphicLikeObject(o,s,null,a.timeZone)}return f._geometry=c(f.geometry(),a.spatialReference),f.immutable=!1,f}))},a.dictionary=function(r,a){return W(r,a,((i,o,c)=>{if(0===c.length||1===c.length&&null===c[0]){const t=new e;return t.immutable=!1,t}if(1===c.length&&h(c[0]))try{const t=JSON.parse(c[0]),n=e.convertObjectToArcadeDictionary(t,P(r),!1);return n.immutable=!1,n}catch(v){throw new t(r,n.InvalidParameter,a)}if(1===c.length&&c[0]instanceof D)try{const t=c[0].toJSON();t.hasZ=!0===c[0].hasZ,t.hasM=!0===c[0].hasM;const n=e.convertObjectToArcadeDictionary(t,P(r),!1);return n.immutable=!1,n}catch(v){throw new t(r,n.InvalidParameter,a)}if(1===c.length&&b(c[0]))try{const t=new e;t.immutable=!1,t.setField("geometry",c[0].geometry());const n=new e;n.immutable=!1,t.setField("attributes",n);for(const e of c[0].keys())n.setField(e,c[0].field(e));return t}catch(v){throw new t(r,n.InvalidParameter,a)}if(1===c.length&&c[0]instanceof e)try{const t=new e;t.immutable=!1;for(const e of c[0].keys())t.setField(e,c[0].field(e));return t}catch(v){throw new t(r,n.InvalidParameter,a)}if(2===c.length&&c[0]instanceof e&&I(c[1]))try{if(!(!0===c[1])){const t=new e;t.immutable=!1;for(const e of c[0].keys())t.setField(e,c[0].field(e));return t}return c[0].deepClone()}catch(v){throw new t(r,n.InvalidParameter,a)}if(c.length%2!=0)throw new t(r,n.WrongNumberOfParameters,a);const f={};for(let e=0;e<c.length;e+=2){const i=p(c[e]),o=c[e+1];if(!(null==o||h(o)||isNaN(o)||w(o)||d(o)||I(o)||g(o)||y(o)||s(o)||l(o)))throw new t(r,n.InvalidParameter,a);if(R(o))throw new t(r,n.InvalidParameter,a);f[i]=o===m?null:o}const u=new e(f);return u.immutable=!1,u}))},a.haskey=function(r,a){return W(r,a,((i,s,l)=>{o(l,2,2,r,a);const c=p(l[1]);if(A(l[0]))return l[0].hasField(c);if(l[0]instanceof e)return l[0].hasField(c);if(l[0]instanceof D){const e=L(l[0],c,null,null,2);return!e||"notfound"!==e.keystate}throw new t(r,n.InvalidParameter,a)}))},a.hasvalue=function(t,n){return W(t,n,((r,a,i)=>{if(o(i,2,2,t,n),null===i[0]||null===i[1])return!1;const s=p(i[1]);if(b(i[0]))return!!i[0].hasField(s)&&null!==i[0].field(s);if(i[0]instanceof e)return!!i[0].hasField(s)&&null!==i[0].field(s);if(i[0]instanceof D){return null!==L(i[0],s,null,null,0)}return!1}))},a.indexof=function(e,r){return W(e,r,((a,i,c)=>{o(c,2,2,e,r);const f=c[1];if(s(c[0])){for(let e=0;e<c[0].length;e++)if(F(f,c[0][e]))return e;return-1}if(l(c[0])){const e=c[0].length();for(let t=0;t<e;t++)if(F(f,c[0].get(t)))return t;return-1}throw new t(e,n.InvalidParameter,r)}))},a.angle=function(e,r){return W(e,r,((a,i,s)=>{if(s=u(s),o(s,2,3,e,r),!(s[0]instanceof G))throw new t(e,n.InvalidParameter,r);if(!(s[1]instanceof G))throw new t(e,n.InvalidParameter,r);if(s.length>2&&!(s[2]instanceof G))throw new t(e,n.InvalidParameter,r);return 2===s.length?O(s[0],s[1]):j(s[0],s[1],s[2])}))},a.bearing=function(e,r){return W(e,r,((a,i,s)=>{if(s=u(s),o(s,2,3,e,r),!(s[0]instanceof G))throw new t(e,n.InvalidParameter,r);if(!(s[1]instanceof G))throw new t(e,n.InvalidParameter,r);if(s.length>2&&!(s[2]instanceof G))throw new t(e,n.InvalidParameter,r);return 2===s.length?S(s[0],s[1]):k(s[0],s[1],s[2])}))},a.isselfintersecting=function(e,t){return W(e,t,((n,r,a)=>{a=u(a),o(a,1,1,e,t);let i=a[0];if(i instanceof Z)return i.isSelfIntersecting;if(i instanceof C)return i=i.paths,N(i);if(i instanceof z){const e=i.points;for(let t=0;t<e.length;t++)for(let n=0;n<e.length;n++)if(n!==t){let r=!0;for(let a=0;a<e[t].length;a++)if(e[t][a]!==e[n][a]){r=!1;break}if(!0===r)return!0}}return!(!s(i)&&!l(i))&&(i=x(i,e.spatialReference),null!==i&&(i=i.paths),N(i))}))}}let q=0;function L(r,o,s,l,c=1){let f;switch(o=o.toLowerCase()){case"hasz":{const e=r.hasZ;return void 0!==e&&e}case"hasm":{const e=r.hasM;return void 0!==e&&e}case"spatialreference":{let t=r.spatialReference._arcadeCacheId;if(void 0===t){let e=!0;Object.freeze&&Object.isFrozen(r.spatialReference)&&(e=!1),e&&(q++,r.spatialReference._arcadeCacheId=q,t=q)}const n=new e({wkt:r.spatialReference.wkt,wkid:r.spatialReference.wkid});return void 0!==t&&(n._arcadeCacheId="SPREF"+t.toString()),n}}switch(r.type){case"extent":switch(o){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const e=r[o];return void 0!==e?e:null}case"type":return"Extent"}break;case"polygon":switch(o){case"rings":f=r.cache._arcadeCacheId,void 0===f&&(q++,f=q,r.cache._arcadeCacheId=f);return new a(r.rings,r.spatialReference,!0===r.hasZ,!0===r.hasM,f);case"type":return"Polygon"}break;case"point":switch(o){case"x":case"y":case"z":case"m":return void 0!==r[o]?r[o]:null;case"type":return"Point"}break;case"polyline":switch(o){case"paths":f=r.cache._arcadeCacheId,void 0===f&&(q++,f=q,r.cache._arcadeCacheId=f);return new a(r.paths,r.spatialReference,!0===r.hasZ,!0===r.hasM,f);case"type":return"Polyline"}break;case"multipoint":switch(o){case"points":f=r.cache._arcadeCacheId,void 0===f&&(q++,f=q,r.cache._arcadeCacheId=f);return new i(r.points,r.spatialReference,!0===r.hasZ,!0===r.hasM,f,1);case"type":return"Multipoint"}}if(1===c)throw new t(s,n.InvalidIdentifier,l);return 2===c?{keystate:"notfound"}:null}export{L as geometryMember,W as registerFunctions};
