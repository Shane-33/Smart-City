/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import i from"../../renderers/support/AuthoringInfo.js";import o from"../../renderers/support/ClassBreakInfo.js";import a from"../../renderers/visualVariables/support/SizeStop.js";import{getSize as s}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{createVisualVariable as n}from"./color.js";import{createVisualVariables as l,createContinuousRenderer as t}from"./size.js";import{verifyBasicFieldValidity as r,createStopValuesForAboveBelow as u,clampAboveAndBelowStopValues as p,createDefaultStopValues as m}from"./support/utils.js";import{verifyBinningParams as c}from"../support/binningUtils.js";import{isAnyDateField as d,getFieldsList as v}from"../support/utils.js";import{binningCapableLayerTypes as f,featureCapableLayerTypes as b,createLayerAdapter as y,getLayerTypeLabels as w}from"../support/adapters/support/layerUtils.js";import{getAboveAndBelowSymbols as h}from"../symbology/support/aboveAndBelowUtils.js";import{applyCIMSymbolColor as z}from"../../symbols/support/cimSymbolUtils.js";import{Symbol3DMaterial as g}from"../../symbols/support/Symbol3DMaterial.js";const V=2**53-1;async function O(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===i.theme&&i.sizeOptions?.sizeOptimizationEnabled)throw new e("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");i.forBinning&&c(i,"univariate-colorsize-visual-variables");const o={...i,layer:i.layer},a=i.forBinning?f:b,s=y(o.layer,a,i.forBinning);if(!s)throw new e("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+w(a).join(", "));if(o.layer=s,o.theme=o.theme||o.colorOptions?.theme?o.theme:"high-to-low","90-10"===o.theme)throw new e("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");const n=null!=o.signal?{signal:o.signal}:null;await s.load(n);const l=await v({field:o.field,normalizationField:o.normalizationField,valueExpression:o.valueExpression}),t=r(s,l,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return o}function x(e,i){const o={...e},{sizeOptions:a,theme:s}=o,n=o.legendOptions||o.sizeOptions?.legendOptions;return delete o.sizeOptions,delete o.colorOptions,{...o,...a,statistics:i||o.statistics,theme:"above-and-below"===s?null:s,legendOptions:n}}function E(e,i){const o={...e},a=o.colorOptions,s=o.theme||a?.theme,n=o.legendOptions||o.colorOptions?.legendOptions;return delete o.sizeOptions,delete o.colorOptions,{...o,...a,statistics:i||o.statistics,theme:s,legendOptions:n}}async function S(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");i.forBinning&&c(i,"univariate-colorsize-continuous-renderer");const o={...i,layer:i.layer};o.symbolType=o.symbolType||"2d",o.colorOptions||(o.colorOptions={}),o.colorOptions.isContinuous=o.colorOptions.isContinuous??!1;const a=i.forBinning?f:b,s=y(o.layer,a,i.forBinning);if(!s)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+w(a).join(", "));o.layer=s;const n=null!=o.signal?{signal:o.signal}:null;if(await s.load(n),"above-and-below"===o.theme&&o.symbolOptions){if(o.symbolType.includes("3d-volumetric"))throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==s.geometryType&&"polygon"!==s.geometryType)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const l=await v({field:o.field,normalizationField:o.normalizationField,valueExpression:o.valueExpression}),t=r(s,l,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return o}function j(e){const i={...e},o={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete o.sizeOptimizationEnabled,{...i,...o}}function I(e,i){if("type"in e&&"cim"===e.type)z(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&null!=e.material&&"color"in e.material&&(e.material?e.material.color=i:e.material=new g({color:i}))}))}else"color"in e&&(e.color=i)}function T(e,i,o){if((i?.symbolStyle||i?.symbols)&&("point"===o||"polygon"===o))return i.symbols||h(i.symbolStyle);const a=e.classBreakInfos[0].symbol;return{above:a.clone(),below:a.clone()}}function q(e,i,a){const s=a.symbolOptions,n=a.layer,l=s?.symbols?"custom":s?.symbolStyle,t=a.colorOptions?.isContinuous;if(B(e,i,t),l||!t){const a=i.size.visualVariables[0].stops,{above:r,below:u}=T(e,s,n.geometryType);if(!t){const e=i.color.colorScheme.colors,o=e[0];I(r,e[e.length-1]),I(u,o)}e.classBreakInfos=[new o({minValue:-V,maxValue:a[2].value,symbol:u}),new o({minValue:a[2].value,maxValue:V,symbol:r})],l&&e.authoringInfo&&(e.authoringInfo.univariateSymbolStyle=l)}}function B(e,i,o=!0){const a=i?.authoringInfo?.clone(),s=i.size.visualVariables.map((e=>e.clone()));o?s.push(i.color.visualVariable.clone()):a.visualVariables=a.visualVariables?.filter((e=>"size"===e.type)),s.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=a,e.visualVariables=s}function D(e){const i={...e},o=i.symbolType,a=!!o?.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const s=i;return s.worldScale=a,a&&(s.sizeOptions={...s.sizeOptions},s.sizeOptions.axis="3d-volumetric-uniform"===o?"all":"height"),s}async function U(e,i,o,n){const l=i[0],t=i[1],r=Math.round((t-l)/2)+l,u=e.clone();u.stops=[new a({value:o[0],size:t}),new a({value:o[1],size:r}),new a({value:o[2],size:l}),new a({value:o[3],size:r}),new a({value:o[4],size:t})],e.stops=[new a({value:n[0],size:s(u,n[0])}),new a({value:n[1],size:s(u,n[1])}),new a({value:n[2],size:s(u,n[2])}),new a({value:n[3],size:s(u,n[3])}),new a({value:n[4],size:s(u,n[4])})]}async function C(e,i,o,a,s){const n=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),l="number"==typeof n?.minSize?n?.minSize:null,t="number"==typeof n?.maxSize?n?.maxSize:null;if(null!=n?.minDataValue&&null!=l&&null!=t)if(a)if("above-and-below"===a){n.minDataValue=null,n.maxDataValue=null,n.minSize=null,n.maxSize=null;const e=u(o,s),a=p(e,o);await U(n,[l,t],e,a),i.stops.forEach(((e,i)=>e.value=a[i]))}else{const{minDataValue:e,maxDataValue:o}=n,a=m(e,o,5);i.stops.forEach(((e,i)=>e.value=a[i])),n.minDataValue=a[0],n.maxDataValue=a[a.length-1]}else n.minDataValue=i.stops[0].value,n.maxDataValue=i.stops[i.stops.length-1].value}function F(e,o,a){const{theme:s,minValue:n,maxValue:l}=e,t=o.authoringInfo.visualVariables[0].clone(),r=a.authoringInfo.visualVariables[0].clone();if("above-and-below"===s){const e=o.visualVariable.stops;t.minSliderValue=r.minSliderValue=n??e[0].value,t.maxSliderValue=r.maxSliderValue=l??e[e.length-1].value,r.theme="above-and-below"}return new i({type:"univariate-color-size",univariateTheme:s,visualVariables:[t,r]})}async function k(e){const i=await O(e),o=await n(E(i)),{visualVariable:a,statistics:s}=o,t=await l(x(i,s)),r=t.visualVariables,u=e.layer,p=e.field?u.getField(e.field):null;return await C(r,a,s,i.theme,d(p)),{basemapId:t.basemapId,basemapTheme:t.basemapTheme,statistics:s,defaultValuesUsed:o.defaultValuesUsed,color:{visualVariable:a,colorScheme:o.colorScheme},size:{visualVariables:r,sizeScheme:t.sizeScheme},authoringInfo:F(i,o,t)}}async function A(e){return M(e)}async function M(e){const i=await S(e),{renderer:o,statistics:a,defaultValuesUsed:s}=await t(j(i)),n=D(i);n.statistics=a;const l=await k(n);return"above-and-below"===i.theme?q(o,l,i):B(o,l),{renderer:o,statistics:a,defaultValuesUsed:s,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?l.color:null,size:l.size,basemapId:l.basemapId,basemapTheme:l.basemapTheme}}export{A as createContinuousRenderer,M as createRenderer,k as createVisualVariables};
