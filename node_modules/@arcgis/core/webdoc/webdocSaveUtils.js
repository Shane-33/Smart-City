/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{MultiOriginJSONSupport as t}from"../core/MultiOriginJSONSupport.js";import{whenOnce as r}from"../core/reactiveUtils.js";import{urlToObject as o,hasSameCanonicalPortal as a}from"../core/urlUtils.js";import{updateOrigins as i}from"../core/accessorSupport/originUtils.js";import n from"../geometry/SpatialReference.js";import{equals as s}from"../geometry/support/spatialReferenceUtils.js";import{webMercatorToGeographic as l}from"../geometry/support/webMercatorUtils.js";import{isServerOrServicesAGOLUrl as p}from"../layers/support/arcgisLayerUrl.js";import{isLayerWithFeatureLayerSource as c,isFeatureCollectionLayer as u}from"../layers/support/layerUtils.js";import m from"../portal/Portal.js";import d from"../portal/PortalItem.js";import{TypeKeyword as f,removeTypeKeyword as w,addTypeKeyword as y,hasTypeKeyword as g}from"../portal/support/portalItemUtils.js";import{project as h}from"../rest/geometryService/project.js";import b from"../rest/support/ProjectParameters.js";import{hasDeveloperBasemapLayer as _,findSpatialReference as v,isDeveloperBasemapLayer as R}from"../support/basemapUtils.js";import{validateSaveAPIKey as U}from"./saveAPIKeyUtils.js";import{beforeSave as P,saveResources as W}from"./support/saveUtils.js";const I=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function j(e,t,a){a??={},S(e,t),await r((()=>!t.updatingFromView)),await t.load(),await k(t),await P(t),await T(e,t);const i=t.portalItem,n=o(i.itemUrl),s={origin:"web-map",messages:[],writtenProperties:[],url:n,portal:i.portal||m.getDefault(),portalItem:i,verifyItemRelativeUrls:n?{rootPath:n.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=t.write({},s);return await Promise.all(s.resources.pendingOperations),D(e,s,a),await E(t,i),await ue(e,t,i,l,s),await Promise.all([t.updateItemThumbnail(),W(t.resourceReferences,s,null)]),i}async function A(e,t,o,a){a??={};const i=M(e,o);await r((()=>!t.updatingFromView)),await t.load(),await k(t),await P(t),await T(e,t);const n={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:i.portal,portalItem:i,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},s=t.write({},n);await Promise.all(n.resources.pendingOperations),D(e,n,a),await z(t,i);const l=t.getThumbnailState();return await me(e,t,i,s,n,a)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(l),await Promise.all([t.updateItemThumbnail(),W(t.resourceReferences,n,null)]),i}function S(t,r){if(!r.portalItem)throw new e(`${t.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");U(r.portalItem),O(t,r.portalItem)}function O(t,r){if(r.type!==t.itemType)throw new e(`${t.name}:portal-item-wrong-type`,`Portal item needs to have type "${t.itemType}"`)}async function T(t,o){if(!o.basemap?.baseLayers.length)throw new e(`${t.name}:save`,"Map does not have a valid basemap with a base layer.");let a=null;if(await r((()=>{const e=v(o.initialViewProperties,o.basemap);return a=e.spatialReference,!e.updating})),!s(a,o.initialViewProperties.spatialReference))throw new e(`${t.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:o.initialViewProperties.spatialReference,actual:a})}function M(e,t){let r=d.from(t);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=e.itemType),r.portal||(r.portal=m.getDefault()),U(r),O(e,r),r}function k(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}function D(t,r,o){let a=(r.messages??[]).filter((e=>"error"===e.type)).map((t=>new e(t.name,t.message,t.details)));if(r.blockedRelativeUrls&&(a=a.concat(r.blockedRelativeUrls.map((t=>new e("url:unsupported",`Relative url '${t}' is not supported in Web Map`))))),o.ignoreUnsupported&&(a=a.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name))),a.length>0)throw new e(`${t.name}:save`,"Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a})}async function E(e,t){t.extent=await ne(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await Q(e,t)}const V=f.JSAPI,C="CollectorDisabled",G="Collector",L="Data Editing",$="OfflineDisabled",B="Offline",K="Workforce Project",x="Workforce Worker",F="Workforce Dispatcher",N="Offline Map Areas",H="FieldMapsDisabled",J=f.DEVELOPER_BASEMAP,q="UtilityNetwork";async function z(e,t){w(t,C),w(t,H),w(t,f.METADATA),w(t,$),w(t,N),w(t,F),w(t,K),w(t,x),await E(e,t)}async function Q(e,t){y(t,V),await X(e),te(e,t),re(e,t),oe(e,t),ae(e,t),ie(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function X(e){const t=Y(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}function Y(e){return e.allLayers.concat(e.allTables)}function Z(e){return Y(e).some((e=>e.loaded&&c(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function ee(e){return Y(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&pe(e,t)))}function te(e,t){g(t,C)||g(t,K)||g(t,x)||g(t,F)||!Z(e)?w(t,G):y(t,G)}function re(e,t){Z(e)?y(t,L):w(t,L)}function oe(e,t){!g(t,$)&&ee(e)?y(t,B):w(t,B)}function ae(e,t){_(e.basemap)?y(t,J):w(t,J)}function ie(e,t){e.utilityNetworks?.length?y(t,q):w(t,q)}async function ne(e,t){const r=t.clone().normalize();let o;if(r.length>1)for(const a of r)o?a.width>o.width&&(o=a):o=a;else o=r[0];return se(e,o)}async function se(e,t){const r=t.spatialReference;if(r.isWGS84)return t.clone();if(r.isWebMercator)return l(t);const{getGeometryServiceURL:o}=await import("../portal/support/geometryServiceUtils.js"),a=await o(e),i=new b;i.geometries=[t],i.outSpatialReference=n.WGS84;return(await h(a,i))[0]}function le(e){return u(e)||"map-notes"===e.type||"route"===e.type}function pe(e,t){return c(t)&&t.capabilities.operations.supportsSync||le(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||ce(t)||R(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function ce(e){return"tile"===e.type&&(p(e.url)&&I.some((t=>e.url?.toLowerCase().includes("/"+t+"/"))))}async function ue(e,t,r,o,a){await r.update({data:o}),we(e,t,r,o,a)}async function me(t,r,o,a,i,n){const s=r.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=o.portal;await p.signIn();const{copyAllowed:c,itemReloaded:u}=await de(l,p);if(l.authenticated||=u,!c)throw new e(`${t.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const m=await fe(o,l,a,n);return r.portalItem=o,we(t,r,o,a,i),m}async function de(e,t){const{item:r,authenticated:o}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function fe(e,t,r,o){const i=e.portal,{item:n}=t,{folder:s,copyAllResources:l}=o;let p=!1;if(l&&n?.id&&a(n.portal.url,i.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();p=!!e}if(p){const t=await n.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const o=e.toJSON();await e.load(),e.read(o),await e.update({data:r})}else await(i.user?.addItem({item:e,folder:s,data:r}));return p}function we(e,r,a,n,s){t.prototype.read.call(r,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:a.itemUrl?o(a.itemUrl):void 0}),i(s),r.resourceInfo=n}export{j as save,A as saveAs};
