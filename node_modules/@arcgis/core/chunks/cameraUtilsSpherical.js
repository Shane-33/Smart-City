/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{Cyclical as t,cyclical2PI as e}from"../core/Cyclical.js";import{deg2rad as o,rad2deg as a,asinClamped as n}from"../core/mathUtils.js";import{c as i,k as s}from"./mat4.js";import{a as r}from"./mat4f64.js";import{n as c,b as l,j as m,e as f,E as p,l as h,i as u}from"./vec3.js";import{f as y,c as M}from"./vec3f64.js";import{getReferenceEllipsoid as d}from"../geometry/ellipsoidUtils.js";import j from"../geometry/Extent.js";import g from"../geometry/SpatialReference.js";import{geographicToWebMercator as T}from"../geometry/support/webMercatorUtils.js";import{createDirectionUp as b,directionToHeadingTilt as x}from"../views/3d/support/cameraUtilsInternal.js";import{getLonDeltaForDistance as R}from"../views/3d/support/earthUtils.js";const I=y(0,0,1),P=c(M(),y(1,1,1)),U=new t(-180,180),v=r(),w=M(),q=M();function E(t,e,a,n=b()){l(w,t,I),0===m(w,w)&&l(w,t,P),i(v,-o(e),t),s(v,v,-o(a),w);const{up:r,direction:h}=n;return l(r,w,t),c(r,r),f(r,r,v),c(h,t),p(h,h),f(h,h,v),n}function S(t,e,o,a){const n=w,i=q;return c(n,t),l(q,n,I),0===m(q,q)&&l(q,n,P),l(i,q,n),x(e,o,a,n,i)}function _(t,e,a,i){const s={eye:M(),up:null,tilt:i,heading:a},r=w;r[0]=t[0],r[1]=t[2],r[2]=-t[1];const c=e,l=o(a),m=o(i),f=Math.sin(l),p=Math.cos(l),y=Math.sin(m),d=Math.cos(m),j=h(r);let g;if(Math.abs(m)<1e-8)g=c+j;else{const t=j/y,e=n(c/t),o=Math.PI-m-e;g=t*Math.sin(o)}const T=d*c,b=c*c*(y*y),x=p*p*b,R=g-T,I=R*R,P=x*(x+I-r[1]*r[1]);if(P<0)return u(s.eye,r,g/j),s.tilt=0,H(s,t);const U=Math.sqrt(P),v=r[1]*R,q=x+I;let E;if(E=p>0?-U+v:U+v,Math.abs(q)<1e-8)return j<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=c):u(s.eye,r,g/j),s.tilt=0,k(s.eye),H(s,t);s.eye[1]=E/q;const S=f*f*b,_=y*c,W=p*_*s.eye[1],z=s.eye[1]*s.eye[1],A=1-z,C=Math.sqrt(A),G=x*z+S-2*W*C*R+A*I;return Math.abs(G)<1e-8?(u(s.eye,r,g/j),s.tilt=0,k(s.eye),H(s,t)):(s.eye[0]=(A*(g*r[0]-T*r[0])-_*C*(r[0]*s.eye[1]*p+r[2]*f))/G,s.eye[2]=(A*(g*r[2]-T*r[2])-_*C*(r[2]*s.eye[1]*p-r[0]*f))/G,u(s.eye,s.eye,g),k(s.eye),H(s,t))}function k(t){const e=t[1];t[1]=-t[2],t[2]=e}function H(t,e){const o=E(e,t.heading,t.tilt);return t.up=o.up,t}function W(t,e,o){const i=h(e),s=Math.sqrt(o*o+i*i-2*o*i*Math.cos(Math.PI-t)),r=n(o/(s/Math.sin(t)));return a(t-r)}function z(t,e,a){const i=o(t),s=h(e);return n(a/(s/Math.sin(i)))+i}function A(t,n,i,s,r){let c,l,m,f;const p=n.latitude,h=d(t.spatialReference).radius,u=n.longitude,y=R(p,i,h)/2;c=u-y,l=u+y;const M=o(p),b=(1+Math.sin(M))/(1-Math.sin(M)),x=(b+1)*Math.tan(s/h/2),I=x*x;function P(t){const o=Math.PI/2;return(t=e.normalize(t,-o))>o&&(t=Math.PI-t),t}if(m=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*b+I))),f=m+s/h,m=P(m),f=P(f),f<m){const t=f;f=m,m=t}if(m=Math.max(a(m),-90),f=Math.min(a(f),90),l=U.monotonic(c,l),l-c>180){const t=(l-c-180)/2;c+=t,l-=t}const v=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:g.WGS84;return r?(r.xmin=c,r.ymin=m,r.xmax=l,r.ymax=f,r.spatialReference=v):r=new j(c,m,l,f,v),t.spatialReference&&t.spatialReference.isWebMercator&&T(r,!1,r),r}const C=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:S,eyeForCenterWithHeadingTilt:_,eyeTiltToLookAtTilt:z,headingTiltToDirectionUp:E,lookAtTiltToEyeTilt:W,toExtent:A},Symbol.toStringTag,{value:"Module"}));export{z as a,C as c,S as d,_ as e,E as h,W as l,A as t};
