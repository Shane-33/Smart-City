/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Error.js";import r from"../core/Loadable.js";import s from"../core/Logger.js";import{EsriPromiseMixin as o}from"../core/Promise.js";import{whenOrAbort as n}from"../core/promiseUtils.js";import{watch as i}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/accessorSupport/ensureType.js";import"../core/arrayUtils.js";import"../core/has.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{c as p}from"../chunks/vec3f64.js";import m from"./Extent.js";import l from"./Geometry.js";import h from"./Point.js";import u from"./Polygon.js";import{composeAxes as f,create as d}from"./support/axisAngleDegrees.js";import g from"./support/MeshComponent.js";import{MeshNotLoadedError as x,ComponentNotFoundError as y,InvalidLocationError as w,InvalidPolygonError as v,NoLayerError as j,NoModelError as S,MultipleModelsError as b}from"./support/meshErrors.js";import F from"./support/MeshGeoreferencedRelativeVertexSpace.js";import A from"./support/MeshGeoreferencedVertexSpace.js";import R from"./support/MeshLocalVertexSpace.js";import L from"./support/MeshTransform.js";import{MeshVertexAttributes as U}from"./support/MeshVertexAttributes.js";import{triangulate as M}from"./support/triangulationUtils.js";import{getProjectedExtent as E,getExtentFromPositions as P}from"./support/meshUtils/bounds.js";import{centerAt as C}from"./support/meshUtils/centerAt.js";import{project as _}from"./support/meshUtils/georeference.js";import{loadExternal as z}from"./support/meshUtils/loadExternal.js";import{Metadata as G}from"./support/meshUtils/Metadata.js";import{offset as O}from"./support/meshUtils/offset.js";import{convertUnitGeometry as T,createUnitSizeBox as V,extractSingleFaceOfBox as D,createUnitSizeSphere as W,createUnitSizeCylinder as B,convertPlaneSizeParameter as k,createUnitSizePlane as N}from"./support/meshUtils/primitives.js";import{rotate as Z}from"./support/meshUtils/rotate.js";import{scale as H}from"./support/meshUtils/scale.js";import{isFileEditFormat as I,isFileSupported as K}from"../layers/support/infoFor3D.js";import{extractZipFiles as q}from"../support/zipUtils.js";var J;const Q="esri.geometry.Mesh",X={base:null,key:"type",defaultKeyValue:"georeferenced",typeMap:{georeferenced:A,"georeferenced-relative":F,local:R}};let Y=J=class extends(r.LoadableMixin(o(l))){constructor(e){super(e),this.components=null,this.vertexSpace=new A,this.transform=null,this.metadata=new G,this.hasZ=!0,this.hasM=!1,this.vertexAttributes=new U,this.type="mesh"}initialize(){(0===this.metadata.externalSources.length||this.vertexAttributes.position.length)&&(this.loadStatus="loaded"),this.when((()=>{this.addHandles(i((()=>({vertexAttributes:this.vertexAttributes,components:this.components?.map((e=>e.clone()))})),(()=>this._clearSources()),{once:!0,sync:!0}))}))}get hasExtent(){return this.loaded?this.vertexAttributes.position.length>0&&(!this.components||this.components.length>0):null!=this.metadata.displaySource?.extent}get _transformedExtent(){const{components:e,spatialReference:t,vertexAttributes:r,vertexSpace:s}=this,o=r.position;if(0===o.length||e&&0===e.length)return new m({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t});if("local"===s.type){const{_untransformedExtent:e,transform:r}=this;return E(e,r,s,t)}if("georeferenced-relative"===s.type){const{transform:e}=this,r=_({positions:o,transform:e,vertexSpace:s,inSpatialReference:t,outSpatialReference:t});return P(r,t)}return P(o,t)}get _untransformedExtent(){return P(this.vertexAttributes.position,this.spatialReference)}get anchor(){const{vertexSpace:e}=this;if(e.isRelative)return e.getOriginPoint(this.spatialReference);const{center:t,zmin:r}=this._transformedExtent;return new h({x:t.x,y:t.y,z:r,spatialReference:this.spatialReference})}get origin(){const{vertexSpace:e}=this;return e.isRelative?e.getOriginPoint(this.spatialReference):this._transformedExtent.center}get extent(){return this.loaded||null==this.metadata?.displaySource?.extent?this._transformedExtent:this.metadata.displaySource.extent.clone()}addComponent(e){if(!this.loaded)return s.getLogger(this).error("addComponent()",(new x).message);this.components||(this.components=[]),this.components.push(g.from(e)),this.notifyChange("components")}removeComponent(e){if(!this.loaded)return s.getLogger(this).error("removeComponent()",(new x).message);if(this.components){const t=this.components.indexOf(e);if(-1!==t)return this.components.splice(t,1),void this.notifyChange("components")}s.getLogger(this).error("removeComponent()",(new y).message)}rotate(e,t,r,s){return f(e,t,r,ee),Z(this,ee,s),this}offset(e,t,r,o){return this.loaded?($[0]=e,$[1]=t,$[2]=r,O(this,$,o),this):(s.getLogger(this).error("offset()",(new x).message),this)}scale(e,t){return this.loaded?(H(this,e,t),this):(s.getLogger(this).error("scale()",(new x).message),this)}centerAt(e,t){return this.loaded?(C(this,e,t),this):(s.getLogger(this).error("centerAt()",(new x).message),this)}load(e){const{metadata:{displaySource:t}}=this;return t&&this.addResolvingPromise(z(this,t,e)),Promise.resolve(this)}addExternalSources(e){this.metadata.externalSources.addMany(e)}updateDisplaySource(e){this.metadata.displaySource=e}clone(){return this.cloneWithVertexSpace(this.vertexSpace.clone())}cloneWithVertexSpace(e){let t=null;if(this.components){const e=new Map,r=new Map;t=this.components.map((t=>t.cloneWithDeduplication(e,r)))}const r={components:t,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes.clone(),vertexSpace:e,transform:this.transform?.clone()??null,metadata:this.metadata.clone()};return new J(r)}cloneShallow(){return new J({components:this.components,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes,vertexSpace:this.vertexSpace.clone(),transform:this.transform,metadata:this.metadata})}vertexAttributesChanged(){this.notifyChange("vertexAttributes")}async toBinaryGLTF(e){const t=import("./support/meshUtils/exporters/gltf/gltfexport.js"),r=this.load(),s=await Promise.all([t,r]),{toBinaryGLTF:o}=s[0];return o(this,e)}get memoryUsage(){let e=0;if(e+=this.vertexAttributes.memoryUsage,null!=this.components)for(const t of this.components)e+=t.memoryUsage;return e}_clearSources(){this.metadata.clearSources()}static createBox(e,t){if(!(e instanceof h))return s.getLogger(Q).error(".createBox()",(new w).message),null;const r=new J(T(V(),e,t));return t?.imageFace&&"all"!==t.imageFace?D(r,t.imageFace):r}static createSphere(e,t){return e instanceof h?new J(T(W(t?.densificationFactor||0),e,t)):(s.getLogger(Q).error(".createSphere()",(new w).message),null)}static createCylinder(e,t){return e instanceof h?new J(T(B(t?.densificationFactor||0),e,t)):(s.getLogger(Q).error(".createCylinder()",(new w).message),null)}static createPlane(e,t){if(!(e instanceof h))return s.getLogger(Q).error(".createPlane()",(new w).message),null;const r=t?.facing??"up",o=k(r,t?.size);return new J(T(N(r),e,{...t,size:o}))}static createFromPolygon(e,t){if(!(e instanceof u))return s.getLogger(Q).error(".createFromPolygon()",(new v).message),null;const r=M(e);return new J({vertexAttributes:new U({position:r.position}),components:[new g({faces:r.faces,shading:"flat",material:t?.material??null})],spatialReference:e.spatialReference,vertexSpace:new A})}static async createFromGLTF(e,t,r){if(!(e instanceof h)){const e=new w;throw s.getLogger(Q).error(".createfromGLTF()",e.message),e}const{loadGLTFMesh:o}=await n(import("./support/meshUtils/loadGLTFMesh.js"),r);return new J(await o(e,t,r))}static async createFromFiles(e,t,r){const o=e=>s.getLogger(Q).error(".createFromFiles()",e.message);if(!(e instanceof h)){const e=new w;throw o(e),e}const n=r?.layer;if(!n){const e=new j;throw o(e),e}const i=await J.extractAndFilterFiles(t,n),a=i.reduce(((e,t)=>I(n.infoFor3D,t)?e+1:e),0);if(0===a){const e=new S;throw o(e),e}if(a>1){const e=new b;throw o(e),e}const c=J.createWithExternalSource(e,i),[p]=await n.uploadAssets([c],r);return p}static async extractAndFilterFiles(e,t){const r=t?.infoFor3D;if(!r)return e;return(await q(e)).filter((e=>K(r,e)))}static createWithExternalSource(e,t,r){const s=r?.extent??null,{x:o,y:n,z:i,spatialReference:a}=e,c=r?.transform?.clone()??new L,p=r?.vertexSpace??new R({origin:[o,n,i??0]}),m={source:t,extent:s},l=new G;return l.externalSources.push(m),new J({metadata:l,transform:c,vertexSpace:p,spatialReference:a})}static createIncomplete(e,r){const{x:s,y:o,z:n,spatialReference:i}=e,a=r?.transform?.clone()??new L,c=r?.vertexSpace??new R({origin:[s,o,n??0]}),p=new J({transform:a,vertexSpace:c,spatialReference:i});return p.addResolvingPromise(Promise.reject(new t("mesh-incomplete","Mesh resources are not complete"))),p}};e([a({type:[g],json:{write:!0}})],Y.prototype,"components",void 0),e([a({nonNullable:!0,types:X,constructOnly:!0,json:{write:!0}})],Y.prototype,"vertexSpace",void 0),e([a({type:L,json:{write:!0}})],Y.prototype,"transform",void 0),e([a({constructOnly:!0})],Y.prototype,"metadata",void 0),e([a()],Y.prototype,"hasExtent",null),e([a()],Y.prototype,"_transformedExtent",null),e([a()],Y.prototype,"_untransformedExtent",null),e([a()],Y.prototype,"anchor",null),e([a()],Y.prototype,"origin",null),e([a({readOnly:!0,json:{read:!1}})],Y.prototype,"extent",null),e([a({readOnly:!0,json:{read:!1,write:!0,default:!0}})],Y.prototype,"hasZ",void 0),e([a({readOnly:!0,json:{read:!1,write:!0,default:!1}})],Y.prototype,"hasM",void 0),e([a({type:U,nonNullable:!0,json:{write:!0}})],Y.prototype,"vertexAttributes",void 0),Y=J=e([c(Q)],Y);const $=p(),ee=d(),te=Y;export{te as default};
