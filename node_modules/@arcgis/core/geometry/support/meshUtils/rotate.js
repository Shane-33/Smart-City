/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import t from"../../../core/Logger.js";import{f as e}from"../../../chunks/mat3.js";import{a as r}from"../../../chunks/mat3f64.js";import{c as o}from"../../../chunks/mat4.js";import{a as n}from"../../../chunks/mat4f64.js";import{s as i,f as s,g as a,t as l,e as c}from"../../../chunks/vec3.js";import{c as f,Z as p}from"../../../chunks/vec3f64.js";import{getSphericalPCPF as m}from"../../spatialReferenceEllipsoidUtils.js";import{computeTranslationToOriginAndRotation as u}from"../../projection/computeTranslationToOriginAndRotation.js";import{projectPointToVector as g}from"../../projection/projectPointToVector.js";import{create as j,compose as h,axis as v,angleRad as x}from"../axisAngleDegrees.js";import A from"../MeshTransform.js";import{validateGeographicFlag as b,isGeographicMesh as d}from"./geographicUtils.js";import{projectToPCPF as k,projectNormalToPCPF as y,projectTangentToPCPF as w,projectFromPCPF as R,projectNormalFromPCPF as F,projectTangentFromPCPF as L}from"./projection.js";const T="esri.geometry.support.meshUtils.rotate";function U(t,e,r){if(!t.vertexAttributes?.position||0===e[3])return;const{spatialReference:o,vertexSpace:n}=t;if(n.isRelative){b(n,T,r);const o=r?.origin??t.origin;t.transform??=new A,z(t.transform,n,e,o)}else{const n=r?.origin??t.origin;d(o,r)?C(t,e,n):I(t,e,n)}}function z(t,e,r,o){const n=e.origin,l=i($,o.x,o.y,o.z??0),c=s($,l,n);t.applyLocalInverse(c,D),t.rotation=h(t.rotation,r,j()),t.applyLocalInverse(c,c),s(c,c,D),t.translation=a(f(),t.translation,c)}function C(t,r,o){const n=t.spatialReference,i=m(n),s=S;g(o,s,i)||g(t.origin,s,i);const a=t.vertexAttributes.position,c=t.vertexAttributes.normal,f=t.vertexAttributes.tangent,p=new Float64Array(a.length),j=null!=c?new Float32Array(c.length):null,h=null!=f?new Float32Array(f.length):null;u(i,s,M,i),e(O,M);const x=E;l(v(E),v(r),O),x[3]=r[3],k(a,n,p),null!=c&&null!=j&&y(c,a,p,n,j),null!=f&&null!=h&&w(f,a,p,n,h),P(p,x,3,s),R(p,a,n),null!=c&&null!=j&&(P(j,x,3),F(j,a,p,n,c)),null!=f&&null!=h&&(P(h,x,4),L(h,a,p,n,f)),t.vertexAttributesChanged()}function I(e,r,o){const n=S;if(!g(o,n,e.spatialReference)){const r=e.origin;n[0]=r.x,n[1]=r.y,n[2]=r.z,t.getLogger(T).error(`Failed to project specified origin (wkid:${o.spatialReference.wkid}) to mesh spatial reference (wkid:${e.spatialReference.wkid}). Projection may be possible after calling projection.load().`)}P(e.vertexAttributes.position,r,3,n),P(e.vertexAttributes.normal,r,3),P(e.vertexAttributes.tangent,r,4),e.vertexAttributesChanged()}function P(t,e,r,n=p){if(null!=t){o(M,x(e),v(e));for(let e=0;e<t.length;e+=r){for(let r=0;r<3;r++)$[r]=t[e+r]-n[r];c($,$,M);for(let r=0;r<3;r++)t[e+r]=$[r]+n[r]}}}const $=f(),D=f(),E=j(),M=n(),O=r(),S=f();export{U as rotate};
