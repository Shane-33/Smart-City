/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{getMetersPerCartesianUnitForSR as n,convertUnit as t}from"../../../core/unitUtils.js";import{a as e}from"../../../chunks/mat3f64.js";import{a as r,m as o,i,b as a}from"../../../chunks/mat4.js";import{I as s,a as l}from"../../../chunks/mat4f64.js";import{h as c}from"../../../chunks/vec3.js";import{Z as u,f}from"../../../chunks/vec3f64.js";import{n as p}from"../../../chunks/mat3.js";import{canProjectWithoutEngine as m}from"../../projection.js";import{getSphericalPCPF as g}from"../../spatialReferenceEllipsoidUtils.js";import{computeTranslationToOriginAndRotation as h}from"../../projection/computeTranslationToOriginAndRotation.js";import{projectBuffer as j}from"../../projection/projectBuffer.js";import{newDoubleArray as R,copyInto as y}from"../DoubleArray.js";import w from"../MeshGeoreferencedRelativeVertexSpace.js";import A from"../MeshGeoreferencedVertexSpace.js";import x from"../MeshLocalVertexSpace.js";import v from"../MeshTransform.js";import{t as F,a as M}from"../../../chunks/vec32.js";import{isGeographicMesh as S}from"./geographicUtils.js";import{transformNormal as d,transformTangent as k,projectFromPCPF as b,projectNormalFromPCPF as z,projectTangentFromPCPF as G,projectToPCPF as T,projectNormalToPCPF as O,projectTangentToPCPF as P}from"./projection.js";function U(n,t,e){return S(t.spatialReference,e)?W(n,t,e):L(n,t,e)}function V(n,t=s){const{position:e,normal:r,tangent:o}=n;return{position:F(new Float64Array(e.length),e,t),normal:null!=r?d(r,new Float32Array(r.length),t):null,tangent:null!=o?k(o,new Float32Array(o.length),t):null}}function q(n,t,e,r){const{position:o,normal:i,tangent:a}=n;if(!t.isRelative)return{position:o,normal:i,tangent:a};return U(V(n,e?.localMatrix),t.getOriginPoint(r),{geographic:!t.isGeoreferenced})}function B(n,t,e){if(e?.useTransform){const{position:r,normal:o,tangent:i}=n,{x:a,y:s,z:l}=t,c=f(a,s,l??0);return{vertexAttributes:{position:r,normal:o,tangent:i},vertexSpace:e.geographic??1?new x({origin:c}):new w({origin:c}),transform:new v}}return{vertexAttributes:U(n,t,e),vertexSpace:new A,transform:null}}function D(n,t,e){return S(t.spatialReference,e)?K(n,t,e):J(n,t,e)}function E(n,t,e,r,o){if(!t.isRelative)return D(n,r,o);const{spatialReference:i}=r,a=q(n,t,e,i);return r.equals(t.getOriginPoint(i))?J(a,r,o):D(a,r,o)}function I({positions:n,transform:t,vertexSpace:e,inSpatialReference:i,outSpatialReference:a,outPositions:l,localMode:f}){const p=e.isRelative?e.origin:u,w=e.isRelative?t?.localMatrix??s:s;if(e.isGeoreferenced){const t=l??R(n.length);if(r(w,s)?y(t,n):F(t,n,w),!c(p,u)){const[n,e,r]=p;for(let o=0;o<t.length;o+=3)t[o]+=n,t[o+1]+=e,t[o+2]+=r}return j(t,i,0,t,a,0,t.length/3),t}let A=i;const x=g(i);A=a.isWebMercator&&f||!m(i,x)?A:x,h(i,p,_,A),o(_,_,w);const v=l??R(n.length);return F(v,n,_),j(v,A,0,v,a,0,v.length/3),v}function L(n,t,e){const r=new Float64Array(n.position.length),o=n.position,i=t.x,a=t.y,s=t.z??0,l=$(e?e.unit:null,t.spatialReference);for(let c=0;c<o.length;c+=3)r[c]=o[c]*l+i,r[c+1]=o[c+1]*l+a,r[c+2]=o[c+2]*l+s;return{position:r,normal:n.normal,tangent:n.tangent}}function W(n,t,e){const r=t.spatialReference,o=N(t,e,_),i=new Float64Array(n.position.length),a=Z(n.position,o,r,i),s=p(tn,o);return{position:a,normal:C(a,i,n.normal,s,r),tangent:H(a,i,n.tangent,s,r)}}function Z(n,t,e,r){F(r,n,t);const o=new Float64Array(n.length);return b(r,o,e)}function C(n,t,e,r,o){if(null==e)return null;const i=new Float32Array(e.length);return M(i,e,r),z(i,n,t,o,i),i}function H(n,t,e,r,o){if(null==e)return null;const i=new Float32Array(e.length);M(i,e,r,4);for(let a=3;a<i.length;a+=4)i[a]=e[a];return G(i,n,t,o,i),i}function J(n,t,e){const r=new Float64Array(n.position.length),o=n.position,i=t.x,a=t.y,s=t.z??0,l=$(e?e.unit:null,t.spatialReference);for(let c=0;c<o.length;c+=3)r[c]=(o[c]-i)/l,r[c+1]=(o[c+1]-a)/l,r[c+2]=(o[c+2]-s)/l;return{position:r,normal:n.normal,tangent:n.tangent}}function K(n,t,e){const r=t.spatialReference;N(t,e,_);const o=i(nn,_),a=new Float64Array(n.position.length),s=Q(n.position,r,o,a),l=p(tn,o);return{position:s,normal:X(n.normal,n.position,a,r,l),tangent:Y(n.tangent,n.position,a,r,l)}}function N(n,t,e){h(n.spatialReference,[n.x,n.y,n.z??0],e,g(n.spatialReference));const r=$(t?t.unit:null,n.spatialReference);return a(e,e,[r,r,r]),e}function Q(n,t,e,r){const o=T(n,t,r),i=new Float64Array(o.length);return F(i,o,e),i}function X(n,t,e,r,o){if(null==n)return null;const i=O(n,t,e,r,new Float32Array(n.length));return M(i,i,o),i}function Y(n,t,e,r,o){if(null==n)return null;const i=P(n,t,e,r,new Float32Array(n.length));return M(i,i,o,4),i}function $(e,r){if(null==e)return 1;const o=n(r);return 1/t(o,"meters",e)}const _=l(),nn=l(),tn=e();export{V as applyTransform,U as georeference,q as georeferenceApplyTransform,B as georeferenceByTransform,I as project,D as ungeoreference,E as ungeoreferenceByTransform};
