/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{createTask as e}from"../../../core/asyncUtils.js";import t from"../../../core/Error.js";import r from"../../../core/Logger.js";import{throwIfAborted as s,isAbortError as a}from"../../../core/promiseUtils.js";import{equals as i}from"../../../geometry/support/spatialReferenceUtils.js";import{convertFromGeometry as o,convertToGeometry as n}from"../featureConversionUtils.js";import u from"../data/FeatureStore.js";import{checkProjectionSupport as p,project as l}from"../data/projectionSupport.js";import{QueryEngine as h}from"../data/QueryEngine.js";import{validateGeoJSON as c,createOptimizedFeatures as m}from"./geojson/geojson.js";import{mixAttributes as y}from"./support/sourceUtils.js";import{getGetFeatureSpatialReference as f,getFeature as g}from"../../ogc/wfsUtils.js";import d from"../../support/FieldsIndex.js";import{utc as _}from"../../../time/timeZoneUtils.js";class F{constructor(){this._queryEngine=null,this._customParameters=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r){const{getFeatureUrl:a,getFeatureOutputFormat:i,fields:o,geometryType:n,featureType:l,objectIdField:c,customParameters:m}=e,{spatialReference:y,getFeatureSpatialReference:g}=f(a,l,e.spatialReference);this._featureType=l,this._customParameters=m,this._getFeatureUrl=a,this._getFeatureOutputFormat=i,this._getFeatureSpatialReference=g;try{await p(g,y)}catch{throw new t("unsupported-projection","Projection not supported",{inSpatialReference:g,outSpatialReference:y})}s(r);const F=d.fromLayerJSON({fields:o,dateFieldsTimeReference:o.some((e=>"esriFieldTypeDate"===e.type))?{timeZoneIANA:_}:null}),w=await this._snapshotFeatures({fieldsIndex:F,geometryType:n,objectIdField:c,spatialReference:y},r.signal);return this._queryEngine=new h({fieldsIndex:F,geometryType:n,hasM:!1,hasZ:!1,objectIdField:c,spatialReference:y,timeInfo:null,featureStore:new u({geometryType:n,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(w),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(s){return this._customParameters=s,this._snapshotTask?.abort(),this._snapshotTask=e((e=>this._snapshotFeatures(this._queryEngine,e))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),a(e)||r.getLogger("esri.layers.WFSLayer").error(new t("wfs-layer:getfeature-error","An error occurred during the GetFeature request",{error:e}))})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures({objectIdField:e,geometryType:t,spatialReference:r,fieldsIndex:a},u){const p=await g(this._getFeatureUrl??"",this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:u});c(p,this._getFeatureSpatialReference.wkid),s(u);const h=m(p,{geometryType:t,hasZ:!1,objectIdField:e});if(!i(r,this._getFeatureSpatialReference))for(const s of h)null!=s.geometry&&(s.geometry=o(l(n(s.geometry,t,!1,!1),this._getFeatureSpatialReference,r)));let f=1;for(const s of h){const t={};y(a,t,s.attributes,!0),s.attributes=t,null==t[e]&&(s.objectId=t[e]=f++)}return h}}export{F as default};
