/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../geometry.js";import e from"../../request.js";import t from"../../core/Error.js";import n from"../../core/Logger.js";import{WGS84 as i}from"../../geometry/support/spatialReferenceUtils.js";import{project as r}from"../../geometry/support/webMercatorUtils.js";import{convertToFeatureSet as a,convertToGeometry as o,convertFromGeometry as s}from"../graphics/featureConversionUtils.js";import l from"../graphics/OptimizedFeatureSet.js";import{validateGeoJSON as c,inferLayerProperties as u,createOptimizedFeatures as d}from"../graphics/sources/geojson/geojson.js";import{createDrawingInfo as m}from"../graphics/sources/support/clientSideDefaults.js";import p from"../support/FieldsIndex.js";import{kebabDict as f}from"../support/fieldType.js";import{utc as g}from"../../time/timeZoneUtils.js";import y from"../../geometry/SpatialReference.js";const w=n.getLogger("esri.layers.graphics.sources.ogcfeature"),b="http://www.opengis.net/def/crs/",h=`${b}OGC/1.3/CRS84`;async function j(n,i,r={},a=5){const{links:o}=n,s=G(o,"items","application/geo+json")||G(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==s)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{data:l}=await e(s.href,{signal:r.signal,query:{limit:a,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});c(l);const d=u(l,{geometryType:i.geometryType}),y=i.fields||d.fields||[],b=null!=i.hasZ?i.hasZ:d.hasZ,h=d.geometryType,j=i.objectIdField||d.objectIdFieldName||"OBJECTID";let F=i.timeInfo;const I=y.find((({name:e})=>e===j));if(I)I.editable=!1,I.nullable=!1;else{if(!d.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:j,alias:j,type:"number"===d.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(j!==d.objectIdFieldName){const e=y.find((({name:e})=>e===d.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}y===d.fields&&d.unknownFields.length>0&&w.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:d.unknownFields}});for(const e of y){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!f.jsonValues.includes(e.type))throw new t("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(F){const e=new p(y);if(F.startTimeField){const t=e.get(F.startTimeField);t?(F.startTimeField=t.name,t.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){const t=e.get(F.endTimeField);t?(F.endTimeField=t.name,t.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){const t=e.get(F.trackIdField);t?F.trackIdField=t.name:(F.trackIdField=null,w.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:F}}))}F.timeReference||={timeZoneIANA:g},F.startTimeField||F.endTimeField||(w.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:F}}),F=null)}return{drawingInfo:h?m(h):null,extent:$(n),geometryType:h,fields:y,hasZ:!!b,objectIdField:j,timeInfo:F}}async function F(n,i={}){const{links:r}=n,a=G(r,"data","application/json")||G(r,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==a)throw new t("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:s,signal:l}=i,{data:c}=await e(a.href,{signal:l,headers:{accept:"application/json"},query:{...s,token:o}});return c}async function I(n,i={}){const{links:r}=n,a=G(r,"conformance","application/json")||G(r,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==a)throw new t("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:s,signal:l}=i,{data:c}=await e(a.href,{signal:l,headers:{accept:"application/json"},query:{...s,token:o}});return c}async function T(t,n={}){const{apiKey:i,customParameters:r,signal:a}=n,{data:o}=await e(t,{signal:a,headers:{accept:"application/json"},query:{...r,token:i}});return o}async function k(t,n={}){const i="application/vnd.oai.openapi+json;version=3.0",r=G(t.links,"service-desc",i);if(null==r)return w.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:a,customParameters:o,signal:s}=n,{data:l}=await e(r.href,{signal:s,headers:{accept:i},query:{...o,token:a}});return l}function x(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return y.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return y.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}async function S(e,t,n){const i=await v(e,t,n);return a(i)}async function v(n,a,c){const{collection:u,layerDefinition:m,maxRecordCount:p,queryParameters:{apiKey:f,customParameters:g},spatialReference:w,supportedCrs:b}=n,{links:h}=u,j=G(h,"items","application/geo+json")||G(h,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==j)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:F,num:I,start:T,timeExtent:k,where:x}=a;if(a.objectIds)throw new t("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const S=y.fromJSON(w),v=a.outSpatialReference??S,N=v.isWGS84?null:R(v,b),q=M(F,b),$=O(k),W=C(x),D=I??(null!=T&&void 0!==T?10:p),{data:P}=await e(j.href,{...c,query:{...g,...q,crs:N,datetime:$,query:W,limit:D,startindex:T,token:f},headers:{accept:"application/geo+json"}});let Z=!1;if(P.links){const e=P.links.find((e=>"next"===e.rel));Z=!!e}!Z&&Number.isInteger(P.numberMatched)&&Number.isInteger(P.numberReturned)&&(Z=P.numberReturned<P.numberMatched);const{fields:K,geometryType:A,hasZ:L,objectIdField:J}=m,U=d(P,{geometryType:A,hasZ:L,objectIdField:J});if(!N&&v.isWebMercator)for(const e of U)if(null!=e.geometry&&null!=A){const t=o(e.geometry,A,L,!1);t.spatialReference=y.WGS84,e.geometry=s(r(t,v))}for(const e of U)e.objectId=e.attributes[J];const z=N||!N&&v.isWebMercator?v.toJSON():i,E=new l;return E.exceededTransferLimit=Z,E.features=U,E.fields=K,E.geometryType=A,E.hasZ=L,E.objectIdFieldName=J,E.spatialReference=z,E}function N(e){return null!=e&&"extent"===e.type}function R(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const r=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return r?`${b}${r}`:null}function q(e){if(null==e)return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function O(e){if(null==e)return null;const{start:t,end:n}=e;return`${null!=t?t.toISOString():".."}/${null!=n?n.toISOString():".."}`}function C(e){return null!=e&&e&&"1=1"!==e?e:null}function M(e,t){if(!N(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:q(e)};const i=R(n,t);return null!=i?{bbox:q(e),"bbox-crs":i}:n.isWebMercator?{bbox:q(r(e,y.WGS84))}:null}function $(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,r=n[0],a=n[1],o=i?void 0:n[2];return{xmin:r,ymin:a,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:o,zmax:i?void 0:n[5],spatialReference:y.WGS84.toJSON()}}function G(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{h as crsDefault,b as crsPrefix,j as getCollectionDefinition,F as getServerCollections,I as getServerConformance,T as getServerLandingPage,k as getServerOpenApi,x as getSpatialReferenceWkid,S as queryFeatureSetJSON,v as queryOptimizedFeatureSet};
