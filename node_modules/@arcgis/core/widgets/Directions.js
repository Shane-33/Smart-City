/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{on as t,pausable as s}from"../core/events.js";import{makeHandle as i}from"../core/handleUtils.js";import{assertIsSome as r}from"../core/maybe.js";import{watch as o,initial as n,when as a,on as l}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import{cast as d}from"../core/accessorSupport/decorators/cast.js";import"../core/arrayUtils.js";import"../core/has.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{defaultUnitPropertyMetadata as h}from"../properties/defaultUnit.js";import p from"../rest/support/Stop.js";import v from"../symbols/SimpleMarkerSymbol.js";import m from"./Search.js";import _ from"./Widget.js";import g from"./Directions/DirectionsViewModel.js";import{SaveLayer as S}from"./Directions/components/SaveLayer.js";import{formatDistance as y,formatDuration as w}from"./Directions/support/directionsUtils.js";import{DepartureTimeOption as f,css as M,getIconName as b}from"./Directions/support/resources.js";import{isArcGISWorldGeocoder as T,meteredArcGISLocatorUrl as C}from"./Search/support/locatorUtils.js";import{loadCalciteComponents as k}from"./support/componentsUtils.js";import D from"./support/DatePicker.js";import{globalCss as I}from"./support/globalCss.js";import{Heading as P,incrementHeadingLevel as R}from"./support/Heading.js";import{legacyIcon as L}from"./support/legacyIcon.js";import B from"./support/TimePicker.js";import{accessibleHandler as H}from"./support/decorators/accessibleHandler.js";import{messageBundle as A}from"./support/decorators/messageBundle.js";import{tsx as E}from"./support/jsxFactory.js";import"./support/widgetUtils.js";import j from"sortablejs";import{formatNumber as x}from"../intl/number.js";import{formatDate as O,convertDateFormatToIntlOptions as U}from"../intl/date.js";const z={departureTime:!0,layerDetails:!0,printButton:!1,saveAsButton:!0,saveButton:!0,stops:!0,traveMode:!0};function $(e){const t=e.getTimezoneOffset(),s=t>0?"-":"+",i=60,r=Math.abs(Math.floor(t/i)),o=Math.abs(Math.floor(t)%i),n={minimumIntegerDigits:2};return`GMT${s}${x(r,n)}${x(o,n)}`}function F(e){return!!e.composedPath?.().find((e=>e.classList?.contains("esri-search__suggestions-list")))}const N="search-term",V="date-time-picker",K=100,W=500;let q=class extends _{constructor(e,t){super(e,t),this._activeStop=null,this._activeManeuver=null,this._autoStopRemovalDelay=K,this._autoStopRemovalTimeoutId=void 0,this._departureTimeOption=f.NOW,this._datePicker=new D,this._focusedManeuver=null,this._newPlaceholderStop=null,this._pointerDownUpHandle=null,this._pointerPressedSearchSuggestionStop=null,this._renderSavePopoverFunction=null,this._saveAsButtonNode=null,this._saveLayer=new S,this._sections=null,this._sortable=null,this._stopsToSearches=new Map,this._timePicker=new B,this._viewClickHandle=null,this.headingLevel=2,this.iconClass=M.widgetIcon,this.icon=null,this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this.searchProperties=null,this.viewModel=new g,this.visibleElements={...z},this._setUpDragAndDropStops=e=>{this._sortable=j.create(e,{draggable:`.${M.validStopRow}`,ghostClass:M.stopRowGhost,handle:`.${M.stopHandle}`,onEnd:this._handleStopInputDragEnd})},this._handleDragHandlePointerDown=()=>this.viewModel.layer?.stops.forEach((e=>this.acquireSearch(e).activeMenu="none")),this._handleStopInputDragEnd=({oldIndex:e,newIndex:t,target:s})=>{if(e===t||null==t||null==e)return;const{children:i}=s,r=i[t],o=i[e],n=t-e<0;s.insertBefore(r,n?o.nextElementSibling:o);const{stops:a}=this.viewModel.layer;a.reorder(a.at(e),t);for(const l of a)l.sequence=null;this._getDirections()}}initialize(){this.addHandles([o((()=>this.viewModel.layer?.routeInfo),(()=>{this._activeManeuver=null,this._focusedManeuver=null,this._sections=this._getSections(),this.scheduleRender()}),n),a((()=>this.view),((e,s)=>{if(s&&(this._viewClickHandle=null,null!=s&&this.removeHandles(s)),e){const s=this._prepPointerDownUpClick(),i=this._prepViewClick();s.pause(),i.pause();const r=e.surface;this.addHandles([t(r,"mousedown",(()=>this._autoStopRemovalDelay=W)),t(r,"mouseup",(()=>this._autoStopRemovalDelay=K)),s,i],e),this._pointerDownUpHandle=s,this._viewClickHandle=i}}),n),a((()=>null==this.viewModel.serviceDescription),(()=>{try{this.viewModel.load()}catch{}}),n),o((()=>this._saveLayer.state),(()=>{this.scheduleRender()}))]),this.when((()=>{this.destroyed||this.visibleElements.saveAsButton&&(this._renderSavePopoverFunction=this._renderSavePopover.bind(this),this._projector.append(document.body,this._renderSavePopoverFunction))}))}loadDependencies(){return k({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),link:()=>import("@esri/calcite-components/dist/components/calcite-link.js"),popover:()=>import("@esri/calcite-components/dist/components/calcite-popover.js")})}destroy(){this._datePicker.destroy(),this._timePicker.destroy();for(const e of this._stopsToSearches.values())e.destroy();this._sortable?.destroy(),null!=this._renderSavePopoverFunction&&this._projector.detach(this._renderSavePopoverFunction)}get apiKey(){return this.viewModel.apiKey}set apiKey(e){this.viewModel.apiKey=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get lastRoute(){return this.viewModel.lastRoute}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxStops(){return this.viewModel.maxStops}set maxStops(e){this.viewModel.maxStops=e}get unit(){return this.defaultUnit}set unit(e){this._overrideIfSome("unit",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...z,...e}}acquireSearch(e){const{view:t}=this.viewModel;if(this._stopsToSearches.has(e)){const s=this._stopsToSearches.get(e);return s.view=t,this._overrideDefaultSources(s),s}const s=new m({view:t,resultGraphicEnabled:!1,popupEnabled:!1,...this.searchProperties});return this._normalizeSearchSources(s),this.addHandles([l((()=>s.allSources),"change",(()=>this._normalizeSearchSources(s))),s.on("select-result",(()=>{e.geometry=s.selectedResult?.feature.geometry,e.name=s.selectedResult?.name,this._getDirections()})),s.on("search-focus",(()=>this._handleStopInputFocus(s,e))),s.on("search-blur",(()=>this._handleStopInputBlur(s,e))),s.on("search-clear",(()=>{e.geometry=null,e.name=null,this._activeStop=e,this.viewModel.layer?.removeResult()})),o((()=>s.searchTerm),(t=>{e.name=t}))],s),this._stopsToSearches.set(e,s),s}getDirections(){return this.viewModel.getDirections()}render(){return E("div",{class:this.classes(M.base,I.widget,I.panel,M.scroller)},this._renderPanelContent())}save(){return this.viewModel.save()}saveAs(e,t={}){return this.viewModel.saveAs(e,t)}zoomToRoute(){return this.viewModel.zoomToRoute()}_renderPanelContent(){const{layer:e,serviceDescription:t,state:s}=this.viewModel,i="initializing"===s,r="error"===s&&!t,o="unauthenticated"===s,n={[M.panelContentLoading]:i,[M.panelContentError]:r||!e,[M.panelContentSignIn]:o},a=i?"presentation":"group",l=e?o?this._renderSignIn():r?this._renderMessage(this._getErrorMessage()):i?this._renderLoader():this._renderReadyContent():this._renderMessage(this.messages.missingLayer);return E("div",{class:this.classes(M.panelContent,n),role:a},l)}_renderReadyContent(){return[this._renderStopsContainer(),this._renderTravelModeOptions(),this._renderDepartureTimeControls(),this._renderSaveContainer(),this._renderSectionSplitter(),this._renderDirectionsContainer()]}_renderSignIn(){return E("div",{class:M.signInContent,key:"sign-in"},E(P,{class:M.contentTitle,level:this.headingLevel},this.messages.widgetLabel),this._renderPlaceholder(),E(P,{level:R(this.headingLevel)},this.messages.signInRequired),E("button",{bind:this,class:this.classes(I.button,I.buttonSecondary,M.signInButton),onclick:this._handleSignInClick,tabIndex:0,type:"button"},this.messagesCommon.auth.signIn))}_handleSignInClick(){this.viewModel.load().catch((()=>{}))}_renderTravelModeOptions(){if(!this.visibleElements.traveMode)return null;const{selectedTravelMode:e,travelModes:t}=this.viewModel;if(0===t.length)return null;const s=null!=e?e.name:this.messages.travelMode;return E("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.travelMode,this._saveLayer.opened&&I.buttonDisabled),key:"esri-directions__travel-mode-controls",role:"group"},E("select",{"aria-label":s,bind:this,class:this.classes(M.travelModeSelect,I.select),key:"esri-directions__travel-mode-options",onchange:this._handleTravelModeChange,title:s},t.map(((t,s)=>E("option",{"data-mode":t,key:`esri-directions__travel-mode-${s}`,selected:e===t,value:`${s}`},t.name)))))}_handleTravelModeChange(e){const t=e.currentTarget;this.viewModel.selectedTravelMode=Y(t.item(t.selectedIndex)),this._getDirections()}_renderStopsContainer(){return this.visibleElements.stops?E("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.section,this._saveLayer.opened&&I.buttonDisabled),key:"esri-directions__stops-container",role:"group"},this._renderStops()):null}_renderDepartureTimeControls(){if(!this.visibleElements.departureTime)return null;const{messages:{departAt:e,departureTime:t,leaveNow:s,timeUnspecified:i}}=this;return E("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.departureTime,this._saveLayer.opened&&I.buttonDisabled),key:"esri-directions__departure-time-controls",role:"group"},E("select",{"aria-label":t,bind:this,class:this.classes(M.departureTimeSelect,I.select),onchange:this._handleDepartureOptionChange,title:t},E("option",{selected:this._departureTimeOption===f.NOW,value:f.NOW},s),E("option",{selected:this._departureTimeOption===f.DEPART_AT,value:f.DEPART_AT},e),E("option",{selected:this._departureTimeOption===f.UNSPECIFIED,value:f.UNSPECIFIED},i)),this._departureTimeOption===f.DEPART_AT?this._renderTimeControls():null)}_renderStops(){const{stops:e}=this.viewModel.layer;let t=0;for(const r of this._stopsToSearches.keys())e.includes(r)||this._disposeSearch(r);for(const r of e){const e=this.acquireSearch(r);"none"!==e.activeMenu&&(t+=1),null!=r.name&&(e.searchTerm=r.name)}const s=e.toArray().map(((s,i)=>{const r=e.length,o=i>1&&null==s.geometry,n={[L.radioUnchecked]:i>=0&&i<r-1,[L.radioChecked]:i===r-1},a={[M.lastStopIconContainer]:i===r-1},l={[M.validStopRow]:!o},c=e.at(i+1),d=i===r-1,u=i===r-2,h=2===r&&0===i||r>2&&!d&&!u||r>2&&u&&null!=c?.geometry||r>2&&d&&null==s.geometry,p=r<3,v=this.acquireSearch(s),{messages:m}=this,{removeStop:_,reverseStops:g,unlocated:S}=m,y=null!=s.geometry&&null!=s.name?s.name:S,w=x(i+1),f=`${m.stopLabel} ${w} (${y})`,b=`${this.id}__stop--${i}`,T=!!v.searchTerm&&!!v.selectedResult&&null!=s.geometry&&v.selectedResult.name===s.name,C={zIndex:"none"!==v.activeMenu?""+t--:""};return E("li",{afterCreate:this._handleStopFieldCreation,"aria-label":f,bind:this,class:this.classes(M.stopRow,l),"data-stop-index":i,id:b,key:i,styles:C},E("div",{class:M.stopHandle},E("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,L.handleVertical,M.stopHandleIcon,M.interactiveStopIcon),onpointerdown:this._handleDragHandlePointerDown}),E("div",{"aria-labelledby":b,bind:this,class:this.classes(M.stopIconContainer,a),"data-stop-index":i,onclick:this._handleStopIconClick,onkeydown:this._handleStopIconClick,role:"button"},E("span",{class:this.classes(M.stopIcon,n),tabIndex:T?0:void 0}))),E("div",{class:M.stopInput},v.render()),E("div",{class:M.stopOptions,role:"group"},E("div",{"aria-label":_,bind:this,class:M.removeStopButton,"data-stop-index":i,hidden:p,onclick:this._handleRemoveStop,onkeydown:this._handleRemoveStop,role:"button",tabIndex:0,title:_},E("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,M.removeStop,L.trash,M.interactiveStopIcon)}),E("span",{class:L.fontFallbackText},"removeStopTitle")),E("div",{"aria-label":g,bind:this,class:M.reverseStops,hidden:h,onclick:this._handleReverseStops,onkeydown:this._handleReverseStops,role:"button",tabIndex:0,title:g},E("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,L.upDownArrows,M.interactiveStopIcon)}),E("span",{class:L.fontFallbackText},"removeStopTitle"))))})),i=this._renderAddStop();return E("div",null,E("ol",{afterCreate:this._setUpDragAndDropStops,class:M.stops,role:"group"},s),i)}_renderAddStop(){const e=this.viewModel.layer?.stops;if(!e)return null;const t=e.filter((({geometry:e})=>null!=e)),s=e.at(-1);return t.length>1&&t.length<this.maxStops&&null!=s?.geometry?E("div",{class:M.toolbarSection},E("div",{class:M.toolbarButtons},E("calcite-button",{appearance:"outline",class:M.addStopButton,iconStart:"plus",key:M.addStopButton,kind:"neutral",label:this.messages.addStop,onclick:()=>{this._addNewPlaceholder()},round:!0,scale:"s",width:"full"},this.messages.addStop))):null}_handleStopIconClick(e){const t=J(e.currentTarget),s=null!=t?this.viewModel.layer?.stops.at(t):void 0;s?.geometry&&this._centerAtStop(s)}_handleClearRouteClick(){this.viewModel.reset()}_centerAtStop(e){this.viewModel.centerAt(e)}_handleStopFieldCreation(e){const t=this._newPlaceholderStop;if(!t)return;const s=J(e),i=null!=s?this.viewModel.layer?.stops.at(s):void 0;if(t===i){const e=this.acquireSearch(i);e.when((()=>{this.renderNow(),e.focus()}))}this._newPlaceholderStop=null}_handleStopInputBlur(e,t){if(this._saveLayer.opened)return;this.removeHandles(N);if(!!e.selectedResult&&null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry===e.selectedResult?.feature.geometry)return void this._pointerDownUpHandle?.pause();const s=null==t.geometry&&null==e.selectedResult?.feature.geometry,i=null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry!==e.selectedResult?.feature.geometry;if((s||i)&&"none"===e.activeMenu&&e.searchTerm)return e.search(),void this._pointerDownUpHandle?.pause();e.searchTerm||(this._viewClickHandle?.resume(),clearTimeout(this._autoStopRemovalTimeoutId),this._autoStopRemovalTimeoutId=setTimeout((()=>{this.destroyed||(this._viewClickHandle?.pause(),"searching"!==e.viewModel.state?this._pointerPressedSearchSuggestionStop||(null!=t.geometry&&(t.geometry=null,this._getDirections()),this.scheduleRender()):this._pointerDownUpHandle?.pause())}),this._autoStopRemovalDelay))}_handleStopInputFocus(e,t){this._pointerDownUpHandle?.resume();const{view:s}=this;if(this.hasHandles(N)||!s)return;const r=s.cursor;this.addHandles([i((()=>{s.cursor=r})),o((()=>e.searchTerm),(t=>{e.destroyed||(s.cursor=t.length?r:"copy")}),n)],N),this._activeStop=t}_prepViewClick(){const{view:e}=this.viewModel;r(e),r(e.surface);const t=s(e,"click",this._handleViewClick.bind(this)),i=s(e.surface,"click",(()=>{clearTimeout(this._autoStopRemovalTimeoutId),i.pause()}));return{remove(){i.remove(),t.remove()},pause(){i.pause(),t.pause()},resume(){i.resume(),t.resume()}}}_prepPointerDownUpClick(){const e=s(document,"pointerdown",(e=>{this._pointerPressedSearchSuggestionStop=F(e)?this._activeStop:null})),t=s(document,"pointerup",(e=>{this._pointerDownUpHandle?.pause();const t=F(e),s=this._activeStop;t||s!==this._pointerPressedSearchSuggestionStop||this._removeStop(s),this.scheduleRender(),this._pointerPressedSearchSuggestionStop=t?s:null}));return{remove(){t.remove(),e.remove()},pause(){t.pause(),e.pause()},resume(){e.resume()}}}_handleViewClick(e){e.stopPropagation();const t=this._activeStop,s=t?this._stopsToSearches.get(t):null;t&&s&&!s.searchTerm&&(s.search(e.mapPoint).then((e=>{const i=e?.results[0].results;if(!i)return;const{feature:r,name:o}=i[0];t.geometry=r.geometry,t.name=o,s.searchTerm=o})),this.scheduleRender()),this._viewClickHandle?.pause(),clearTimeout(this._autoStopRemovalTimeoutId)}_addNewPlaceholder(){if(this._pointerDownUpHandle?.pause(),this._newPlaceholderStop)return;const e=new p({symbol:new v});this.viewModel.layer?.stops.add(e),this._newPlaceholderStop=e}_handleReverseStops(){this._reverseStops()}_reverseStops(){const e=this.viewModel.layer?.stops??[];e.reverse();for(const t of e)t.sequence=null;this._getDirections()}_handleRemoveStop(e){const{layer:t}=this.viewModel;if(!t)return;const s=J(e.currentTarget);if(null==s)return;const{stops:i,routeInfo:r}=t,o=i.at(s);this._removeStop(o),null==o.geometry&&null!=r||this._getDirections()}_removeStop(e){const{stops:t}=this.viewModel.layer;!e||t.length<=2||(this._disposeSearch(e),t.remove(e))}_handleDepartureOptionChange(e){const t=e.currentTarget,s=t.item(t.selectedIndex);s.value===f.NOW?(this._departureTimeOption=f.NOW,this.viewModel.departureTime=f.NOW,this.removeHandles(V),this._getDirections()):s.value===f.DEPART_AT?(this._departureTimeOption=f.DEPART_AT,this.addHandles(o((()=>[this._datePicker.value,this._timePicker.value]),(()=>{this._updateDepartureTime(),this._getDirections()}),n),V)):(this._departureTimeOption=f.UNSPECIFIED,this.viewModel.departureTime=null,this._getDirections())}_updateDepartureTime(){const e=this._datePicker.value,t=this._timePicker.value;e&&t&&(this.viewModel.departureTime=new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes()))}_renderTimeControls(){return E("div",{class:M.departureTimeControls,key:"esri-directions__time-controls",role:"group"},this._datePicker.render(),this._timePicker.render())}_renderSectionSplitter(){return E("div",{class:M.sectionSplitter})}_renderSaveContainer(){const{saveButton:e,saveAsButton:t,printButton:s,layerDetails:i}=this.visibleElements;return e||t||s||i?E("div",{class:M.saveSection,key:M.saveSection},this._renderSaveButtons(),this._renderRouteLayerDetailsLink()):null}_renderSaveButtons(){const{saveButton:e,saveAsButton:t,printButton:s}=this.visibleElements;return e||t||s?E("div",{class:M.saveButtons,key:M.saveButtons},this._renderSaveButton(),this._renderSaveAsButton(),this._renderPrintButton()):null}_renderSaveButton(){if(!this.visibleElements.saveButton)return null;const{portalItem:e,routeInfo:t}=this.viewModel.layer,s=e?.itemControl,i=null!=t&&("admin"===s||"update"===s);return E("calcite-button",{appearance:"outline",class:M.saveButton,disabled:!i,iconStart:"save",key:M.saveButton,label:this.messagesCommon.save,onclick:()=>{this._handleSaveButtonClick()},width:"full"},this.messagesCommon.save)}_renderSaveAsButton(){if(!this.visibleElements.saveAsButton)return null;const e=null==this.viewModel.layer.routeInfo;return E("div",{class:M.saveAsButtonPopover,key:M.saveAsButtonPopover},E("calcite-button",{afterCreate:e=>{this._saveAsButtonNode=e},appearance:"outline",class:M.saveAsButton,disabled:e,iconStart:"duplicate",key:M.saveAsButton,label:this.messagesCommon.saveAs,onclick:()=>this._handleSaveAsButtonClick(),width:"full"},this.messagesCommon.saveAs))}_renderSavePopover(){return E("calcite-popover",{label:this._saveLayer.label,open:this._saveLayer.opened,overlayPositioning:"fixed",referenceElement:this._saveAsButtonNode},this._saveLayer.render())}_handleSaveAsButtonClick(){this._saveLayer.opened?this._saveLayer.close():this._saveLayer.open(this.viewModel.layer)}_renderPrintButton(){return this.visibleElements.printButton?E("calcite-button",{appearance:"outline",class:M.printButton,iconStart:"print",key:M.printButton,label:this.messagesCommon.print}):null}_renderRouteLayerDetailsLink(){if(!this.visibleElements.layerDetails)return null;const{portalItem:e}=this.viewModel.layer;if(!e)return null;const{id:t,portal:{url:s}}=e,i=`${s}/home/item.html?id=${t}`;return E("calcite-link",{class:M.layerDetailsLink,href:i,key:M.layerDetailsLink,target:"_blank"},this.messages.viewLayerDetails)}_handleSaveButtonClick(){this.viewModel.layer.save()}_renderDirectionsContainer(){return E("div",{class:this.classes(M.directionsSection,M.section),key:"esri-directions__container"},this._renderDirectionsContainerContent())}_renderLoader(){return E("div",{class:M.loader,key:"loader"})}_renderWarningCard(){return E("div",{class:M.warningCard,role:"alert"},E("div",{class:M.warningHeader},E("span",{"aria-hidden":"true",class:L.noticeTriangle}),E(P,{class:M.warningHeading,level:this.headingLevel},this.messagesCommon.warning)),E("div",{class:M.warningMessage},this._getErrorMessage()))}_renderDirectionsContainerContent(){const{layer:e,state:t}=this.viewModel,s="routing"===t;return"error"===t?this._renderWarningCard():s?this._renderLoader():null!=e.directionLines?E("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.summary,this._saveLayer.opened&&I.buttonDisabled),key:"esri-directions__summary",role:"group"},this._renderCosts(),this._renderRouteActions(),this._renderManeuverSections()):E("div",{class:I.empty,key:"esri-directions__placeholder"},this._renderPlaceholder(),E(P,{class:M.message,level:this.headingLevel},this.messages.directionsPlaceholder))}_renderPlaceholder(){return E("svg",{class:I.emptyIllustration,viewBox:"0 0 256 256",xmlns:"http://www.w3.org/2000/svg"},E("path",{d:"M192 36c-15.477 0-24 6.034-24 16.99v45.822l24 24 24-24v-45.82C216 42.033 207.477 36 192 36zm20 61.155l-20 20-20-20V52.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM192 52a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zM92 140.99C92 130.035 83.477 124 68 124s-24 6.034-24 16.99v45.822l24 24 24-24zm-4 44.165l-20 20-20-20V140.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM68 140a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zm84-44h16v4h-16zm-24 80h4v12h-12v-4h8zm0-28h4v16h-4zm0-52h12v4h-8v8h-4zm0 24h4v16h-4zm-36 64h16v4H92z",fill:"currentcolor"}))}_renderMessage(e){return E(P,{class:M.messageHeading,level:this.headingLevel},e)}_renderRouteActions(){return E("div",{class:M.routeActions},E("button",{"aria-label":this.messages.clearRoute,bind:this,class:this.classes(M.clearRouteButton,I.button,I.buttonTertiary),onclick:this._handleClearRouteClick,tabIndex:0,type:"button"},this.messages.clearRoute))}_getSections(){const{layer:e}=this.viewModel;if(!e)return null;const{directionPoints:t,directionLines:s,stops:i}=e;if(null==t||null==s)return null;const r=[];let o=null;for(const n of t){const{objectId:e,stopId:t}=n;if(null!=t){const e=i.find((({objectId:e})=>e===t)),s=0===r.length;null!=o&&o.stop===e||(o={stop:e,directions:[],open:s},r.push(o));continue}if(null==o)continue;const a=s.find((({directionPointId:t})=>t===e));null!=a&&o.directions.push({directionPoint:n,directionLine:a})}return r}_renderManeuverSections(){return null==this._sections?null:E("div",{class:M.maneuvers,role:"group"},this._sections.map(((e,t)=>{const{open:s}=e;let i;e.directions.length>0&&s&&(i=E("ol",{class:M.maneuverList},e.directions.map((e=>this._renderManeuver(e)))));const r=this._sections.length>2,o=t===this._sections.length-1,n={[M.collapsibleSection]:r},a={[L.down]:!s,[L.up]:s};let l;if(r&&!o){const t=s?this.messagesCommon.close:this.messagesCommon.open;l=E("header",{class:this.classes(M.maneuverSectionHeader,M.maneuverSectionToggle),key:M.maneuverSectionHeader},E("div",{"aria-expanded":s.toString(),"aria-label":t,bind:this,class:M.maneuverSectionHeaderButton,"data-maneuver-section":e,onclick:this._handleSectionToggle,onkeydown:this._handleSectionToggle,role:"button",tabIndex:0,title:t},E(P,{class:M.maneuverSectionTitle,level:this.headingLevel},e.stop.name),E("span",{"aria-hidden":"true",class:this.classes(a)})))}else l=E("header",{class:M.maneuverSectionHeader,key:M.maneuverSectionHeader},E(P,{class:M.maneuverSectionTitle,level:this.headingLevel},e.stop.name));return E("section",{class:this.classes(M.maneuverSection,n),key:t},l,i)})))}_handleSectionToggle(e){const t=Q(e.currentTarget);t&&(t.open=!t.open)}_renderCosts(){const e=this._getCostSummary(),{directionPoints:t}=this.viewModel.layer;if(null==t||null==e)return null;const{distance:s,duration:i}=e,{primaryCosts:r,secondaryCosts:o,zoomToRoute:n}=this.messages,a=this._renderEta();return E("div",{"aria-label":n,bind:this,class:M.directionCosts,onclick:this._handleSummaryInteraction,onkeydown:this._handleSummaryInteraction,role:"button",tabIndex:0,title:n},E("div",{class:M.costsDetails,role:"group"},E("div",{class:M.primaryCosts,title:r},i),E("div",{class:M.verticalSplitter}),E("div",{class:M.secondaryCosts,title:o},s)),a)}_renderEta(){const{directionPoints:e}=this.viewModel.layer,{eta:t}=this.messages;if(null==e)return null;const s=e.at(-1).arrivalTime,i=U("short-time");return s&&this._departureTimeOption!==f.UNSPECIFIED?E("div",{class:M.arrivalTimeContainer,title:t},E("span",{class:M.arrivalTime},O(s,i))," ",$(s)):null}_handleSummaryInteraction(){this._activeManeuver=null,this._focusedManeuver=null,this.viewModel.clearHighlights(),this.zoomToRoute()}_getErrorMessage(){switch(this.viewModel.lastError?.name){case"directions-view-model:unable-to-route":return this.messages.errors.unableToRoute;case"directions-view-model:service-metadata-unavailable":return this.messages.errors.unableToLoadServiceMetadata;default:return this.messages.errors.unknownError}}_normalizeSearchSources(e){this._overrideDefaultSources(e),this._applyLocatorSourceOverrides(e)}_overrideDefaultSources(e){e.viewModel.defaultSources.forEach((e=>{e.autoNavigate=!1}))}_applyLocatorSourceOverrides({allSources:e}){for(const t of e)"url"in t&&t.url&&(t.locationType??="street",T(t.url)&&this.apiKey&&null==t.apiKey&&(t.apiKey=this.apiKey,t.url=C))}_disposeSearch(e){if(!e||!this._stopsToSearches.has(e))return;const t=this._stopsToSearches.get(e);this.removeHandles(t),t.destroy(),this._stopsToSearches.delete(e)}_renderManeuver(e){const{directionPoint:t,directionLine:s}=e,{distance:i,duration:r}=s,{messages:o,messagesUnits:n,unit:a}=this,l=y(n,i??0,a),c=w(r??0),d=l&&c?`${l}&nbsp;&middot;&nbsp;${c}`:`${l}${c}`,u=this._getFormattedManeuverText(t),{objectId:h,directionPointType:p}=t,v=b(p),m=`esri-directions__maneuver-${h}`,_=`esri-directions__intermediate-costs-${h}`,g={[M.maneuverActive]:this._activeManeuver===s};return E("li",{"aria-labelledby":`${m} ${_}`,bind:this,class:this.classes(M.maneuver,g),"data-maneuver":s,key:s,onblur:this._handleManeuverBlur,onclick:this._handleManeuverClick,onfocus:this._handleManeuverFocus,onkeydown:this._handleManeuverClick,onmouseout:this._handleManeuverMouseOut,onmouseover:this._handleManeuverMouseOver,tabIndex:0},v?E("calcite-icon",{alt:"",class:M.maneuverIcon,icon:v}):null,E("div",{class:M.maneuverCostsContainer},E("span",{id:m,innerHTML:u??""}),E("div",{class:M.maneuverCosts},E("div",{class:M.horizontalSplitter}),E("div",{"aria-hidden":"true",class:M.intermediateCost,id:_,innerHTML:d,title:o.intermediateCosts}))))}_handleManeuverClick(e){const t=X(e.currentTarget);if(!t)return;if(this._activeManeuver===t)return this._activeManeuver=null,void this.zoomToRoute();this._activeManeuver=t;const{geometry:s}=t;this.viewModel.centerAt(s),this.viewModel.highlight(t)}_handleManeuverMouseOver(e){if(this._activeManeuver||this._focusedManeuver)return;const t=X(e.currentTarget);t&&this.viewModel.highlight(t)}_handleManeuverMouseOut(){this._activeManeuver||this._focusedManeuver||this.viewModel.clearHighlights()}_handleManeuverBlur(){this._activeManeuver||(this._focusedManeuver=null,this.viewModel.clearHighlights())}_handleManeuverFocus(e){if(this._activeManeuver)return;const t=X(e.currentTarget);t&&(this._focusedManeuver=t,this.viewModel.highlight(t))}_getFormattedManeuverText(e){const{displayText:t,name:s,intersectingName:i}=e;if(null==t)return"";let r=t;return null!=s&&r.includes(s)&&(r=r.replace(s,`<strong>${s}</strong>`)),null!=i&&r.includes(i)&&(r=r.replace(i,`<strong>${i}</strong>`)),r}_getCostSummary(){const{messagesUnits:e,unit:t,viewModel:s}=this,{routeInfo:i}=s.layer;if(null==i)return null;const r=i.totalDistance??0,o=i.totalDuration??0;return{distance:y(e,r,t),duration:w(o)}}async _getDirections(){const e=this.viewModel.layer?.stops.filter((({geometry:e})=>null!=e));if(e&&!(e.length<2))try{await this.viewModel.getDirections()}catch{}}};e([c()],q.prototype,"apiKey",null),e([c(h)],q.prototype,"defaultUnit",void 0),e([c()],q.prototype,"goToOverride",null),e([c()],q.prototype,"headingLevel",void 0),e([c()],q.prototype,"iconClass",void 0),e([c()],q.prototype,"icon",void 0),e([c()],q.prototype,"label",null),e([c({readOnly:!0})],q.prototype,"lastRoute",null),e([c()],q.prototype,"layer",null),e([c()],q.prototype,"maxStops",null),e([c(),A("esri/widgets/Directions/t9n/Directions")],q.prototype,"messages",void 0),e([c(),A("esri/t9n/common")],q.prototype,"messagesCommon",void 0),e([c(),A("esri/core/t9n/Units")],q.prototype,"messagesUnits",void 0),e([c()],q.prototype,"searchProperties",void 0),e([c()],q.prototype,"unit",null),e([c()],q.prototype,"view",null),e([c({type:g})],q.prototype,"viewModel",void 0),e([c()],q.prototype,"visibleElements",void 0),e([d("visibleElements")],q.prototype,"castVisibleElements",null),e([H()],q.prototype,"_handleStopIconClick",null),e([H()],q.prototype,"_handleClearRouteClick",null),e([H()],q.prototype,"_handleReverseStops",null),e([H()],q.prototype,"_handleRemoveStop",null),e([H()],q.prototype,"_handleSectionToggle",null),e([H()],q.prototype,"_handleSummaryInteraction",null),e([H()],q.prototype,"_handleManeuverClick",null),q=e([u("esri.widgets.Directions")],q);const G=q;function Y(e){return e?.["data-mode"]}function J(e){return e?.["data-stop-index"]}function Q(e){return e?.["data-maneuver-section"]}function X(e){return e?.["data-maneuver"]}export{G as default};
