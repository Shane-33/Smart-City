/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../../intl.js";import e from"../../../core/Error.js";import{clone as t}from"../../../core/lang.js";import r from"../../../core/Logger.js";import{getMetersPerUnitForSR as i}from"../../../core/unitUtils.js";import n from"../../../geometry/Polygon.js";import l from"../../../rest/support/FullTextSearch.js";import{createExtentFromGeometry as o,scaleExtent as s}from"./geometryUtils.js";import{substitute as u}from"../../../intl/substitute.js";import{formatDate as a}from"../../../intl/date.js";const c=/https?:\/\/services.*\.arcgis\.com/i,d=/(?:\{([^}]+)\})/g,f=r.getLogger("esri.widgets.Search.support.layerSearchUtils");function m(t,r){const{exactMatch:n=!1,location:l,maxResults:o,spatialReference:s,source:u,sourceIndex:a,suggestResult:c,view:d}=t,{layer:m,filter:p,zoomScale:T}=u,I=d?.scale,L=g(u,d),q=r?.signal;return h(m).then((()=>{const e=m.popupTemplate;return e?e.getRequiredFields(m.fieldsIndex):null})).then((t=>{const{objectIdField:r,returnZ:g}=m,h=b(u);if(!j(m,h))throw f.error("invalid-field: displayField is invalid."),new e("getResults():invalid-field","displayField is invalid.");const C=t&&t.length?t:[h],E=u.outFields||C,M=y(E);E.includes(r)||M||E.push(r),m.floorInfo?.floorField&&E.push(m.floorInfo.floorField);if(!(M||S(m,E)))throw f.error("invalid-field: outField is invalid."),new e("getResults():invalid-field","outField is invalid.");const A=m.createQuery(),{orderByFields:N}=u;if(N&&(A.orderByFields=N),s){A.outSpatialReference=s;const e=1/i(s);e&&(A.maxAllowableOffset=e)}const k="mesh"===m.geometryType||"multipatch"===m.geometryType,O=m.capabilities?.data?.supportsZ&&!k;if(A.returnZ=O&&!1!==g,A.returnGeometry=!0,A.multipatchOption=k?"xyFootprint":null,E&&(A.outFields=E),l)A.geometry=l;else if(c.key)A.objectIds=[c.key];else{const t=u.searchFields||[h];if(!S(m,t))throw f.error("invalid-field: search field is invalid."),new e("getResults():invalid-field","search field is invalid.");$(m)&&(A.num=o),L&&(A.geometry=L);const r=c.text?.trim();if(!r)return[];const i=c.text,{prefix:l="",suffix:s=""}=u,a=R(`${l}${i}${s}`);w(m)&&x(m,t)&&!n&&i&&(A.fullText=v({text:i,searchFields:t}));const d=D({searchTerm:a,layer:m,searchFields:t,filter:p,exactMatch:n,query:A,type:"search"});if(A.where=d,!F(A))return[]}return m.queryFeatures(A,{signal:q}).then((e=>V(e,d,u,a,h,I,T)))}))}function p(t,r){const{source:i,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=t,{layer:c,filter:m}=i,p=r?.signal,T=g(i,l);return h(c).then((()=>{if(!$(c))return[];const t=b(i),r=i.searchFields||[t],l=[];i.suggestionTemplate?i.suggestionTemplate.replaceAll(d,((e,t)=>(l.push(t),e))):l.push(t);const g=y(l);l.includes(c.objectIdField)||g||l.push(c.objectIdField);const h=j(c,t),I=g||S(c,l),L=S(c,r);if(!h)throw f.error("invalid-field: displayField is invalid."),new e("getSuggestions():invalid-field","displayField is invalid.");if(!I)throw f.error("invalid-field: outField is invalid."),new e("getSuggestions():invalid-field","outField is invalid.");if(!L)throw f.error("invalid-field: search field is invalid."),new e("getSuggestions():invalid-field","search field is invalid.");const q=c.createQuery(),{orderByFields:C}=i;C&&(q.orderByFields=C),q.outSpatialReference=n,q.returnGeometry=!1,q.num=s,q.outFields=l,T&&(q.geometry=T);if(!o.trim())return[];const{prefix:E="",suffix:M=""}=i,A=R(`${E}${o}${M}`);w(c)&&x(c,r)&&!a&&o&&(q.fullText=v({text:o,searchFields:r}));const N=D({searchTerm:A,layer:c,searchFields:r,filter:m,exactMatch:a,query:q,type:"suggest"});return q.where=N,F(q)?c.queryFeatures(q,{signal:p}).then((e=>O(e,i,u,t))):[]}))}function g(e,t){const{filter:r,withinViewEnabled:i}=e,n=t?.extent,l=r?.geometry;return l??(i&&n?n:void 0)}function y(e){return e&&e.includes("*")}async function h(e){e&&await e.load()}function F(e){return!(!e.fullText&&!e.where)}function x(e,t){const r=e?.indexes;if(!r||!t?.length)return!1;return r.filter((e=>"FullText"===e.indexType)).some((e=>{const r=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>r.includes(e.toLowerCase())))}))}function v({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new l({onFields:t,searchTerm:e,searchType:"prefix"})))}function w(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function $(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??""}function b(e){return e.displayField||e.layer.displayField||T(e.layer)}function S(e,t){return!(!e||!t?.length)&&t.every((t=>j(e,t)))}function j(e,t){return!!e.getField(t)}function I(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function L(e,t,r){let i=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=r?n:n.toLowerCase();return(r?t:t.toLowerCase())===l&&(i=e.code.toString(),!0)})),i}function R(e){return e.replaceAll("'","''")}function q(e,t){const r=t?.where;return r?`(${e}) AND (${r})`:e}function C({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const o=t?.type,s=t?.name;if("string"===o||"date"===o||"global-id"===o){const t=c.test(n??""),o=t&&I(e)?"N":"";if(i&&"search"===l)return q(`${s} = ${o}'${e}'`,r);if(t){return q(`${s} LIKE ${o}${`'${e}%'`}`,r)}return q(`${`LOWER(${s})`} LIKE ${o}${`'${e.toLowerCase()}%'`}`,r)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:q(`${s} = ${t}`,r)}return q(`${s} = ${e}`,r)}function E(e,t){return e?` OR (${t})`:`(${t})`}function D({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,query:l,type:o}){const{definitionExpression:s,url:u}=t;let a="";return!l.fullText&&e&&r&&r.forEach((r=>{const l=t.getField(r),s="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(s&&"coded-value"===s.type?L(s,e,n):null)||e||null;if(null!==c){const e=C({currentTerm:c,field:l,filter:i,exactMatch:n,url:u,type:o});e&&(a+=E(a,e))}})),s&&a?`(${s}) AND (${a})`:s||a}function M(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function A(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function N(e,t,r){const i=e.sourceLayer,{attributes:n}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return u(t,n);if(r&&n){const e=i.getField(r),t=A(n,r);return null==t?"":l&&"coded-value"===l.type?M(l,t)??"":"date"===e?.type?a(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function k(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=o?l[o]:null;return{text:N(e,t.suggestionTemplate,i),key:s,sourceIndex:r}}function O(e,t,r,i){return e.features.map((e=>k(e,t,r,i)))}function B(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}function U(e,r,i,l,u,a,c){const d=e.clone(),f=e.sourceLayer,m=f?.objectIdField,p=m?e.attributes[m]:null,g=N(e,i.searchTemplate,u);null!=a&&B(f)&&(f.minScale&&f.minScale<a?a=f.minScale:f.maxScale&&f.maxScale>a&&(a=f.maxScale));const y=o(d.geometry,r,a),h="number"==typeof c?s(t(y),r,c):y,F=e.clone();return null!=h&&(F.geometry=n.fromExtent(h)),{extent:h,target:F,feature:d,key:p,name:g,sourceIndex:l}}function V(e,t,r,i,n,l,o){return e.features.map((e=>U(e,t,r,i,n,l,o)))}export{v as createFullTextSearchInfos,m as getResults,p as getSuggestions};
