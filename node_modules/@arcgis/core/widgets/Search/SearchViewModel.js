/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{getAssetUrl as t}from"../../assets.js";import s from"../../config.js";import r from"../../Graphic.js";import o from"../../PopupTemplate.js";import"../../symbols.js";import i from"../../core/Accessor.js";import{isSome as l}from"../../core/arrayUtils.js";import a from"../../core/Collection.js";import n from"../../core/Error.js";import u from"../../core/Evented.js";import c from"../../core/Logger.js";import{eachAlways as h,after as p}from"../../core/promiseUtils.js";import{watch as g,whenOnce as d,initial as m}from"../../core/reactiveUtils.js";import{property as y}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/has.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import S from"../../geometry/Point.js";import _ from"../../geometry/SpatialReference.js";import{onLocaleChange as v}from"../../intl/locale.js";import{fetchMessageBundle as w}from"../../intl/messages.js";import b from"../../portal/Portal.js";import{highlightsSupported as x}from"../../views/support/layerViewUtils.js";import I from"./LayerSearchSource.js";import L from"./LocatorSearchSource.js";import T from"./SearchSource.js";import{getPointFromGeometry as R,getPointWithElevation as E}from"./support/geometryUtils.js";import{isArcGISWorldGeocoder as F,meteredArcGISLocatorUrl as j,isProxiedArcGISWorldGeocoder as P,isMeteredArcGISWorldGeocoder as C}from"./support/locatorUtils.js";import{supported as G,getCurrentPosition as O,positionToPoint as A}from"../support/geolocationUtils.js";import{GoToMixin as N}from"../support/GoTo.js";import D from"../../symbols/PictureMarkerSymbol.js";import M from"../../symbols/SimpleLineSymbol.js";import V from"../../symbols/SimpleFillSymbol.js";import k from"../../symbols/TextSymbol.js";function J(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}const H=()=>w("esri/widgets/Search/t9n/Search"),U="esri.widgets.Search.SearchViewModel",B=c.getLogger(U),Q="highlight",Z=a.ofType({key:e=>e.layer?"layer":"locator",base:T,typeMap:{layer:I,locator:L}}),q=_.WGS84,z="esri/images/search/search-symbol-32.png",K=/<[\s\S]*?>/g,W=-1;let X=class extends(N(u.EventedMixin(i))){constructor(e){super(e),this._gotoController=null,this._searching=null,this._updatingPromise=null,this._createdFeatureLayers=[],this.autoNavigate=!0,this.autoSelect=!0,this.defaultPopupTemplate=null,this.defaultSources=new Z,this.defaultSymbols={point:new D({url:t(z),size:24,width:24,height:24}),polyline:new M({color:[130,130,130,1],width:2}),polygon:new V({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})},this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=3,this.popupEnabled=!0,this.popupTemplate=null,this.portal=b.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new Z,this.suggestionDelay=350,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){const e=async()=>{const e=await H();this.messages=e,this.defaultPopupTemplate=new o({title:e.searchResult,content:"{Match_addr}"})};e(),this.addHandles([g((()=>[this.includeDefaultSources,this.view,this.portal]),(()=>this._update()),m),v(e)])}destroy(){this._destroyFeatureLayers(),this._abortGoTo(),this.clearGraphics()}get activeSource(){return this.allSources.at(this.activeSourceIndex)??null}get activeSourceIndex(){return 1===this.allSources.length||!this.searchAllEnabled?0:W}set activeSourceIndex(e){this._overrideIfSome("activeSourceIndex",e)}get allPlaceholder(){return this.messages?.allPlaceholder}set allPlaceholder(e){this._overrideIfSome("allPlaceholder",e)}get allSources(){const{sources:e,defaultSources:t,includeDefaultSources:s}=this,r="function"==typeof s?s.call(null,{sources:e,defaultSources:t}):s?t.concat(e):e,o=this._get("allSources")||new Z;return o.removeAll(),o.addMany(r.filter(Boolean)),o}get locationEnabled(){return this._get("locationEnabled")||G()}set locationEnabled(e){if(void 0===e)return void this._clearOverride("locationEnabled");const t=G();if(e&&!t){const e=new n("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});B.error(e)}this._override("locationEnabled",!!e&&t)}get placeholder(){const{allSources:e,activeSourceIndex:t,allPlaceholder:s}=this;if(t===W)return s??"";const r=e.at(t);return r?.placeholder??""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}get updating(){return null!=this._updatingPromise}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup();const{view:e,resultGraphic:t}=this;e&&t&&e.graphics.remove(t),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();const s=this._createSuggestionForSearch(e),r=(async()=>{try{await this.when();const e=await this._getResultsFromSources(s,t);if(t?.signal?.aborted)return null;const r={activeSourceIndex:this.activeSourceIndex,searchTerm:s.text??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(r,e,s);const o=this._getFirstResult(r.results),i=s.location&&o?o.name:s.text,l=i?.replace(K,"");return this._set("searchTerm",l),(s.key&&"number"==typeof s.sourceIndex||s.location)&&this._set("selectedSuggestion",s),this._set("results",r.results),this._set("resultCount",r.results.reduce(((e,t)=>e+(t.results?.length??0)),0)),this.emit("search-complete",r),await this._selectFirstResult(o),r}finally{this._clearSearching()}})();return this._searching=r,r}async searchNearby(e){if(!this.locationEnabled){const e=new n("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});throw B.error(e),e}const t=(async()=>{try{const t=await O(),s=await A({position:t,view:this.view},e);return await this.search(s,e)}finally{this._clearSearching()}})();return this._searching=t,t}async select(e){if(this.clearGraphics(),!e){const t=new n("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});throw B.error(t),t}const{view:t}=this,s=J(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),o=null!=s?this.allSources.at(s):null;if(!o){const e=new n("select:missing-source","Cannot select without a source.",{source:o});throw B.error(e),e}const i=o instanceof I?this._getLayerSourcePopupTemplate(o):o.popupTemplate,l=o.resultSymbol||this._getDefaultSymbol(e),a=J(o,"resultGraphicEnabled")?o.resultGraphicEnabled:this.resultGraphicEnabled,u=J(o,"autoNavigate")?o.autoNavigate:this.autoNavigate,c=(J(o,"popupEnabled")?o.popupEnabled:this.popupEnabled)?i||this.popupTemplate||this.defaultPopupTemplate:null,{feature:p}=e;if(!p){const e=new n("select:missing-feature","Cannot select without a feature.",{feature:p});throw B.error(e),e}const{attributes:g,geometry:d,layer:m,sourceLayer:y}=p,f=R(d),S={layerViewQuery:this._getLayerView(p),elevationQuery:t&&null!=f?E(f,t).catch((()=>f)):Promise.resolve(f)},_=await h(S),v=_.layerViewQuery.value,w=_.elevationQuery.value;l instanceof k&&(l.text=e.name);const b=t&&u?e.target||e.extent:null,L=null!=b?this._goToSearchResult(b):Promise.resolve();await L;const T=v?p:new r({geometry:d,symbol:l,attributes:g,layer:m,sourceLayer:y,popupTemplate:c}),F=t?.popup,j=F&&T.getEffectivePopupTemplate(F.defaultPopupTemplateEnabled);return j&&await t.openPopup({features:[T],location:w}),v&&x(v)&&!j&&this._highlightFeature({graphic:T,layerView:v}),!v&&a&&t&&t.graphics.push(T),this._setResultFloor(e),this._set("selectedResult",e),this._set("resultGraphic",T),this.emit("select-result",{result:e,source:o,sourceIndex:s}),e}async suggest(e,t,s){const r=e||this.searchTerm;this.emit("suggest-start",{searchTerm:r}),await this._suggestTimer(t,s);const o=await this._suggestImmediate(r,s);return this._set("suggestions",o?.results),this._set("suggestionCount",o?.results.reduce(((e,t)=>e+(t.results?.length??0)),0)??null),this.emit("suggest-complete",o),o}async when(){await d((()=>!this.updating))}async _update(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const s=this._updatingPromise=h([e?.load(),t?.when()]);if(this.destroyed)return;if(await s,s!==this._updatingPromise)return}await d((()=>this.messages)),this.destroyed||this._updateDefaultSources(),this._updatingPromise=null}_clearSearching(){this._searching=null}_convertHelperServices(){const e=this.portal?.helperServices?.geocode;if(!e)return[];return e.map((e=>{if(!1===e.placefinding)return;const t=s.apiKey&&F(e.url)?{url:j}:null,r=L.fromJSON({...e,...t}),o=r.url;if(F(o)||P(o)||C(o)){const e=r.outFields??["Addr_type","Match_addr","StAddr","City"],t=(r.placeholder||this.messages?.placeholder)??"",s="number"==typeof r.defaultZoomScale?r.defaultZoomScale:2500;r.singleLineFieldName="SingleLine",r.outFields=e,r.placeholder=t,r.defaultZoomScale=s}return r.singleLineFieldName?r:void 0})).filter(l)}_destroyFeatureLayers(){this._createdFeatureLayers.forEach((e=>e?.destroy())),this._createdFeatureLayers=[]}_getLayerSources(e,t){const s=this.view?.map;return e.map((e=>{const r=s.findLayerById(e.id);if(!r)return;const o=this._getLayerJSON(e),i=I.fromJSON(o);return i.placeholder=t,this._getLayer(r,o).then((e=>{i.layer=e})),i})).filter(l).toArray()}_getTableSources(e,t){const s=this.view?.map;return e.map((e=>{if(!e.id)return;const r=s.findTableById(e.id);if(!r)return;const o=this._getLayerJSON(e),i=I.fromJSON(o);return i.placeholder=t,this._getLayer(r,o).then((e=>{i.layer=e})),i})).filter(l).toArray()}_convertApplicationProperties(){const e=this.view?.map,t=e?.applicationProperties?.viewing?.search;if(!t)return[];const{enabled:s,hintText:r,layers:o,tables:i}=t;if(!s)return[];return[...this._getLayerSources(o,r),...this._getTableSources(i,r)]}async _getSubLayer(e,t){if(await e.load(),!e.allSublayers)throw new Error;const s=e.allSublayers.find((e=>e.id===t.subLayer));if(!s)throw new Error;const r=await(s.createFeatureLayer?.());if(!r)throw new Error;return this._createdFeatureLayers.push(r),r}async _getBuildingSubLayer(e,t){await e.load();const s=e.allSublayers.find((e=>e.id===t.subLayer));if("building-component"!==s?.type)throw new Error;if(await s.load(),null==s.associatedLayer)throw new Error;return await s.associatedLayer.load(),s}async _getLayer(e,t){if("feature"===e.type||"scene"===e.type||"csv"===e.type||"geojson"===e.type||"ogc-feature"===e.type)return e;if("map-image"===e.type)try{return await this._getSubLayer(e,t)}catch(s){const t=new n("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return B.error(t),null}return"building-scene"===e.type?this._getBuildingSubLayer(e,t):null}_getLayerJSON(e){return"function"==typeof e.toJSON?e.toJSON():e}_updateDefaultSources(){const{defaultSources:e,includeDefaultSources:t}=this;this._destroyFeatureLayers(),e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()])}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){const e=this.view?.popup,{resultGraphic:t}=this;if(!e||!t)return;const s="selectedFeature"in e,r=s?e.selectedFeature:null;s&&(r&&r===t)&&e.close()}_suggestTimer(e,t){const s=null!=e?e:this.suggestionDelay;return p(s,null,t?.signal)}_createLocationForSearch(e){return e instanceof r?R(e.geometry):e instanceof S?e:Array.isArray(e)&&2===e.length?new S({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&J(e,"key")&&J(e,"text")&&J(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),s="string"==typeof e?e:this.searchTerm,{selectedSuggestion:r,selectedResult:o}=this,i=!e&&r&&o,l=i&&r.key===o.key&&r.sourceIndex===o.sourceIndex,a=i&&r.location;return l||a?r:{location:t,text:t?"":s,sourceIndex:null,key:null}}_getFirstResult(e){let t=null;return e&&e.some((e=>{const{results:s}=e,r=s?.[0],o=!!r;return o&&(t=r),o})),t}async _selectFirstResult(e){return this.autoSelect&&e?this.select(e):null}async _suggestImmediate(e,t){await this.when();const s=await this._getSuggestionsFromSources(e,t);if(t?.signal?.aborted)return null;const r={activeSourceIndex:this.activeSourceIndex,searchTerm:e??"",numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(r,s),r}_formatSourceResponse(e,t,s){const r=t?.value||[],o=t?.error,i=this.allSources.at(s);if(o){const t={sourceIndex:s,source:i,error:o};e.errors.push(t),B.error(o),e.numErrors++}else{const t={sourceIndex:s,source:i,results:r};e.results.push(t),e.numResults+=r.length}}_formatResponse(e,t,s){if(t)if(e.activeSourceIndex===W){const r=s&&J(s,"sourceIndex")&&-1!==s.sourceIndex?s.sourceIndex:void 0;t.forEach(((t,s)=>{const o=void 0!==r?r:s;this._formatSourceResponse(e,t,o)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}async _getResultsFromSources(e,t){const{allSources:s}=this,r=!e.location&&J(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];if(!s.length){const e=new n("search:no-sources-defined","At least one source is required.",{allSources:s});throw B.error(e),e}return r===W?s.forEach(((s,r)=>{o.push(this._getResultsFromSource(e,r,t))})):o.push(this._getResultsFromSource(e,r,t)),h(o)}async _getSuggestionsFromSources(e,t){const{allSources:s,activeSourceIndex:r}=this,o=[];if(!s.length){const e=new n("suggest:no-sources-defined","At least one source is required.",{allSources:s});throw B.error(e),e}return r===W?s.forEach(((s,r)=>{o.push(this._getSuggestionsFromSource(e,r,t))})):o.push(this._getSuggestionsFromSource(e,r,t)),h(o)}async _getResultsFromSource(e,t,s){const r=null!=t?this.allSources.at(t):null;if(!r)return null;const{location:o=null}=e,i=this.view?.spatialReference||q,l=J(r,"maxResults")?r.maxResults:this.maxResults,a=!!(r instanceof I&&J(r,"exactMatch"))&&r.exactMatch,{view:n}=this;return r.getResults?.({view:n,sourceIndex:t,location:o,suggestResult:e,spatialReference:i,exactMatch:a,maxResults:l},s)}async _getSuggestionsFromSource(e,t,s){const r=this.allSources.at(t);if(!r)return null;e??="";const o=J(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,i=e?.length,l=J(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(o&&e.trim()&&i>=l){const o=this.view?.spatialReference||q,i=J(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,{view:l}=this,a=!!(r instanceof I&&J(r,"exactMatch"))&&r.exactMatch;return r.getSuggestions?.({view:l,sourceIndex:t,suggestTerm:e,spatialReference:o,maxSuggestions:i,exactMatch:a},s)}return null}_getLayerSourcePopupTemplate(e){const{layer:t}=e;if(t)return J(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){const t=this.results;if(!t)return null;let s=null;return t.some((t=>t.results.some((r=>r===e&&(s=t.sourceIndex,!0))))),s}async _goToSearchResult(e){this._abortGoTo();const t=new AbortController;this._gotoController=t;const s={target:{target:e},options:{signal:t.signal}};e||(s.options.animate=!1),await this.callGoTo(s),this._gotoController=null}_getDefaultSymbol(e){const{defaultSymbols:t}=this,s=e.feature?.geometry;if(null==s)return null;switch(s.type){case"point":case"multipoint":return t.point;case"polyline":return t.polyline;case"extent":case"polygon":return t.polygon;default:return null}}_removeHighlight(){this.removeHandles(Q)}async _getLayerView(e){const{view:t}=this;if(!e||!t||"building-component"===e.layer?.type||"subtype-sublayer"===e.layer?.type)return null;const{layer:s}=e;return s?(await t.when(),t.whenLayerView(s)):null}_highlightFeature(e){const{graphic:t,layerView:s}=e,{attributes:r,layer:o}=t,{objectIdField:i}=o,l=(i&&r?.[i])??null,a=s.highlight(l??t);this.addHandles(a,Q)}_setResultFloor(e){const{view:t}=this,s=e.feature?.attributes,r=e.feature?.sourceLayer;if(r&&"floorInfo"in r&&r?.floorInfo?.floorField&&s){const e=s[r.floorInfo.floorField];t?.emit("select-result-floor",e)}}};X.ALL_INDEX=W,e([y()],X.prototype,"_searching",void 0),e([y()],X.prototype,"_updatingPromise",void 0),e([y({readOnly:!0,value:null})],X.prototype,"activeSource",null),e([y()],X.prototype,"activeSourceIndex",null),e([y()],X.prototype,"allPlaceholder",null),e([y({readOnly:!0})],X.prototype,"allSources",null),e([y()],X.prototype,"autoNavigate",void 0),e([y()],X.prototype,"autoSelect",void 0),e([y()],X.prototype,"defaultPopupTemplate",void 0),e([y({readOnly:!0})],X.prototype,"defaultSources",void 0),e([y()],X.prototype,"defaultSymbols",void 0),e([y()],X.prototype,"includeDefaultSources",void 0),e([y()],X.prototype,"locationEnabled",null),e([y()],X.prototype,"maxInputLength",void 0),e([y()],X.prototype,"maxResults",void 0),e([y()],X.prototype,"maxSuggestions",void 0),e([y()],X.prototype,"messages",void 0),e([y()],X.prototype,"minSuggestCharacters",void 0),e([y({readOnly:!0})],X.prototype,"placeholder",null),e([y()],X.prototype,"popupEnabled",void 0),e([y({type:o})],X.prototype,"popupTemplate",void 0),e([y({type:b})],X.prototype,"portal",void 0),e([y()],X.prototype,"resultCount",void 0),e([y()],X.prototype,"resultGraphicEnabled",void 0),e([y({readOnly:!0})],X.prototype,"resultGraphic",void 0),e([y({readOnly:!0})],X.prototype,"results",void 0),e([y({readOnly:!0})],X.prototype,"selectedSuggestion",void 0),e([y()],X.prototype,"searchAllEnabled",void 0),e([y({readOnly:!0})],X.prototype,"selectedResult",void 0),e([y()],X.prototype,"searchTerm",null),e([y({type:Z})],X.prototype,"sources",void 0),e([y({readOnly:!0})],X.prototype,"state",null),e([y()],X.prototype,"suggestionDelay",void 0),e([y()],X.prototype,"suggestionCount",void 0),e([y({readOnly:!0})],X.prototype,"suggestions",void 0),e([y()],X.prototype,"suggestionsEnabled",void 0),e([y({readOnly:!0})],X.prototype,"updating",null),e([y()],X.prototype,"view",void 0),e([y()],X.prototype,"clear",null),X=e([f(U)],X);const Y=X;export{Y as default};
