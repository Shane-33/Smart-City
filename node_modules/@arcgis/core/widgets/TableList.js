/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import e from"../core/Collection.js";import{eventKey as s}from"../core/events.js";import{watch as i,on as o,initial as n}from"../core/reactiveUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{cast as a}from"../core/accessorSupport/decorators/cast.js";import"../core/arrayUtils.js";import"../core/has.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import c from"./Widget.js";import{globalCss as d}from"./support/globalCss.js";import{legacyIcon as m}from"./support/legacyIcon.js";import{accessibleHandler as u}from"./support/decorators/accessibleHandler.js";import{messageBundle as h}from"./support/decorators/messageBundle.js";import{vmEvent as g}from"./support/decorators/vmEvent.js";import{tsx as p}from"./support/jsxFactory.js";import"./support/widgetUtils.js";import _ from"./TableList/ListItem.js";import b from"./TableList/TableListViewModel.js";import{findSelectedItem as y}from"./TableList/support/tableListUtils.js";import I from"sortablejs";function v(t,e,s){t.splice(s,0,t.splice(e,1)[0])}const f=e.ofType(_),A="root-tables",S="data-layer-uid",w="layerUid",C="esri-table-list",T={base:C,widgetIcon:m.table,noItems:`${C}__no-items`,list:`${C}__list`,listRoot:`${C}__list--root`,item:`${C}__item`,itemChosen:`${C}__item--chosen`,itemMessage:`${C}__item--has-message`,itemSelectable:`${C}__item--selectable`,itemContainer:`${C}__item-container`,actionsMenu:`${C}__item-actions-menu`,actionsMenuItem:`${C}__item-actions-menu-item`,actionsMenuItemActive:`${C}__item-actions-menu-item--active`,actions:`${C}__item-actions`,actionsList:`${C}__item-actions-list`,action:`${C}__item-action`,actionIcon:`${C}__item-action-icon`,actionImage:`${C}__item-action-image`,actionTitle:`${C}__item-action-title`,actionToggle:`${C}__action-toggle`,actionToggleOn:`${C}__action-toggle--on`,message:`${C}__item-message`,title:`${C}__item-title`,publishing:`${C}__publishing`},$={actions:"actions",actionSection:"action-section",items:"items"};function M(t){const{actionsOpen:e}=t;e&&(t.actionsOpen=!1)}const k={statusIndicators:!0,errors:!1};let E=class extends c{constructor(t,e){super(t,e),this._sortable=null,this._sortableNode=null,this._focusSortUid=null,this.visibleItems=null,this.iconClass=T.widgetIcon,this.icon=null,this.messages=null,this.messagesCommon=null,this.multipleSelectionEnabled=!1,this.selectionEnabled=!1,this.selectedItems=new f,this.viewModel=new b,this.visibleElements={...k}}initialize(){this._setVisibleItems(this.tableItems),this.addHandles([i((()=>this.visibleElements),(()=>this._itemsChanged())),o((()=>this.viewModel.tableItems),"change",(()=>this._itemsChanged())),i((()=>this.selectionEnabled),(()=>this._toggleSorting()),n)])}destroy(){this._destroySortable()}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get listItemCreatedFunction(){return this.viewModel.listItemCreatedFunction}set listItemCreatedFunction(t){this.viewModel.listItemCreatedFunction=t}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get tableItems(){return this.viewModel.tableItems}castVisibleElements(t){return{...k,...t}}triggerAction(t,e){return this.viewModel.triggerAction(t,e)}render(){const{visibleItems:t}=this,e=this.viewModel?.state,s={[d.hidden]:"loading"===e,[d.disabled]:"disabled"===e};return p("div",{class:this.classes(T.base,d.widget,d.panel,s)},t?.length?this._renderList():this._renderNoItems())}_renderNoItems(){return p("div",{class:T.noItems},this.messages.noItemsToDisplay)}_renderList(){const{visibleItems:t,messages:e,selectionEnabled:s}=this;return p("ul",{afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"aria-label":e.widgetLabel,bind:this,class:this.classes(T.list,T.listRoot),"data-node-ref":"_sortableNode",role:s?"listbox":void 0},t?.map((t=>this._renderItem(t))).toArray())}_renderItem(t){const{id:e,selectionEnabled:s,selectedItems:i}=this,o=`${`${e}_${t.uid}`}__title`,n=this._hasMessage(t),r={[T.itemMessage]:!!n,[T.itemSelectable]:s};if(s){const e={[S]:t.layer?.uid};return p("li",{afterCreate:this._focusListItem,afterUpdate:this._focusListItem,"aria-labelledby":o,"aria-selected":y(t,i)?"true":"false",bind:this,class:this.classes(T.item,r),"data-item":t,key:`item-with-selection-${t.uid}`,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,role:"option",tabIndex:0,...e},this._renderItemContent(t,o))}return p("li",{afterCreate:this._focusListItem,afterUpdate:this._focusListItem,"aria-labelledby":o,bind:this,class:this.classes(T.item,r),key:`item-no-selection-${t.uid}`},this._renderItemContent(t,o))}_renderActionsMenuIcon(t,e){const{messagesCommon:s}=this,i={[T.actionsMenuItemActive]:t.actionsOpen};return p("div",{"aria-controls":e,"aria-label":s.options,bind:this,class:this.classes(T.actionsMenuItem,i),"data-item":t,key:"actions-menu-toggle",onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,role:"button",tabIndex:0,title:s.options},p("span",{"aria-hidden":"true",class:m.handleHorizontal}))}_renderActionsMenu(t,e,s,i){const o=1===s&&this._getSingleActionButton(e),n=o?this._renderAction({item:t,action:o,singleAction:!0}):null,r=!o&&s?this._renderActionsMenuIcon(t,i):null;return r||o?p("div",{class:T.actionsMenu,key:"actions-menu"},n,r):null}_renderItemMessage(t){return t.error?p("div",{class:T.message,key:"esri-table-list__error",role:"alert"},p("span",{"aria-hidden":"true",class:m.noticeTriangle}),this.messages.tableError):null}_renderItemStatus(t){const{visibleElements:e}=this;if(!e.statusIndicators)return null;const{publishing:s}=t;return p("span",{class:this.classes({[T.publishing]:s}),key:"layer-item-status"})}_renderItemContent(t,e){const{id:s}=this,i=`${`${s}_${t.uid}`}_actions`,o=this._filterActions(t.actionsSections),n=this._countActions(o);return[p("div",{class:T.itemContainer,key:"list-item-container"},this._renderTitle(t,e),this._renderItemStatus(t),this._renderActionsMenu(t,o,n,i)),this._renderItemMessage(t),n?this._renderActionsSections(t,o,i):null]}_renderTitle(t,e){const{messages:s}=this,i=t.title||s.untitledTable;return p("span",{class:T.title,id:e,key:"layer-title-container"},i)}_renderActionsSections(t,e,s){const i=e.toArray().map(((e,s)=>p("ul",{class:T.actionsList,key:`${t}-action-section-${s}`},this._renderActionSection(t,e))));return p("div",{"aria-expanded":t.actionsOpen?"true":"false",class:T.actions,hidden:!t.actionsOpen||null,id:s,key:"actions-section",role:"group"},i)}_renderActionSection(t,e){return(e&&e.toArray()).map((e=>this._renderAction({item:t,action:e})))}_renderActionIcon(t){const{active:e,className:s}=t,i=this._getIconImageStyles(t),o="button"!==t.type||t.image||s?s:m.defaultAction,n={[T.actionImage]:!e&&!!i["background-image"],[m.loadingIndicator]:e,[d.rotating]:e};return o&&!e&&(n[o]=!0),p("span",{"aria-hidden":"true",class:this.classes(T.actionIcon,n),key:"action-icon",styles:i})}_renderActionTitle(t,e){return e?null:p("span",{class:T.actionTitle,key:"action-title"},t)}_renderAction(t){const{item:e,action:s,singleAction:i}=t,{active:o,disabled:n,title:r}=s,a={[T.actionsMenuItem]:i&&"button"===s.type,[T.action]:o||!i&&"toggle"!==s.type,[T.actionToggle]:!o&&"toggle"===s.type,[T.actionToggleOn]:!o&&"toggle"===s.type&&s.value,[d.disabledElement]:n},l=[this._renderActionIcon(s),this._renderActionTitle(r,i)];return i?p("div",{"aria-label":r,bind:this,classes:a,"data-action":s,"data-item":e,key:`single-action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:0,title:r??void 0},l):p("li",{"aria-label":r,bind:this,classes:a,"data-action":s,"data-item":e,key:`action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:0,title:r??void 0},l)}_hasMessage(t){return!!t.error}_filterActions(t){return t.map((t=>t.filter((t=>t.visible))))}_setVisibleItems(t){this.visibleItems=t?.filter((t=>!t.hidden&&(this.visibleElements.errors||!t.error)))}_destroySortable(){const{_sortable:t}=this;t&&t.destroy(),this._sortable=null}_toggleSorting(){const{_sortable:t,_sortableNode:e,selectionEnabled:s}=this;if(e)if(t)t.option("disabled",!s);else{const t=I.create(e,{dataIdAttr:S,group:A,fallbackTolerance:4,disabled:!s,onSort:()=>this._sortTablesToItems(t.toArray()),chosenClass:T.itemChosen});this._sortable=t}}_sortNodeCreated(t){this._sortableNode=t,this._toggleSorting()}_sortTablesToItems(t){const e=this.map?.tables;e&&e.sort(((e,s)=>{const i=t.indexOf(e.uid),o=t.indexOf(s.uid);return i>o?-1:i<o?1:0}))}_getSingleActionButton(t){return t.reduce((t=>t)).filter((t=>t&&"button"===t.type)).at(0)}_focusListItem(t){const{_focusSortUid:e}=this;if(!t||!e)return;const s=O(t);s.layer?.uid===e&&(t.focus(),this._focusSortUid=null)}_watchActionSectionChanges(t){const e=()=>this.scheduleRender();this.addHandles(t.on("change",e),$.actionSection),t.forEach((t=>this._renderOnActionChanges(t)))}_renderOnActionChanges(t){const e=()=>this.scheduleRender();"toggle"!==t.type?"slider"!==t.type?this.addHandles(i((()=>[t.className,t.image,t.id,t.title,t.visible]),e,n),$.actions):this.addHandles(i((()=>[t.className,t.id,t.title,t.visible,t.value,t.displayValueEnabled,t.max,t.min,t.step]),e,n),$.actions):this.addHandles(i((()=>[t.className,t.image,t.id,t.title,t.visible,t.value]),e,n),$.actions)}_renderOnItemChanges(t){const e=()=>this.scheduleRender();this.addHandles([i((()=>[t.actionsOpen,t.title,t.error,t.publishing]),e,n),i((()=>[t.hidden,t.error]),(()=>this._setVisibleItems(this.tableItems))),t.actionsSections.on("change",e)],$.items),t.actionsSections.forEach((t=>this._watchActionSectionChanges(t)))}_itemsChanged(){const{tableItems:t}=this.viewModel;this._setVisibleItems(t),this.removeHandles($.actionSection),this.removeHandles($.actions),this.removeHandles($.items),t.forEach((t=>this._renderOnItemChanges(t))),this.scheduleRender()}_countActions(t){return t.reduce(((t,e)=>t+e.length),0)}_getIconImageStyles(t){const e="esri.support.Action.ActionButton"===t.declaredClass||"esri.support.Action.ActionToggle"===t.declaredClass?t.image:null;return{"background-image":e?`url("${e}")`:void 0}}_selectionKeydown(t){const e=["ArrowDown","ArrowUp"],i=s(t);if(!e.includes(i))return void this._toggleSelection(t);t.stopPropagation();const o=t.currentTarget["data-item"],{_sortable:n,selectedItems:r}=this;if(!n)return;const a=y(o,r),l=n.toArray(),c=t.target,d=l.indexOf(c.dataset[w]);if(-1!==d){if("ArrowDown"===i){const t=d+1;if(t>=l.length)return;a?(v(l,d,t),n.sort(l),this._sortTablesToItems(n.toArray()),this._focusSortUid=o.layer?.uid):(this._focusSortUid=o.layer?.uid,this.scheduleRender())}if("ArrowUp"===i){const t=d-1;if(t<=-1)return;a?(v(l,d,t),n.sort(l),this._sortTablesToItems(n.toArray()),this._focusSortUid=o.layer?.uid):(this._focusSortUid=o.layer?.uid,this.scheduleRender())}}}_toggleActionsOpen(t){const e=O(t.currentTarget),{actionsOpen:s}=e,i=!s;i&&this.tableItems.forEach((t=>M(t))),e.actionsOpen=i,t.stopPropagation()}_triggerAction(t){const e=t.currentTarget,s=j(e),i=O(e);"toggle"===s.type&&(s.value=!s.value),this.triggerAction(s,i),t.stopPropagation()}_toggleSelection(t){t.stopPropagation();const{multipleSelectionEnabled:e,selectedItems:s}=this,i=e&&(t.metaKey||t.ctrlKey),o=O(t.currentTarget),n=y(o,s),{length:r}=s;if(!i)return r&&!(n&&1===r)?(s.removeAll(),void s.add(o)):void(n?s.remove(n):s.add(o));n?s.remove(n):s.add(o)}get test(){return{visibleItems:this.visibleItems}}};function j(t){return t["data-action"]}function O(t){return t["data-item"]}t([r()],E.prototype,"visibleItems",void 0),t([r()],E.prototype,"iconClass",void 0),t([r()],E.prototype,"icon",void 0),t([r()],E.prototype,"label",null),t([r()],E.prototype,"listItemCreatedFunction",null),t([r()],E.prototype,"map",null),t([r(),h("esri/widgets/TableList/t9n/TableList")],E.prototype,"messages",void 0),t([r(),h("esri/t9n/common")],E.prototype,"messagesCommon",void 0),t([r()],E.prototype,"multipleSelectionEnabled",void 0),t([r()],E.prototype,"selectionEnabled",void 0),t([r()],E.prototype,"selectedItems",void 0),t([r({readOnly:!0})],E.prototype,"tableItems",null),t([g("trigger-action"),r({type:b})],E.prototype,"viewModel",void 0),t([r()],E.prototype,"visibleElements",void 0),t([a("visibleElements")],E.prototype,"castVisibleElements",null),t([u()],E.prototype,"_toggleActionsOpen",null),t([u()],E.prototype,"_triggerAction",null),t([u()],E.prototype,"_toggleSelection",null),E=t([l("esri.widgets.TableList")],E);const L=E;export{L as default};
