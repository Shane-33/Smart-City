/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../Graphic.js";import o from"../../../core/Accessor.js";import{watch as r,initial as n}from"../../../core/reactiveUtils.js";import{throttle as s}from"../../../core/throttle.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import p from"../../../popup/content/FieldsContent.js";import a from"../../../popup/content/MediaContent.js";import"../../../popup/content/RelationshipContent.js";import c from"../../../popup/content/TextContent.js";import m from"../../../popup/ElementExpressionInfo.js";import h from"../FeatureContent/FeatureContentViewModel.js";import d from"../FeatureFields/FeatureFieldsViewModel.js";import u from"../FeatureMedia/FeatureMediaViewModel.js";import{loadArcadeUtils as f,createCompiledExpression as y}from"../support/arcadeFeatureUtils.js";const _=1;let w=class extends o{constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new d:"media"===t?new u:"text"===t?new h:null;this._set("contentElementViewModel",e)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=s(this._compile,_,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:o,spatialReference:r,map:n,view:s,_abortController:i}=this;if(!(t&&e&&r&&n))return void this._set("contentElement",null);const l=await f();if(i!==this._abortController)return;const m=await y({arcadeUtils:l,expressionInfo:t,graphic:e,interceptor:o,map:n,spatialReference:r,view:s});if(!m||"esri.arcade.Dictionary"!==m.declaredClass)return void this._set("contentElement",null);const h=await m.castAsJsonAsync(i?.signal),d=h?.type,u="media"===d?a.fromJSON(h):"text"===d?c.fromJSON(h):"fields"===d?p.fromJSON(h):null;this._set("contentElement",u)},this.addHandles([r((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),n),r((()=>[this.contentElement]),(()=>this._createVM()),n)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:o}=this;return t?"loading":e||o?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}};t([i()],w.prototype,"_abortController",void 0),t([i({type:m})],w.prototype,"expressionInfo",void 0),t([i({type:e})],w.prototype,"graphic",void 0),t([i({readOnly:!0})],w.prototype,"contentElement",void 0),t([i({readOnly:!0})],w.prototype,"contentElementViewModel",void 0),t([i()],w.prototype,"interceptor",void 0),t([i()],w.prototype,"spatialReference",null),t([i({readOnly:!0})],w.prototype,"state",null),t([i()],w.prototype,"map",null),t([i()],w.prototype,"view",void 0),w=t([l("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],w);const j=w;export{j as default};
