/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../request.js";import{unique as t}from"../../../core/arrayUtils.js";import r from"../../../core/Error.js";import o from"../../../core/Logger.js";import{whenOrAbort as s,eachAlways as i}from"../../../core/promiseUtils.js";import{isNumericField as n}from"../../../layers/support/fieldUtils.js";import"../../../core/has.js";import"../../../layers/support/source/DataLayerSource.js";import{executeQueryJSON as l}from"../../../rest/query/executeQueryJSON.js";import"../../../config.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../core/unitUtils.js";import"../../../geometry/ellipsoidUtils.js";import"../../../geometry/support/spatialReferenceUtils.js";import"../../../layers/graphics/featureConversionUtils.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../geometry/Multipoint.js";import"../../../geometry/Point.js";import"../../../geometry/Polygon.js";import"../../../geometry/Polyline.js";import"../../../geometry/support/normalizeUtils.js";import"../../../core/pbf.js";import"../../../rest/support/FeatureSet.js";import a from"../../../rest/support/Query.js";import"../../../rest/query/support/AttachmentInfo.js";import"../../../rest/support/AttachmentQuery.js";import"../../../geometry.js";import u from"../../../rest/support/RelationshipQuery.js";import"../../../rest/support/TopFeaturesQuery.js";import p from"../../../rest/support/StatisticDefinition.js";import{isRelatedField as c}from"./featureUtils.js";const f="esri.widgets.Feature.support.relatedFeatureUtils",m=o.getLogger(f),d=new Map;function y(e){if(!c(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function j(e,t){if(!t.relationships)return null;let r=null;const{relationships:o}=t;return o.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function g({originRelationship:e,relationships:t,layerId:r}){let o=null;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e?.id&&(o=t),!!o))),o}function h(e,t){const r=t.toLowerCase();for(const o in e)if(o.toLowerCase()===r)return e[o];return null}function F(e,t){const r=j(e,t);if(!r)return;return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function I(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:o}=e,s=r?.value;t.relatedFeatures=s?s.features:[];const i=o?.value;t.relatedStatsFeatures=i?i.features:[]}function S(e,t,r,o){const s=new u;return s.outFields=["*"],s.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(s,o)??Promise.resolve({})}function w(e,t,r){let o=0;const s=[];for(;o<t.length;)s.push(`${e} IN (${t.slice(o,r+o)})`),o+=r;return s.join(" OR ")}function b(e){return e?t(e):void 0}function R(e){return e?t(e,((e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON()))):void 0}async function U(e,t,r,o){const s=r.layerId.toString(),{layerInfo:u,relation:p,relatedFields:c,outStatistics:f,url:m,sourceSpatialReference:d}=t,y=b(c),j=R(f);if(!u||!p)return null;const F=g({originRelationship:p,relationships:u.relationships,layerId:s});if(F?.relationshipTableId&&F.keyFieldInRelationshipTable){const t=(await S(e,F,r,o))[e.attributes[r.objectIdField]];if(!t)return null;const s=t.features.map((e=>e.attributes[u.objectIdField]));if(j?.length&&u.supportsStatistics){const e=new a;e.where=w(u.objectIdField,s,1e3),e.outFields=y,e.outStatistics=j,e.sourceSpatialReference=d;const r={features:Promise.resolve(t),statsFeatures:l(m,e)};return i(r)}}const I=F?.keyField;if(I){const t=n(q(u.fields,I)),r=h(e.attributes,p.keyField),s=t?`${I}=${r}`:`${I}='${r}'`,c=l(m,new a({where:s,outFields:y,sourceSpatialReference:d}),o),f=!!j?.length&&u.supportsStatistics?l(m,new a({where:s,outFields:y,outStatistics:j,sourceSpatialReference:d}),o):null,g={features:c};return f&&(g.statsFeatures=f),i(g)}return null}function $(t,r){return e(t,{query:{f:"json"},signal:r?.signal})}function v({relatedInfos:e,layer:t},o){const n={};return e.forEach(((e,o)=>{const{relation:s}=e;if(!s){const e=new r("relation-required","A relation is required on a layer to retrieve related records.");throw m.error(e),e}const{relatedTableId:i}=s;if("number"!=typeof i){const e=new r("A related table ID is required on a layer to retrieve related records.");throw m.error(e),e}const l=`${t.url}/${i}`,a=d.get(l),u=a??$(l);a||d.set(l,u),n[o]=u})),s(i(n),o)}function N({graphic:e,relatedInfos:t,layer:r},o){const s={};return t.forEach(((t,i)=>{t.layerInfo&&(s[i]=U(e,t,r,o))})),i(s)}function T({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const o=new p({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(o)}}function q(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}export{F as createRelatedInfo,g as getDestinationRelation,y as getRelatedFieldInfo,b as getUniqueOutFields,R as getUniqueOutStatistics,v as queryLayerInfos,N as queryRelatedFeatures,I as setRelatedFeatures,T as updateRelatedInfo};
