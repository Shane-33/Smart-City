/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{whenOrAbort as e,ignoreAbortErrors as r}from"../../../core/promiseUtils.js";import{getDisplayFieldName as t}from"../../../layers/support/fieldUtils.js";import{isFeatureLayer as s,isKnowledgeGraphLayer as n,isMapNotesLayer as a,isGraphicsLayer as i}from"../../../layers/support/layerUtils.js";import{calculateTolerance as o}from"../../../renderers/support/clickToleranceUtils.js";import{createQueryGeometry as l}from"../../../views/support/drapedUtils.js";import{isSelectableLayerView2D as c}from"../../../views/support/layerViewUtils.js";async function u(){return import("../../../geometry/geometryEngineJSON.js")}async function y(){return u().then((({contains:e,intersects:r,overlaps:t,simplify:s})=>({contains:e,intersects:r,overlaps:t,simplify:s})))}async function p(r){const{currentSelection:t,options:s,selector:n,signal:a,sources:i,view:o}=r;if(!i?.length)return{added:[],removed:[]};const{layers:l,layerViews:c,graphicsLayers:u}=g(i),y=(await e(Promise.all([f(n,l,o,a),m(n,c,o,a),d(n,u,s,o)]),a)).flat();if(!t)return{added:y,removed:[]};const p=y.filter((e=>v(t.toArray(),e))),h=t.filter((e=>v(y,e))).toArray();return t.removeMany(h),t.addMany(p),{added:p,removed:h}}const d=async(e,r,t,s)=>S({candidates:r.flatMap((e=>e.graphics.toArray()))??[],selector:e,options:t,view:s}),f=async(e,t,s,n)=>{const a=await r(w({selector:e,signal:n,layers:t,view:s}));return a?a.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)):[]},m=async(e,t,s,n)=>{const a=await r(h({selector:e,signal:n,layerViews:t,view:s}));return a?a.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)):[]};function g(e){const r=[],t=[],o=[];return e.forEach((e=>{s(e)?r.push(e):n(e)&&e.layers?.length?r.push(...e.layers.toArray()):a(e)&&e.sublayers?.length?o.push(...e.sublayers.toArray()):i(e)?o.push(e):c(e)&&t.push(e)})),{layers:r,layerViews:t,graphicsLayers:o}}function v(e,r){const t=e.includes(r),s=r.getObjectId(),n=null!=s,a=e.some((e=>{const t=r.layer===e.layer,a=n&&e.getObjectId()===s,i=r.uid===e.uid;return t&&(a||i)}));return!t&&!a}async function h(r){const{layerViews:t,selector:s,signal:n,view:a}=r;return e(Promise.allSettled(t.map((async e=>{const r=e.createQuery(),{outFields:t,geometry:i}=F(s,e.layer,a);return r.outFields=t,r.geometry=i,r.returnGeometry=!0,r.outSpatialReference=a.spatialReference,e.queryFeatures(r,{signal:n}).then((({features:e})=>e))}))),n)}async function w(r){const{layers:t,selector:s,signal:n,view:a}=r;return e(Promise.allSettled(t.map((async e=>e.queryFeatures(j(e.createQuery(),s,e,a),{signal:n}).then((({features:e})=>e))))),n)}function F(e,r,s){const n="displayField"in r?r.displayField:null,a=t({displayField:n,fields:r.fields}),i=[r.objectIdField];null!=a&&r.fieldsIndex.has(a)&&i.push(a);const c="renderer"in r?o({renderer:r.renderer}):0;return{geometry:"point"===e.type?l(e,c,s):e,outFields:i}}function j(e,r,t,s){const{outFields:n,geometry:a}=F(r,t,s);return e.outFields=n,e.geometry=a,e.returnGeometry=!0,e.outSpatialReference=s.spatialReference,e}async function S(e){const{selector:r,candidates:t,options:s,view:n}=e;if(!t?.length||!r||!s)return[];const{overlaps:a,intersects:i,contains:o}=s,{spatialReference:l}=n,c=r,u=await y();return t.filter((e=>{const r=e.geometry,t=a&&u.overlaps(l,c,r),s=i&&u.intersects(l,c,r),n=o&&u.contains(l,c,r);return t||s||n}))}export{y as getGeometryEngineOperations,F as getQueryOptionsFromLayer,h as getSelectionFromFeatureLayerViews,w as getSelectionFromFeatureLayers,p as getSelectionFromGeometry,S as getSelectionFromGeometryEngine,u as importGeometryEngine};
