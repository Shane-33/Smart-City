/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import"../../../../intl.js";import{memoize as e}from"../../../../core/memoize.js";import{formatAngle as i,formatArea as o,formatLength as s,formatRelativeLength as r,formatVerticalLength as n,formatRelativeVerticalLength as a}from"../../../../core/quantityFormatUtils.js";import{watch as l,on as p}from"../../../../core/reactiveUtils.js";import{unitName as m}from"../../../../core/unitFormatUtils.js";import{defaultLengthUnit as c,defaultVerticalLengthUnit as h,defaultAreaUnit as u}from"../../../../core/unitUtils.js";import{property as g}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as f}from"../../../../core/accessorSupport/decorators/subclass.js";import{getDefaultUnitForView as d}from"../../../../support/getDefaultUnitForView.js";import{tooltipKeys as _}from"../../keybindings.js";import v from"../../../../widgets/Widget.js";import{loadCalciteComponents as y}from"../../../../widgets/support/componentsUtils.js";import"../../../../widgets/support/widgetUtils.js";import{messageBundle as j}from"../../../../widgets/support/decorators/messageBundle.js";import{formatNumber as b}from"../../../../intl/number.js";let U=class extends v{constructor(){super(...arguments),this._getFormatters=e(((t,e)=>({angle:t=>i(t,t.rotationType),area:(i,s)=>o(t,i,s??e.area),length:(i,o,r)=>s(t,i,o??e.length,r),relativeLength:(i,o)=>r(t,i,o??e.length),totalLength:(i,o)=>s(t,i,o??e.length),verticalLength:(i,o)=>n(t,i,o??e.length),relativeVerticalLength:(i,o)=>a(t,i,o??e.verticalLength),relativeOrientation:t=>b(t,{maximumFractionDigits:2,minimumFractionDigits:2,signDisplay:"exceptZero"}),percentage:t=>b(t.value,{style:"percent"}),scale:t=>b(t,{style:"percent",maximumFractionDigits:0})}))),this._formatScale=t=>this._formatters.scale(t),this._formatRelativeOrientation=t=>this._formatters.relativeOrientation(t),this._formatLength=(t,e,i)=>this._formatters.length(t,e,i),this._formatRelativeLength=(t,e)=>this._formatters.relativeLength(t,e),this._formatVerticalLength=(t,e)=>this._formatters.verticalLength(t,e),this._formatRelativeVerticalLength=(t,e)=>this._formatters.relativeVerticalLength(t,e),this._formatArea=(t,e)=>this._formatters.area(t,e),this._formatPercentage=t=>this._formatters.percentage(t),this._onDiscard=()=>{this._exitInputMode()},this._onCommit=(t,e)=>{if("commit-and-exit"===e)return this._exitInputMode();const i=this._getFocusableInputs(),o=i.length,s=i.indexOf(t);if(-1===s)return this._exitInputMode();const r=((s+("commit-and-next"===e?1:-1))%o+o)%o;i.at(r)?.focus()},this._handleTab=t=>{if(t.code!==_.next)return;const e=this._getFocusableInputs();if(0===e.length)return;const i=e.at(0),o=e.at(-1);i&&o&&(t.shiftKey?document.activeElement===i&&(t.preventDefault(),o.focus()):document.activeElement===o&&(t.preventDefault(),i.focus()))}}get _displayUnits(){const t=d(this.tooltip.view);return{length:t,verticalLength:t,area:t,angle:"degrees"}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:m(t,e,"abbr")}),i=d(this.tooltip.view),o=c(i),s=h(i),r=u(i),n="degrees";return{length:e(o),relativeLength:e(o),verticalLength:e(s),relativeVerticalLength:e(s),area:e(r),orientation:e(n),rotation:e(n)}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,onCommit:this._onCommit,onDiscard:this._onDiscard}}initialize(){let t=new AbortController;this.addHandles([l((()=>this.info.mode),(t=>{this.tooltip.positionMode="input"===t?"fixed":"follow-cursor"})),p((()=>this.info),"focus",(()=>{t?.abort();const{signal:e}=t=new AbortController;requestAnimationFrame((()=>{e.aborted||this._getFocusableInputs().at(0)?.focus()}))}))])}loadDependencies(){return y({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),input:()=>import("@esri/calcite-components/dist/components/calcite-input.js")})}_getHelpMessage(t){const{info:e}=this,{tooltipOptions:i,helpMessage:o,viewType:s}=e,r=i?.visibleElements?.helpMessage,n=t??o,a="3d"===s?"helpMessages3d":"helpMessages2d";return r&&n?this._messagesTooltip?.sketch?.[a]?.[n]:void 0}_exitInputMode(){this.info.exitInputMode(),document.querySelector(".esri-view-surface").focus()}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("input:not([disabled])")??[])}};t([j("esri/core/t9n/Units"),g()],U.prototype,"_messagesUnits",void 0),t([j("esri/views/interactive/tooltip/t9n/Tooltip"),g()],U.prototype,"_messagesTooltip",void 0),t([g()],U.prototype,"info",void 0),t([g()],U.prototype,"tooltip",void 0),t([g()],U.prototype,"_displayUnits",null),t([g()],U.prototype,"_inputUnitInfos",null),t([g()],U.prototype,"_formatters",null),t([g()],U.prototype,"fieldContext",null),U=t([f("esri.views.interactive.tooltip.content.TooltipContent")],U);export{U as TooltipContent};
