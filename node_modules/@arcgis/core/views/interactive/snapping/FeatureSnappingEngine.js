/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import{destroyHandle as r}from"../../../core/handleUtils.js";import{allSettledValues as n,throwIfAborted as a}from"../../../core/promiseUtils.js";import{mapCollectionAsync as s}from"../../../core/reactiveUtils.js";import{getMetersPerUnitForSR as o,getMetersPerVerticalUnitForSR as i}from"../../../core/unitUtils.js";import{property as c}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as u}from"../../../core/accessorSupport/decorators/subclass.js";import{k as p}from"../../../chunks/vec2.js";import{a as l,c as d}from"../../../chunks/vec3.js";import{c as S}from"../../../chunks/vec3f64.js";import{g as m}from"../../../chunks/common.js";import{UpdatingHandles as h}from"../../../core/support/UpdatingHandles.js";import{absoluteHeightElevationInfo as g}from"../../../support/elevationInfoUtils.js";import{VerticalHalfPlaneConstraint as f}from"../sketch/constraints.js";import{fromAnyMapPoint as y}from"../sketch/normalizedPoint.js";import{FeatureSnappingSourceInfo as _}from"./FeatureSnappingSourceInfo.js";import{SnappingDomain as v}from"./SnappingDomain.js";import{sortCandidatesInPlace as w,screenDistance as j}from"./snappingUtils.js";import{DrapedEdgeSnappingCandidate as F}from"./candidates/DrapedEdgeSnappingCandidate.js";import{EdgeSnappingCandidate as C}from"./candidates/EdgeSnappingCandidate.js";import{FeatureSnappingCandidate as x}from"./candidates/FeatureSnappingCandidate.js";import{RightAngleSnappingCandidate as R,OtherVertexType as b}from"./candidates/RightAngleSnappingCandidate.js";import{vectorToScreenPoint as M}from"../support/viewUtils.js";let I=class extends t{get updating(){return this._snappingSources.some((e=>null==e||e.valid&&e.snappingSource.updating))||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=v.FEATURE,this._updatingHandles=new h,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=s((()=>this.options?.featureSources),((e,t)=>this._createSourceInfo(e,t)));this._snappingSources=e,this.addHandles(r(e))}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,r,s){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const o=[],i=this._computeScreenSizeDistanceParameters(e,r);for(const n of this._snappingSources){if(null==n||!n.valid||!n.snappingSource.layerSource.enabled||n.layerView?.suspended)continue;const t=n.getFetchCandidatesParameters(e,r,i);for(const e of t)o.push(n.snappingSource.fetchCandidates(e,s).then((e=>e.filter((e=>!this._candidateIsExcluded(n.snappingSource,e,r.excludeFeature))))))}const c=(await n(o)).flat();return this._addRightAngleCandidates(c,e,i,r),a(s),w(e,c),c}_addRightAngleCandidates(e,t,r,n){const a=null!=n.vertexHandle?n.vertexHandle.rightEdge?.rightVertex?.pos:null!=n.editGeometryOperations&&"polygon"===n.editGeometryOperations.data.type?n.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,s=null!=n.vertexHandle?n.vertexHandle.leftEdge?.leftVertex?.pos:null!=n.editGeometryOperations?n.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:o}=this,i=y(a,o,n),c=y(s,o,n),u=e.length;for(let p=0;p<u;p++)this._addRightAngleCandidate(e[p],c,t,r,e),this._addRightAngleCandidate(e[p],i,t,r,e)}_addRightAngleCandidate(e,t,r,n,a){if(null==t||!L(e))return;const s=e.constraint.closestTo(t),o=(s[0]-r[0])/n.x,i=(s[1]-r[1])/n.y,{start:c,end:u}=e.constraint;if(o*o+i*i<=1){const r=new R({targetPoint:s,otherVertex:t,otherVertexType:b.NEXT,previousVertex:p(s,c)>p(s,u)?c:u,constraint:new f(t,s),objectId:e.objectId,isDraped:e.isDraped});a.push(r)}}_computeScreenSizeDistanceParameters(e,t){let r=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:r,y:r,z:r,distance:r}:"2d"===this.view.type?(r*=this.view.resolution,{x:r,y:r,z:r,distance:r}):this._computeScreenSizeDistanceParameters3D(e,r,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,r,n){const{spatialReference:a}=n;r.renderCoordsHelper.toRenderCoords(e,a,P);const s=r.state.camera.computeScreenPixelSizeAt(P),c=s*r.renderCoordsHelper.unitInMeters,u=c/o(a),p=c/i(a),l=t*u,d=t*p,S=M(e,a,g,r),m=S?H(S,e,u,0,0,r,n):0,h=S?H(S,e,0,u,0,r,n):0,f=S?H(S,e,0,0,p,r,n):0;return{x:0===m?0:l/m,y:0===h?0:l/h,z:0===f?0:d/f,distance:s*t}}_candidateIsExcluded(e,t,r){if(null==r)return!1;const n=this._getCandidateObjectId(t);if(null==n)return!1;const a=e.layerSource.layer;return"graphics"===a.type?r.uid===n:r.sourceLayer===a&&(!(!r.attributes||!("objectIdField"in a))&&r.attributes[a.objectIdField]===n)}_getCandidateObjectId(e){return e instanceof x?e.objectId:null}async _createSourceInfo(e,t){const r=e.layer;r.loaded||(await r.load(),a(t));const{view:n}=this,s=await this._createFeatureSnappingSourceType(e);return a(t),new _(null==s?{}:{snappingSource:s,view:n,layer:r})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;if(null==t||"3d"!==t.type)return null;return new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":if("mesh"===e.layer.geometryType)return null;return new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),r={module:null,loader:t};this._sourceModules[e]=r;const n=await t,a={module:n,loader:t};return this._sourceModules[e]=a,n}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(import("./featureSources/FeatureServiceSnappingSource.js"));case"featureCollection":return t.addPromise(import("./featureSources/FeatureCollectionSnappingSource.js"));case"graphics":case"notes":return t.addPromise(import("./featureSources/GraphicsSnappingSource.js"));case"scene":return t.addPromise(import("./featureSources/SceneLayerSnappingSource.js"))}}get test(){return{snappingSources:this._snappingSources}}};function L(e){return(e instanceof C||e instanceof F)&&!G(e)}function G({constraint:{start:e,end:t}}){const r=l(e,t),n=p(e,t);return r<m()||n/r<z}function H(e,t,r,n,a,s,{spatialReference:o}){const i=d(E,t);i[0]+=r,i[1]+=n,i[2]+=a;const c=M(i,o,g,s);return c?j(c,e):1/0}e([c({constructOnly:!0})],I.prototype,"spatialReference",void 0),e([c({constructOnly:!0})],I.prototype,"view",void 0),e([c()],I.prototype,"options",void 0),e([c({readOnly:!0})],I.prototype,"updating",null),e([c()],I.prototype,"_snappingSources",void 0),I=e([u("esri.views.interactive.snapping.FeatureSnappingEngine")],I);const P=S(),E=S(),z=1e-4;export{I as FeatureSnappingEngine};
