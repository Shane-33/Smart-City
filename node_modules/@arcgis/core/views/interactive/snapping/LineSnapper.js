/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{absoluteHeightElevationInfo as e}from"../../../support/elevationInfoUtils.js";import{fromAnyMapPoint as t,fromVec3 as s}from"../sketch/normalizedPoint.js";import{SnappingAlgorithm as r}from"./SnappingAlgorithm.js";import{editEdgeToSnappingEdge as i,squaredScreenDistance as o}from"./snappingUtils.js";import{LineSnappingCandidate as n}from"./candidates/LineSnappingCandidate.js";import{vectorToScreenPoint as d}from"../support/viewUtils.js";import{projectPointToLineLike as p}from"../../support/geometry3dUtils.js";import{LineType as h}from"../../support/geometry2dUtils.js";class a extends r{snapNewVertex(t,s){const r=s.editGeometryOperations.data.components[0],o=r.edges.length,n=[];if(o<1)return n;const{spatialReference:p}=s,h=d(t,p,e,this.view),{view:a}=this,l=r.edges[o-1];let g=l;do{if(this.edgeExceedsShortLineThreshold(g,s)){const e=i(g,a,s);this._processCandidateProposal(e.left,e.right,t,h,s,n)}g=g.leftVertex.leftEdge}while(g&&g!==l);return n}snapExistingVertex(s,r){const o=[],n=r.vertexHandle,p=n.component;if(p.edges.length<2)return o;const{view:h}=this,{spatialReference:a}=r,l=d(s,a,e,h),g=n.leftEdge,m=n.rightEdge;g&&m&&this.edgeExceedsShortLineThreshold(g,r)&&this.edgeExceedsShortLineThreshold(m,r)&&this._processCandidateProposal(t(g.leftVertex.pos,h,r),t(m.rightVertex.pos,h,r),s,l,r,o);const c=p.edges[0];let f=c;do{if(f!==n.leftEdge&&f!==n.rightEdge&&this.edgeExceedsShortLineThreshold(f,r)){const e=i(f,h,r);this._processCandidateProposal(e.left,e.right,s,l,r,o)}f=f.rightVertex.rightEdge}while(f&&f!==c);return o}_processCandidateProposal(t,r,i,a,l,g){const{spatialReference:m,pointer:c}=l,f=s(p(i,{start:t,end:r,type:h.LINE}));o(a,d(f,m,e,this.view))<this.squaredProximityThreshold(c)&&g.push(new n({lineStart:t,lineEnd:r,targetPoint:f,isDraped:"on-the-ground"===l.elevationInfo?.mode}))}}export{a as LineSnapper};
