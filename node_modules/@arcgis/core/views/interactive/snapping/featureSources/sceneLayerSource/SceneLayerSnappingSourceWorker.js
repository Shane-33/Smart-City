/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{throwIfAborted as t}from"../../../../../core/promiseUtils.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/Error.js";import{subclass as s}from"../../../../../core/accessorSupport/decorators/subclass.js";import{g as o,o as n}from"../../../../../chunks/vec3.js";import{c as i,g as r}from"../../../../../chunks/vec3f64.js";import{create as d,fromPoints as c,projectPoint as a}from"../../../../../geometry/support/lineSegment.js";import{g as p,n as u}from"../../../../../chunks/sphere.js";import h from"../../../../3d/webgl-engine/lib/Octree.js";import{extractComponentsEdgeLocationsLayout as m}from"../../../../3d/webgl-engine/lib/edgeRendering/edgeProcessing.js";import{maxCandidateCount as g,boundsFromEdge as l}from"./sceneLayerSnappingUtils.js";let _=class{constructor(){this._idToComponent=new Map,this._components=new h((e=>e.bounds)),this._edges=new h((e=>e.bounds)),this._tmpLineSegment=d(),this._tmpP1=i(),this._tmpP2=i(),this._tmpP3=i(),this.remoteClient=null}async fetchCandidates(e,s){await Promise.resolve(),t(s),await this._ensureEdgeLocations(e,s);const o=[];return this._edges.forEachNeighbor((t=>(this._addCandidates(e,t,o),o.length<g)),e.bounds),{result:{candidates:o}}}async _ensureEdgeLocations(e,t){const s=[];if(this._components.forEachNeighbor((e=>{if(null==e.info){const{id:t,uid:o}=e;s.push({id:t,uid:o})}return!0}),e.bounds),!s.length)return;const o={components:s},n=await this.remoteClient.invoke("fetchAllEdgeLocations",o,t??{});for(const i of n.components)this._setFetchEdgeLocations(i)}async add(e){const t=new b(e.id,e.bounds);return this._idToComponent.set(t.id,t),this._components.add([t]),{result:{}}}async remove(e){const t=this._idToComponent.get(e.id);if(t){const e=[];this._edges.forEachNeighbor((s=>(s.component===t&&e.push(s),!0)),t.bounds),this._edges.remove(e),this._components.remove([t]),this._idToComponent.delete(t.id)}return{result:{}}}_setFetchEdgeLocations(e){const t=this._idToComponent.get(e.id);if(null==t||e.uid!==t.uid)return;const s=m.createView(e.locations),o=new Array(s.count),n=i(),r=i();for(let i=0;i<s.count;i++){s.position0.getVec(i,n),s.position1.getVec(i,r);const d=l(n,r,e.origin),c=new j(t,i,d);o[i]=c}this._edges.add(o);const{objectIds:d,origin:c}=e;t.info={locations:s,objectIds:d,origin:c}}_addCandidates(e,t,s){const{info:n}=t.component,{origin:i,objectIds:r}=n,d=n.locations,c=d.position0.getVec(t.index,this._tmpP1),a=d.position1.getVec(t.index,this._tmpP2);o(c,c,i),o(a,a,i);const p=r[d.componentIndex.get(t.index)];this._addEdgeCandidate(e,p,c,a,s),this._addVertexCandidate(e,p,c,s),this._addVertexCandidate(e,p,a,s)}_addEdgeCandidate(e,t,s,o,i){if(!e.returnEdge)return;const d=p(e.bounds),h=c(s,o,this._tmpLineSegment),m=a(h,d,this._tmpP3);u(e.bounds,m)&&i.push({type:"edge",objectId:t,target:r(m),distance:n(d,m),start:r(s),end:r(o)})}_addVertexCandidate(e,t,s,o){if(!e.returnVertex)return;const i=p(e.bounds);u(e.bounds,s)&&o.push({type:"vertex",objectId:t,target:r(s),distance:n(i,s)})}};_=e([s("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],_);const f=_;class b{constructor(e,t){this.id=e,this.bounds=t,this.info=null,this.uid=++b.uid}}b.uid=0;class j{constructor(e,t,s){this.component=e,this.index=t,this.bounds=s}}export{f as default};
