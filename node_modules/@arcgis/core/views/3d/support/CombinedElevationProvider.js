/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import r from"../../../core/Evented.js";import{destroyMaybe as s}from"../../../core/maybe.js";import{throwIfAbortError as o}from"../../../core/promiseUtils.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as n}from"../../../core/accessorSupport/decorators/subclass.js";import a from"../../../geometry/SpatialReference.js";import{equals as l}from"../../../geometry/support/spatialReferenceUtils.js";import{ElevationQuery as c}from"../layers/graphics/ElevationQuery.js";let u=class extends(r.EventedMixin(t)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=s(this._elevationQueryCached)}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,r,s,o){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const i=this.lastElevationQuery;if(e===i.x&&t===i.y&&r===i.z&&l(s,i.spatialReference)&&o===i.queryContext)return i.result}let i=null;return i=h(i,this._im,e,t,r,s,o),null==i&&(i=h(i,this._ground,e,t,r,s,o)),"scene"===o&&(i=h(i,this._scene,e,t,r,s,o)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:s,queryContext:o,result:i}),i}getSphereElevationBounds(e,t){let r=1/0,s=-1/0;for(const o of[this._im,this._ground,this._scene])o.forEach((o=>{if(o.getSphereElevationBounds){const i=o.getSphereElevationBounds(e,t);null!=i&&(r=Math.min(r,i.min),s=Math.max(s,i.max))}}));return{min:r,max:s}}getRootElevationBounds(){let e=1/0,t=-1/0;for(const r of[this._im,this._ground,this._scene])r.forEach((r=>{if(r.getRootElevationBounds){const s=r.getRootElevationBounds();null!=s&&(e=Math.min(e,s.min),t=Math.max(t,s.max))}}));return{min:e,max:t}}async queryElevation(e,t,r,s,i,n=null,a=0){const l=this._getElevationQuery(s);try{const o=await l.queryElevation(e,t,n,a);return"scene"===i?h(o,this._scene,e,t,r,s,i):o}catch(c){return o(c),this.getElevation(e,t,r,s,i)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._elevationQueryCached;if(null!=t&&l(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:r,wkt:s,wkt2:o,latestWkid:i}=e,n=new c(this.view.resourceController.scheduler,new a({wkid:r,wkt:s,wkt2:o,latestWkid:i}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._elevationQueryCached=n,n}};function h(e,t,r,s,o,i,n){for(const a of t){const t=a.getElevation(r,s,o,i,n);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e([i({constructOnly:!0})],u.prototype,"view",void 0),e([i()],u.prototype,"spatialReference",null),u=e([n("esri.views.3d.support.CombinedElevationProvider")],u);export{u as CombinedElevationProvider};
