/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{lerp as t,clamp as e}from"../../../core/mathUtils.js";import{c as i,g as n,r as o,n as a,o as l}from"../../../chunks/mat4.js";import{a as s}from"../../../chunks/mat4f64.js";import{j as c,l as r}from"../../../chunks/vec2.js";import{f as u,a as m}from"../../../chunks/vec2f64.js";import{s as g,p as h,n as d,i as f,e as b,g as y,c as p}from"../../../chunks/vec3.js";import{f as A,c as w,g as N}from"../../../chunks/vec3f64.js";import{ViewingMode as v}from"../../ViewingMode.js";import{S as T}from"../../../chunks/SunCalc.js";import{angle as M}from"./mathUtils.js";const j={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class x{constructor(t,e){this.direct=t,this.ambient=e}}function S(i,n,o,a,l,s){g(s.ambient.color,1,1,1),s.ambient.intensity=j.global.ambient,g(s.direct.color,1,1,1),s.direct.intensity=j.global.direct;const c=n[2],r=e((Math.abs(c)-j.local.altitude)/(j.global.altitude-j.local.altitude),0,1);let u;if(s.globalFactor=r,null!=i&&(u=T.getTimes(i,n[1],n[0])),r<1){let e;if(null!=i)e=nt(i,u,a);else{const t=F(a);e={direct:{intensity:j.local.directAtNoon*t.direct,color:A(1,1,1)},ambient:{intensity:j.local.ambientAtNoon*t.ambient,color:A(1,1,1)},timeOfDay:"early afternoon"}}h(s.ambient.color,e.ambient.color,s.ambient.color,r),s.ambient.intensity=t(e.ambient.intensity,s.ambient.intensity,r),h(s.direct.color,e.direct.color,s.direct.color,r),s.direct.intensity=t(e.direct.intensity,s.direct.intensity,r),s.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,s.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}s.noonFactor=null!=i?H(i,u):1,null!=i?P(i,n,o,s.direct.directionToLightSource):O(l,o,s.direct.directionToLightSource)}function O(t,e,n){e===v.Global?d(lt,t.eye):g(lt,0,0,1),f(st,t.viewForward,-1);const o=M(st,lt),a=Math.max(o-2*rt,0),l=.85*a/(a+1),s=Math.max(rt,o-rt-l);i(at,-s,t.viewRight),b(n,st,at),y(n,n,f(ct,t.viewRight,ut)),d(n,n)}function P(t,i,s,c){const r=G,u=n(I);if(s===v.Global)T.getPosition(t,0,0,r),g(c,0,0,-1),o(u,u,-r.azimuth),a(u,u,-r.altitude),b(c,c,u);else{const n=j.planarDirection,a=n.globalAngles,s=i[2];let m=(Math.abs(s)-n.localAltitude)/(n.globalAltitude-n.localAltitude);m=e(m,0,1),m<1?(T.getPosition(t,i[1],i[0],r),r.azimuth=(1-m)*r.azimuth+m*a.azimuth,r.altitude=(1-m)*r.altitude+m*a.altitude):(r.azimuth=a.azimuth,r.altitude=a.altitude),g(c,0,-1,0),l(u,u,-r.azimuth),o(u,u,-r.altitude),b(c,c,u)}}function z(t,e){if(e===v.Global)return!0;const i=j.planarDirection;return Math.abs(t)<i.localAltitude}function k(t,e,i,n,o){const a=t.getTime(),l=e.getTime()-a,s=Math.floor(l/i)+1,c=new Array(s);for(let r=0;r<s;++r)ot.setTime(a+i*r),c[r]=w(),P(ot,n,o,c[r]);return c}const D=A(.5773502691896258,-.5773502691896258,.5773502691896258);class E{constructor(){this.ambient={color:A(1,1,1),intensity:.55},this.direct={color:A(1,1,1),intensity:.55,directionToLightSource:N(D)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const I=s(),G={azimuth:0,altitude:0};function H(t,i){const n=t.valueOf();let o,a;i.polarException===T.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):i.polarException===T.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=i.sunrise.valueOf(),a=i.sunset.valueOf());const l=o+(a-o)/2;return 1-e(Math.abs(n-l)/432e5,0,1)}function F(t){switch(t){case"disabled":case"sunny":case"cloudy":return new x(1,1);case"rainy":return new x(.4,1.2);case"snowy":return new x(.5,1.3);case"foggy":return new x(.2,1.6)}}function L(t,e){const i=(t[0]+t[1]+t[2])/3;t[0]+=(i-t[0])*e,t[1]+=(i-t[1])*e,t[2]+=(i-t[2])*e}const R=A(.01,.01,.01),U=A(1,.6,.5),_=A(1,.98,.98),C=A(1,1,1),V=A(.8,.8,1),q=A(.8,.8,1),B=A(.98,.98,1),J=A(1,1,1),K=u(.01,j.local.ambientAtNight),Q=u(j.local.directAtTwilight,j.local.ambientAtTwilight),W=u(.9*j.local.directAtNoon,j.local.ambientAtNoon),X=u(j.local.directAtNoon,j.local.ambientAtNoon),Y=W,Z=_,$=B,tt=Q,et=U,it=q;function nt(t,e,i){const n=t.valueOf();let o,a;e.polarException===T.PolarException.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):e.polarException===T.PolarException.POLAR_NIGHT?(o=n-2,a=n-1):(o=e.sunrise.valueOf(),a=e.sunset.valueOf());const l=a-o,s=o+l/2,u=l/4,g=s-u,d=s+u,f=.06*l,b=o-f/2,y=o+f/2,A=a-f/2,N=a+f/2,v=m(),M=w(),j=w();let x="";if(n<b||n>N)c(v,K),p(M,R),p(j,V),x="night";else if(n<y){const t=(n-b)/(y-b);r(v,K,Q,t),h(M,R,U,t),h(j,V,q,t),x="sun rising"}else if(n<g){const t=(n-y)/(g-y);r(v,Q,W,t),h(M,U,_,t),h(j,q,B,t),x="early morning"}else if(n<s){const t=(n-g)/(s-g);r(v,W,X,t),h(M,_,C,t),h(j,B,J,t),x="late morning"}else if(n<d){const t=(n-s)/(d-s);r(v,X,Y,t),h(M,C,Z,t),h(j,J,$,t),x="early afternoon"}else if(n<A){const t=(n-d)/(A-d);r(v,Y,tt,t),h(M,Z,et,t),h(j,$,it,t),x="late afternoon"}else if(n<N){const t=(n-A)/(N-A);r(v,tt,K,t),h(M,et,R,t),h(j,it,V,t),x="sun setting"}let S=0;switch(i){case"rainy":case"foggy":S=.8;break;case"snowy":S=.5}S>0&&(L(M,S),L(j,S));const O=F(i);return{direct:{intensity:v[0]*O.direct,color:M},ambient:{intensity:v[1]*O.ambient,color:j},timeOfDay:x}}const ot=new Date(0),at=s(),lt=w(),st=w(),ct=w(),rt=.25,ut=.2;export{E as ColorAndIntensity,S as computeColorAndIntensity,k as computeDirectionsOverTime,z as computeShadowsEnabled,O as computeVirtualLightDirection};
