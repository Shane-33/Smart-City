/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../../../Color.js";import{darken as t}from"../../../../../core/colorUtils.js";import r from"../../../../../core/Evented.js";import{clamp as i}from"../../../../../core/mathUtils.js";import{removeMaybe as a}from"../../../../../core/maybe.js";import{watch as o}from"../../../../../core/reactiveUtils.js";import{w as s,r as n,b as l}from"../../../../../chunks/mat4.js";import{a as c}from"../../../../../chunks/mat4f64.js";import{r as m,f as d,n as u,j as p,b as h,i as f}from"../../../../../chunks/vec3.js";import{c as _,f as j}from"../../../../../chunks/vec3f64.js";import{Manipulator3D as w}from"../../Manipulator3D.js";import{createManipulatorMaterial as v}from"../../manipulatorUtils.js";import{RenderObject as g}from"../../RenderObject.js";import{screenToZConstrained as M}from"../dragEventPipeline3D.js";import{ManipulatorType as U}from"../ManipulatorType.js";import{Settings as O}from"../settings.js";import{discRadius as C}from"./config.js";import{Manipulation as D}from"./Manipulation.js";import{createGraphicMoveDragPipeline as b}from"./moveUtils.js";import{createTubeGeometry as y,createConeGeometry as k}from"../../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as P}from"../../../webgl-engine/lib/Material.js";import{createManipulatorDragEventPipeline as T,addScreenDelta as z}from"../../../../interactive/dragEventPipeline.js";import{ManipulatorStateFlags as F}from"../../../../interactive/interfaces.js";class A extends D{constructor(e){super(),this._radius=C,this.events=new r,this._tool=e.tool,this._view=e.view;const t=new O({getTheme:()=>this._view.effectiveTheme});this._settings=t,null!=e.radius&&(this._radius=e.radius);const i=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:v(this._createDarkenedColor(i,1,.25),P.Occlude),materialFocused:v(this._createDarkenedColor(i,1,0),P.Occlude),materialOccludedUnfocused:v(this._createDarkenedColor(i,.7,0),t.zManipulator.renderOccluded),materialOccludedFocused:v(this._createDarkenedColor(i,.85,0),t.zManipulator.renderOccluded)},this._themeHandle=o((()=>this._view.effectiveTheme.accentColor),(e=>{const t=this._createDarkenedColor(e,1,.25),r=this._createDarkenedColor(e,1,0),i=this._createDarkenedColor(e,.7,0),a=this._createDarkenedColor(e,.85,0),{materialUnfocused:o,materialFocused:s,materialOccludedUnfocused:n,materialOccludedFocused:l}=this._materials;o.setParameters({color:t}),s.setParameters({color:r}),n.setParameters({color:i}),l.setParameters({color:a})})),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._themeHandle=a(this._themeHandle),this._manipulator.applyObjectTransform=H,this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,U.TRANSLATE_Z)}createGraphicDragPipeline(e,t,r){const i=t.graphic.geometry.spatialReference;return b(t.graphic,r,(t=>this.createDragPipeline(((r,i,a,o,s)=>(({steps:i,cancel:a}=e(r,i,a,o,s)),t(r,i,a))),i)),this._view.state.viewingMode)}createDragPipeline(e,t){const r=this._view;return T(this._manipulator,((i,a,o,s,n)=>{const l=a.next((e=>({...e,manipulatorType:U.TRANSLATE_Z}))).next(M(r,i.renderLocation,t)).next(z());e(i,l,o,s,n)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._settings,t=this._radius/C,r=e.zManipulator.height*t,i=e.zManipulator.coneHeight*t,a=e.zManipulator.coneWidth*t,o=e.zManipulator.width*t,m=[j(0,0,0),j(0,0,r)],d=[j(0,0,0),j(0,0,r+i)],u=e=>{const t=c();if(s(t,t,[0,0,r]),n(t,t,Math.PI/2),e){const r=1+2*e/a;l(t,t,[r,r,r])}return t},p=u(0),{materialUnfocused:h,materialFocused:f,materialOccludedUnfocused:_,materialOccludedFocused:w}=this._materials,v=y(h,m,o/2,16,!1),M=k(h,i,a/2,16,!1);M.transformation=p,this._manipulator.renderObjects=[new g(M,F.Unfocused),new g(v,F.Unfocused),new g(M.instantiate({material:f}),F.Focused),new g(v.instantiate({material:f}),F.Focused),new g(M.instantiate({material:_}),F.Unfocused),new g(v.instantiate({material:_}),F.Unfocused),new g(M.instantiate({material:w}),F.Focused),new g(v.instantiate({material:w}),F.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[d]}}_createManipulator(){const e=this._view,t=new w({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const r=e.state.camera,a=E;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const o=m(r.eye,a),s=r.computeRenderPixelSizeAtDist(o),n=d(R,a,r.eye);u(n,n);const l=x;e.renderCoordsHelper.worldUpAtPosition(E,l);const c=Math.abs(p(n,l)),_=h(R,n,l),j=h(R,_,l),w=i(c,.01,1),v=1-Math.sqrt(1-w*w)/w/r.fullWidth,g=this._settings,M=this._radius/C,U=g.zManipulator.width*M;f(j,u(j,j),(1/v-1)*o+s*U),t[12]-=R[0],t[13]-=R[1],t[14]-=R[2]},this._manipulator=t,this._updateManipulator()}_createDarkenedColor(r,i,a){const o=t(r,a);return o.a*=i,e.toUnitRGBA(o)}get test(){return{manipulator:this._manipulator}}}const E=_(),R=_(),x=_(),H=()=>{};export{A as MoveZManipulation};
