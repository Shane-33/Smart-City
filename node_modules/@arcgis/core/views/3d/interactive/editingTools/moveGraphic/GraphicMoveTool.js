/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import i from"../../../../../core/Collection.js";import e from"../../../../../core/Evented.js";import{makeHandle as o}from"../../../../../core/handleUtils.js";import{destroyMaybe as n}from"../../../../../core/maybe.js";import{zeroMeters as a,scale as s}from"../../../../../core/quantityUtils.js";import{watch as r,syncAndInitial as p}from"../../../../../core/reactiveUtils.js";import{property as l}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import{subclass as h}from"../../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as c}from"../../../../../core/support/UpdatingHandles.js";import{makeDehydratedPoint as u}from"../../../../../layers/graphics/dehydratedPoint.js";import{getGraphicEffectiveElevationInfo as m,getConvertedElevation as d}from"../../../../../support/elevationInfoUtils.js";import{getGraphicAttachmentOrigin as g}from"../../manipulatorUtils.js";import{SnappingVisualizer3D as f}from"../../SnappingVisualizer3D.js";import{orientation as v}from"../geometryUtils.js";import{SupportedGraphicResult as _}from"../isSupportedGraphicUtils.js";import{canMoveZ as M}from"../manipulatorUtils.js";import{meshTransformFastUpdateHandles as y}from"../meshFastUpdateUtils.js";import{createVisualElements as w}from"../visualElementUtils.js";import{discRadius as j}from"../manipulations/config.js";import{ManipulationType as b,MoveManipulation as x}from"../manipulations/MoveManipulation.js";import{axisConstrainedDragSign as T}from"../manipulations/moveUtils.js";import{MoveXYGraphicManipulation as S}from"../manipulations/MoveXYGraphicManipulation.js";import{isSupportedGraphic as E}from"./isSupportedGraphic.js";import{OutlineVisualElement as G}from"../../visualElements/OutlineVisualElement.js";import{GraphicState as O}from"../../../layers/graphics/GraphicState.js";import{dragGraphicMany as H,resetGraphicMany as U}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as X}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as I}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import D from"../../../../interactive/sketch/SketchTooltipOptions.js";import{SnappingContext as Y}from"../../../../interactive/snapping/SnappingContext.js";import{createSnapDragEventPipelineStep as z}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";import{Tooltip as A}from"../../../../interactive/tooltip/Tooltip.js";import{TranslateGraphicTooltipInfo as P,TranslateGraphicZTooltipInfo as k,TranslateGraphicXYTooltipInfo as R}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoHorizontalDistanceByElevationModeBetweenPoints as Z}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistanceBetweenPoints as F}from"../../../../support/euclideanLengthMeasurementUtils.js";class C{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class V{constructor(t,i,e){this.dx=t,this.dy=i,this.allGraphics=e,this.type="graphic-move"}}class L{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const N="manipulators";let q=class extends(e.EventedMixin(X)){constructor(t){super(t),this._infos=new Map,this.graphics=new i,this.enableZ=!0,this.tooltipOptions=new D,this.type="move-3d",this._updatingHandles=new c,this._moveManipulation=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),r((()=>this.tooltipOptions.enabled),(i=>{this._tooltip=i?new A({view:t}):n(this._tooltip)}),p)]);const i=this.graphics.toArray();this._updateGraphicInfos({added:i,removed:[]}),this._setupFastTransformUpdates(i),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=n(this._tooltip),this._moveManipulation=n(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:i}){for(const e of t){if(E(e)!==_.SUPPORTED)continue;const t=new B(e),i=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:i})}for(const e of i)this._infos.get(e)?.handle.remove(),this._infos.delete(e)}_setupFastTransformUpdates(t){for(const i of t){const{info:t}=this._infos.get(i);this.addHandles(y(t.state),i)}}_refreshManipulators(){if(this.removeHandles(N),this._moveManipulation=n(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const i of t){const e=i.state;i.manipulationXY=new S({tool:this,view:this.view,graphicState:e}),i.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:e.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:i,_tooltip:e}=this;null!=e&&("start"===t?(this._translateGraphicTooltipInfo??=new P({tooltipOptions:i}),e.info=this._translateGraphicTooltipInfo,e.info.tooltipOptions=i,e.info.distance=a):e.clear())}))],N))),this.addHandles(i.manipulationXY.createDragPipeline(((i,e,o,n)=>this._buildDragEventPipeline(t,b.XY,i,e,o,n))),N)}this._createMoveManipulation(t)}_createMoveManipulation(t){const i=new x({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?x.radiusForSymbol(t[0].graphic.symbol):j});this._moveManipulation=i,i.elevationInfo={mode:"absolute-height",offset:0},i.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(e=>{i.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...e,graphic:this.graphics.at(0)}),e.stopPropagation()})),N)}));const e=i=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{const o=this._tooltip;null!=o&&("focus"===e?this._updateMoveTooltip(t,i):o.clear())})),N)};this._moveManipulation.xyManipulation.forEachManipulator(e(b.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(b.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(b.Z));const o=()=>this._updateMoveManipulation(t);for(const a of t)this.addHandles([a.state.on("changed",o),r((()=>a.state.displaying),o)],N);const n=t[t.length-1];this.addHandles(n.state.on("changed",(()=>this._updateMoveManipulationAngle(n))),N),this.addHandles(i.createDragPipeline(((i,e,o,n,a)=>this._buildDragEventPipeline(t,i,e,o,n,a)),m(n.graphic),n.graphic.geometry.spatialReference,n.graphic),N),this._updateMoveManipulationAngle(n)}_createVisualElements(t){for(const i of t){const e=i.graphic,n=w({view:this.view,graphic:e,forEachManipulator:t=>{i.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>o()});null!=n&&(i.geometryRepresentation=n.visualElement,i.geometryRepresentation instanceof G&&this.addHandles([i.geometryRepresentation.events.on("attachment-origin-changed",(()=>{i.state.isDraped||this._updateMoveManipulation(t)})),r((()=>i.state.isDraped),(()=>this._updateMoveManipulation(t)))],N),this.addHandles(n,N))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=v(t.graphic.geometry))}_updateMoveManipulation(t){const i=u(0,0,0,this.view.spatialReference);let e=0,o=!1;const n=this._moveManipulation;if(n){for(const n of t){if(!n.state.displaying)continue;const t=n.state.graphic;this.enableZ&&M(t)&&(o=!0);const a=n.geometryRepresentation instanceof G&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:g(this.view,t);if(null!=a){const{x:t,y:o,z:n}=a;i.x+=t,i.y+=o,n&&(i.z??=0,i.z+=n),e++}}e>0?(i.x/=e,i.y/=e,i.z??=0,i.z/=e,n.location=i,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=o):n.available=!1}}_buildDragEventPipeline(t,i,e,o,n,a){const s=[],r=[];let p=null,l=null;const h=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,p=null,l=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&i===b.XY){const i=t[0].graphic;({steps:o,cancel:n}=this._buildSnappingPipelineSteps(i,m(i),o,n,a))}return n=n.next((t=>l?.(t))).next((()=>(this.emit("graphic-move-stop",new L(r)),this.destroyed||h(),null))),{steps:o=o.next((i=>{if("start"===i.action){s.length=0,r.length=0;for(const i of t)i.dragging||!i.manipulationXY?.hasManipulator(e)&&i.manipulationXY?.grabbing||(s.push(i),r.push(i.graphic),i.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),p=H(r,this.view.state.viewingMode),l=U(r),this.emit("graphic-move-start",new C(r)),this.destroyed))return null}return 0!==r.length?i:null})).next((t=>p?.(t))).next((e=>(this._updateMoveTooltip(t,i,e),e))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const i=this.view.toScreen(t.mapStart),e=this.view.toScreen(t.mapEnd),o=e.x-i.x,n=e.y-i.y;if(this.emit("graphic-move",new V(o,n,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new L(r)),this.destroyed)return null;h()}return null})),cancel:n}}_updateMoveTooltip(t,i,e){const{tooltipOptions:o,_tooltip:n}=this;if(null==n)return;n.clear();const a=0===t.length?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(i){case b.XY:n.info=this._translateGraphicTooltipInfo??=new P({tooltipOptions:o}),this._updateMoveTooltipDistance(n.info,e,((t,i)=>Z(t,i,a)));break;case b.XY_AXIS:n.info=this._translateGraphicXYTooltipInfo??=new R({tooltipOptions:o}),this._updateMoveTooltipDistance(n.info,e,((t,i)=>{const o=Z(t,i,a);return s(o,T(e))}));break;case b.Z:n.info=this._translateGraphicZTooltipInfo??=new k({tooltipOptions:o}),this._updateMoveTooltipDistance(n.info,e,F)}n.info.tooltipOptions=o}_updateMoveTooltipDistance(t,i,e){if(null!=i&&"end"!==i.action){const{mapStart:o,mapEnd:n}=i,s=e(o,n);t.distance=null!=s?s:a}else t.distance=a}_buildSnappingPipelineSteps(t,i,e,o,n){const a=t.geometry;if(null==a||"point"!==a.type&&"mesh"!==a.type)return{steps:e,cancel:o};const s=("point"===a.type?a:a.anchor).clone(),r=new Y({elevationInfo:i,pointer:n,editGeometryOperations:I.fromGeometry(s,this.view.state.viewingMode),visualizer:new f,excludeFeature:t}),p=this.snappingManager,{snappingStep:l,cancelSnapping:h}=z({snappingContext:r,snappingManager:p,updatingHandles:this._updatingHandles});return o=o.next(h),{steps:e=e.next((i=>{s.z=d(this.view,s,m(t),{mode:"absolute-height",offset:0});return{...i,snapOrigin:r.coordinateHelper.pointToVector(s)}})).next(...l),cancel:o}}get test(){return{tooltip:this._tooltip}}};t([l({constructOnly:!0,nonNullable:!0})],q.prototype,"view",void 0),t([l()],q.prototype,"graphics",void 0),t([l({constructOnly:!0,nonNullable:!0})],q.prototype,"enableZ",void 0),t([l({constructOnly:!0,type:D})],q.prototype,"tooltipOptions",void 0),t([l({constructOnly:!0})],q.prototype,"snappingManager",void 0),t([l()],q.prototype,"type",void 0),t([l()],q.prototype,"updating",null),q=t([h("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],q);class B{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new O({graphic:t})}get graphic(){return this.state.graphic}}export{V as GraphicMoveEvent,C as GraphicMoveStartEvent,L as GraphicMoveStopEvent,q as GraphicMoveTool};
