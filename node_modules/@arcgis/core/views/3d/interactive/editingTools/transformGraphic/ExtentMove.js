/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{createLength as t}from"../../../../../core/quantityUtils.js";import{o as e}from"../../../../../chunks/mat4.js";import{f as o}from"../../../../../chunks/vec3.js";import{g as i}from"../../../../../chunks/vec3f64.js";import{sm4d as a,sv3d as n}from"../../../../../geometry/support/vectorStacks.js";import{ShiftManipulator as r,OffsetMode as s}from"../../../analysis/Slice/ShiftManipulator.js";import{IsShiftEdgeOnScreenFlag as p}from"../../../analysis/Slice/sliceToolUtils.js";import{screenToZConstrained as l}from"../dragEventPipeline3D.js";import{ManipulatorType as m}from"../ManipulatorType.js";import{ManipulationType as c}from"../manipulations/MoveManipulation.js";import{MoveXYGraphicManipulation as h}from"../manipulations/MoveXYGraphicManipulation.js";import{createManipulatorDragEventPipeline as u,addScreenDelta as d,addMapDelta as v}from"../../../../interactive/dragEventPipeline.js";import{AccumulationBehaviour as _}from"../../../../interactive/editGeometry/interfaces.js";import{apply as f}from"../../../../interactive/editGeometry/support/editPlaneUtils.js";import{TranslateGraphicTooltipInfo as g,TranslateGraphicZTooltipInfo as M}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoHorizontalDistanceByElevationModeBetweenPoints as S}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistance as y}from"../../../../support/euclideanLengthMeasurementUtils.js";class T{constructor(t,e,o,i){this._tool=t,this._graphicState=e,this._editGeometryOperations=o,this._bounds=i,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const a=this._tool,n=a.view;this.moveXYGraphicManipulation=new h({view:n,tool:a,graphicState:this._graphicState}),a.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new r(n,s.CENTER_ON_CALLOUT),this.moveZManipulator.state|=p,a.manipulators.add(this.moveZManipulator),a.addHandles([this._createMoveZDragPipeline()]),a.addHandles([a.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,m.TRANSLATE_Z)}updateManipulators(t,i){const r=this.moveZManipulator,s=e(a.get(),t,Math.PI);s[12]=0,s[13]=0,s[14]=0,r.modelTransform=s,r.renderLocation=o(n.get(),i.origin,i.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool.tooltipOptions;return this._moveXYTooltipInfo??=new g({tooltipOptions:t})}_computeMoveZTooltipInfo(){const e=this._tool,o=e.tooltipOptions,i=this._moveZTooltipInfo??=new M({tooltipOptions:o});if(this.moveZManipulator.dragging){const t=this._bounds,e=t.mapBoundsStart.origin,o=t.mapBounds.origin,a=y(e,o,this._tool.view.spatialReference);if(null==a)return null;i.distance=a}else i.distance=t(0,e.moveUnit);return i}_updateMoveTooltip(t,e){if(e===c.XY||e===c.XY_AXIS){const e=S(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");null!=e&&null!=this._moveXYTooltipInfo&&(this._moveXYTooltipInfo.distance=e)}return t}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline(((t,e,o)=>this._applyGraphicMoveSteps(e,o,c.XY)))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return u(this.moveZManipulator,((e,o,a)=>{const n=i(e.renderLocation),r=o.next(l(this._tool.view,n,t)).next(d());this._applyGraphicMoveSteps(r,a,c.Z)}))}_applyGraphicMoveSteps(t,e,o){const i=this._tool,a=i.graphic,n=t.next((t=>("start"===t.action&&(i.inputState={type:"move"},this._bounds.backupMapBounds(),i.emit("graphic-translate-start",{graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(v()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&i.emit("graphic-translate",e);break;case"end":i.inputState=null,i.emit("graphic-translate-stop",e)}return t})).next((t=>this._updateMoveTooltip(t,o)));return e.next((()=>{null!=i.inputState&&i.emit("graphic-translate-stop",{graphic:a,dxScreen:0,dyScreen:0}),i.cancel()})),n}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const o=[];for(const t of this._editGeometryOperations.data.components)o.push(...t.vertices);const i="start"===e.action?_.NEW_STEP:_.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(o,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return f(a,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}}export{T as ExtentMove};
