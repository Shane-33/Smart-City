/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import{isSome as i}from"../../../../../core/arrayUtils.js";import e from"../../../../../core/Evented.js";import{makeHandle as a}from"../../../../../core/handleUtils.js";import{destroyMaybe as o}from"../../../../../core/maybe.js";import{scale as n,zeroMeters as s}from"../../../../../core/quantityUtils.js";import{watch as r,syncAndInitial as l}from"../../../../../core/reactiveUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/has.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as h}from"../../../../../core/support/UpdatingHandles.js";import u from"../../../../../geometry/Point.js";import{getGraphicEffectiveElevationInfo as d}from"../../../../../support/elevationInfoUtils.js";import{ViewingMode as m}from"../../../../ViewingMode.js";import{Manipulator3D as g}from"../../Manipulator3D.js";import{placeAtGraphic as _}from"../../manipulatorUtils.js";import{SnappingVisualizer3D as v}from"../../SnappingVisualizer3D.js";import{canMoveZ as f}from"../manipulatorUtils.js";import{meshTransformFastUpdateHandles as M}from"../meshFastUpdateUtils.js";import{createVisualElements as y}from"../visualElementUtils.js";import{alignArrowsScaleThreshold as S}from"../manipulations/config.js";import{MoveManipulation as R,ManipulationType as w}from"../manipulations/MoveManipulation.js";import{axisConstrainedDragSign as b}from"../manipulations/moveUtils.js";import{GraphicScaleRotateTransform as j}from"./GraphicScaleRotateTransform.js";import{ScaleRotateMeshAdapter as T}from"./ScaleRotateMeshAdapter.js";import{ScaleRotateObjectSymbol3DAdapter as A}from"./ScaleRotateObjectSymbol3DAdapter.js";import{createGraphicGeometryUndoRecord as x}from"./undoRecords.js";import{GraphicState as G}from"../../../layers/graphics/GraphicState.js";import{sceneSnappingAtProjectedLocation as O}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as E}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as I}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import H from"../../../../interactive/sketch/SketchTooltipOptions.js";import{SnappingContext as U}from"../../../../interactive/snapping/SnappingContext.js";import{createSnapDragEventPipelineStep as z}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";import{Tooltip as D}from"../../../../interactive/tooltip/Tooltip.js";import{TranslateGraphicZTooltipInfo as Z,TranslateGraphicXYTooltipInfo as k,TranslateGraphicTooltipInfo as C}from"../../../../interactive/tooltip/TranslateTooltipInfos.js";import{autoHorizontalDistanceByElevationModeBetweenPoints as L}from"../../../../support/automaticLengthMeasurementUtils.js";import{verticalSignedDistanceBetweenPoints as X}from"../../../../support/euclideanLengthMeasurementUtils.js";let Y=class extends(e.EventedMixin(E)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new H,this.type="transform-3d",this._updatingHandles=new h,this._scaleRotate=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new G({graphic:t}),this.addHandles(r((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new D({view:e}):o(this._tooltip)}),l)),this._moveManipulation=new R({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&f(t),radius:R.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((i=>this.addHandles(i.events.on("immediate-click",(i=>{this.emit("immediate-click",{...i,graphic:t}),i.stopPropagation()})))));const n=t=>i=>{this.addHandles(i.events.on("focus-changed",(({action:i})=>{const e=this._tooltip;null!=e&&("focus"===i?this._updateMoveTooltip(t):e.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(n(w.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(n(w.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(n(w.Z));const s=d(t);this._moveManipulation.elevationInfo=s,this.addHandles(M(this.graphicState));const{geometry:p}=t;if(this._moveManipulation.createGraphicDragPipeline(((i,a,o,n,r)=>{if(null!=p&&i===w.XY){const{snappingStep:i,cancelSnapping:a}=z({snappingContext:new U({elevationInfo:s,pointer:r,editGeometryOperations:I.fromGeometry(new u({spatialReference:p.spatialReference}),e.state.viewingMode),visualizer:new v,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});n=n.next(a),o=o.next(O(this.view,s)).next(...i)}return{steps:o=o.next((t=>(this._updateMoveTooltip(i,t),t))),cancel:n}}),this.graphicState,(t=>{const{action:i,graphic:e,dxScreen:a,dyScreen:o}=t,n={graphic:e,dxScreen:a,dyScreen:o};switch(i){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(r((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new j({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.addHandles([y({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>a()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),r((()=>e.scale),(()=>this._updateMoveAngle()))].filter(i)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof g&&this.addHandles(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this._tooltip=o(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=o(this._scaleRotate),this._scaleRotateAdapter=o(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return null!=this.graphic.geometry&&"mesh"===this.graphic.geometry.type?new T({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new A({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:this.tooltipOptions?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return r((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((i=>i.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&f(this.graphic)}))}_createGeometryUndoRecord(){return x(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===m.Local||this.view.scale<S?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){_(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,i){const{tooltipOptions:e,_tooltip:a}=this;if(null==a)return;a.clear();const o=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case w.XY:a.info=this._translateGraphicTooltipInfo??=new C({tooltipOptions:e}),this._updateMoveTooltipDistance(a.info,i,((t,i)=>L(t,i,o)));break;case w.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??=new k({tooltipOptions:e}),this._updateMoveTooltipDistance(a.info,i,((t,e)=>{const a=L(t,e,o);return n(a,b(i))}));break;case w.Z:a.info=this._translateGraphicZTooltipInfo??=new Z({tooltipOptions:e}),this._updateMoveTooltipDistance(a.info,i,X)}a.info.tooltipOptions=e}_updateMoveTooltipDistance(t,i,e){if(null!=i&&"end"!==i.action){const{mapStart:a,mapEnd:o}=i,n=e(a,o);t.distance=null!=n?n:s}else t.distance=s}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};t([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"view",void 0),t([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"graphic",void 0),t([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"enableZ",void 0),t([p()],Y.prototype,"enableRotation",void 0),t([p()],Y.prototype,"enableScaling",void 0),t([p({constructOnly:!0,type:H})],Y.prototype,"tooltipOptions",void 0),t([p()],Y.prototype,"graphicState",void 0),t([p({value:!1})],Y.prototype,"snapToScene",null),t([p({constructOnly:!0})],Y.prototype,"snappingManager",void 0),t([p({readOnly:!0})],Y.prototype,"type",void 0),t([p({readOnly:!0})],Y.prototype,"updating",null),Y=t([c("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Y);export{Y as GraphicTransformTool};
