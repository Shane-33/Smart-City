/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{unpackFloatRGBA as t}from"../../../../core/floatRGBA.js";import e from"../../../../core/PooledArray.js";import{m as r,h as i}from"../../../../chunks/mat4.js";import{a as n}from"../../../../chunks/mat4f64.js";import{e as s}from"../../../../chunks/vec3.js";import{l as a}from"../../../../chunks/vec4.js";import{c as o}from"../../../../chunks/vec4f64.js";import{intersectsSphere as h,create as f,copy as c}from"../../../../geometry/support/frustum.js";import{c as _}from"../../../../chunks/sphere.js";import{maxScale as l}from"../../support/mathUtils.js";import{empty as u,union as d,set as m,DepthRange as g}from"./depthRange.js";import p from"./Octree.js";import{assert as b}from"./Util.js";const w=1e4,v=100,R=500,j=500,C=.1;function A(e,r,i){return t(r,e)*(i[1]-i[0])+i[0]}function B(t,e,r){let i=0;if(!e.some((t=>(i+=t.numGeometries,i>=w))))return S.compute(t,e);const n=u();return r.forAll((e=>d(n,M(t,e)))),n}function M(t,e){if(!e.visible)return;const r=u(),i=e.getSpatialQueryAccelerator();return i?O(r,t,i):T(r,t,e.objects),r}function O(t,e,r){const i=e.eye,n=e.viewForward,s=e.frustum,a=t=>t.visible,o=r.objectCount;if(o<R)m(E,e.near,Math.min(t.near,e.far)),r.forEachInDepthRange(i,n,p.DepthOrder.FRONT_TO_BACK,E,((r,i)=>{D(t,e,r),E.far=t.near,i.setRange(E)}),s,a),m(E,Math.max(t.far,e.near),e.far),r.forEachInDepthRange(i,n,p.DepthOrder.BACK_TO_FRONT,E,((r,i)=>{D(t,e,r),E.near=t.far,i.setRange(E)}),s,a);else{const i=Math.max(Math.min(o,j),Math.ceil(o*C)),h=r.findClosest(n,p.DepthOrder.FRONT_TO_BACK,s,a,i),f=r.findClosest(n,p.DepthOrder.BACK_TO_FRONT,s,a,i);h&&f&&(x(t,e,h.boundingVolumeWorldSpace.bounds),x(t,e,f.boundingVolumeWorldSpace.bounds))}}function T(t,e,r){K.clear(),r.forAll((t=>{t.visible&&0!==t.geometries.length&&K.add(t)})),K.empty||(K.sort(e),m(E,e.near,Math.min(t.near,e.far)),K.forEachInDepthRange(E,p.DepthOrder.FRONT_TO_BACK,((r,i)=>{i<t.near&&D(t,e,r)})),m(E,Math.max(t.far,e.near),e.far),K.forEachInDepthRange(E,p.DepthOrder.BACK_TO_FRONT,((e,r,i)=>{t.far=Math.max(t.far,i)})))}function D(t,e,i){if(!i.visible)return;if(!h(e.frustum,i.boundingVolumeWorldSpace.bounds))return;const n=i.transformation,s=k;i.geometries.forEach((i=>{r(s,n,i.transformation);const a=l(s);F(t,e,i.boundingInfo,s,a)}))}function F(t,e,r,i,n){if(null==r)return;s(W,r.center,i);const{eye:a,viewForward:o}=e,f=o[0]*(W[0]-a[0])+o[1]*(W[1]-a[1])+o[2]*(W[2]-a[2]);if(W[3]=r.radius*n,!(f-W[3]>t.near&&f+W[3]<t.far)&&h(e.frustum,W))if(r.radius>v&&r.getChildren())for(const s of r.getChildren())F(t,e,s,i,n);else V.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function x(t,e,r){const i=e.eye,n=e.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];t.near=Math.min(t.near,s-r[3]),t.far=Math.max(t.far,s+r[3])}class I{constructor(){this._items=new e({allocator:t=>t||{object:null,distance:0,near:0,far:0},deallocator:t=>(t.object=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(t){this._items.pushNew().object=t}sort(t){const e=t.eye,r=t.viewForward;this._items.forAll((t=>{const i=t.object.boundingVolumeWorldSpace.bounds,n=(i[0]-e[0])*r[0]+(i[1]-e[1])*r[1]+(i[2]-e[2])*r[2];t.distance=n,t.near=n-i[3],t.far=n+i[3]})),this._items.sort(((t,e)=>t.distance-e.distance))}forEachInDepthRange(t,e,r){if(e===p.DepthOrder.FRONT_TO_BACK)for(let i=0;i<this._items.length;++i){const e=this._items.data[i];e.far<t.near||e.near>t.far||r(e.object,e.near,e.far)}else for(let i=this._items.length-1;i>=0;--i){const e=this._items.data[i];e.far<t.near||e.near>t.far||r(e.object,e.near,e.far)}}}class P{constructor(){this._view=n(),this._viewProj=n(),this._frustum=f(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(t,e){this._reset(),i(this._view,t.viewMatrix),r(this._viewProj,t.projectionMatrix,this._view),c(this._frustum,t.frustum);const n=this._view,s=n[2],a=n[6],o=n[10],h=n[14];e.forAll((t=>t.forEachGeometry((t=>{if(!t.visible||!t.castShadow)return;const e=t.boundingSphere,r=s*e[0]+a*e[1]+o*e[2]+h,i=r-e[3],n=r+e[3];this._geometries.push(t),this._near.push(-n),this._far.push(-i)}))));const f=new g;if(0===this._geometries.length)return f;for(let r=0;r<this._geometries.length;++r)this._near[r]>f.far&&(f.far=this._near[r]),this._near[r]>2&&this._far[r]<f.near&&(f.near=this._far[r]);const _=this._looseRange;_.near=Math.max(.5*f.near,2),_.far=2*f.far;let l=0,u=0;for(let r=0;r<this._geometries.length;++r)this._near[r]<f.near&&(this._near[r]>=_.near?f.near=this._near[r]:this._nearCandidates[l++]=r),this._far[r]>f.far&&(this._far[r]<=_.far?f.far=this._far[r]:this._farCandidates[u++]=r);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return f;this._nearCandidates.sort(((t,e)=>this._near[t]<this._near[e]?-1:this._near[t]>this._near[e]?1:0)),this._farCandidates.sort(((t,e)=>this._far[t]<this._far[e]?1:this._far[t]>this._far[e]?-1:0));for(let r=0;r<this._nearCandidates.length;++r){const t=this._nearCandidates[r];if(this._near[t]<f.near){const e=this._geometries[t],r=e.boundingInfo;this._includeNearBoundingInfoRec(r,e.shaderTransformation,f)}}for(let r=0;r<this._farCandidates.length;++r){const t=this._farCandidates[r];if(this._far[t]>f.far){const e=this._geometries[t],r=e.boundingInfo;this._includeFarBoundingInfoRec(r,e.shaderTransformation,f)}}return this._reset(),f}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(t,e,r){if(null==t)return;const i=t.center;s(W,i,e);const n=l(e),a=W[0],o=W[1],h=W[2],f=t.radius*n,c=this._frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*h+c[0][3]>f||c[1][0]*a+c[1][1]*o+c[1][2]*h+c[1][3]>f||c[2][0]*a+c[2][1]*o+c[2][2]*h+c[2][3]>f||c[3][0]*a+c[3][1]*o+c[3][2]*h+c[3][3]>f)return;const _=this._view[2]*a+this._view[6]*o+this._view[10]*h+this._view[14],u=_+f;if(!(-(_-f)<2||-u>=r.near))if(-u>this._looseRange.near)r.near=-u;else{if(f>v){const i=t.getChildren();if(void 0!==i){for(const t of i)this._includeNearBoundingInfoRec(t,e,r);return}}V.unionDepthRangeWithAABB(r,this._viewProj,e,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(t,e,r){if(null==t)return;let i=t.radius;const n=t.center;s(W,n,e);const a=l(e),o=W[0],h=W[1],f=W[2];i*=a;const c=this._frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>i||c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>i||c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>i||c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>i)return;const _=this._view[2]*o+this._view[6]*h+this._view[10]*f+this._view[14]-i;if(!(-_<=r.far))if(-_<this._looseRange.far)r.far=-_;else{if(i>v){const i=t.getChildren();if(void 0!==i){for(const t of i)this._includeFarBoundingInfoRec(t,e,r);return}}V.unionDepthRangeWithAABB(r,this._viewProj,e,t.bbMin,t.bbMax)}}}class y{constructor(){this._modelViewProj=n(),this._clipPosition=[o(),o(),o(),o(),o(),o(),o(),o()]}unionDepthRangeWithAABB(t,e,i,n,s){const a=this._modelViewProj;r(a,e,i);let o=!1;for(let r=0;r<8;++r){const t=this._clipPosition[r],e=0===r||3===r||4===r||7===r?n[0]:s[0],i=0===r||1===r||4===r||5===r?n[1]:s[1],o=r<4?n[2]:s[2];t[0]=a[0]*e+a[4]*i+a[8]*o+a[12],t[1]=a[1]*e+a[5]*i+a[9]*o+a[13],t[2]=a[2]*e+a[6]*i+a[10]*o+a[14],t[3]=a[3]*e+a[7]*i+a[11]*o+a[15]}for(let r=0;r<12;++r){const e=this._clipPosition[N[r][0]],i=this._clipPosition[N[r][1]],n=this._clipPosition[N[r][2]],s=this._clipTriangle(e,i,n);let a=!0;for(let t=0;t<s.length;++t){if(s[t][3]>=2){a=!1;break}}if(!a){o=!0;for(let e=0;e<s.length;++e){const r=s[e][3];Number.isFinite(r)&&(t.near=Math.min(r,t.near),t.far=Math.max(r,t.far))}}}return o}_inside(t,e){return 0===e?t[0]>=-t[3]:1===e?t[1]>=-t[3]:2===e?t[0]<=t[3]:3===e?t[1]<=t[3]:void b(!1)}_intersect(t,e,r){let i=0;return 0===r?i=(-t[3]-t[0])/(e[0]-t[0]+e[3]-t[3]):1===r?i=(-t[3]-t[1])/(e[1]-t[1]+e[3]-t[3]):2===r?i=(t[3]-t[0])/(e[0]-t[0]-e[3]+t[3]):3===r&&(i=(t[3]-t[1])/(e[1]-t[1]-e[3]+t[3])),a(o(),t,e,i)}_clipTriangle(t,e,r){let i=[t,e,r];for(let n=0;n<4;++n){const t=i;i=[];for(let e=0;e<t.length;++e){const r=t[e],s=t[(e+1)%t.length];this._inside(s,n)?(this._inside(r,n)||i.push(this._intersect(r,s,n)),i.push(s)):this._inside(r,n)&&i.push(this._intersect(r,s,n))}}return i}}const N=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],W=_(),k=n(),E=u(),K=new I,S=new P,V=new y;export{P as DepthRangeFromRenderGeometries,M as depthRangeFromLayer,B as depthRangeFromScene,A as textureToDepth};
