/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import s from"../../../../core/Accessor.js";import{createTask as r}from"../../../../core/asyncUtils.js";import t from"../../../../core/Evented.js";import{clamp as i}from"../../../../core/mathUtils.js";import{watch as a}from"../../../../core/reactiveUtils.js";import{createScreenPointArray as o,createRenderScreenPointArray as n,screenPointObjectToArray as l}from"../../../../core/screenUtils.js";import{isSVG as u}from"../../../../core/urlUtils.js";import{property as m}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as p}from"../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as h}from"../../../../support/requestImageUtils.js";import{Pos2 as c}from"./DefaultVertexBufferLayouts.js";import{createQuadVAO as _}from"./glUtil3D.js";import{Program as g}from"./Program.js";import{VertexAttribute as d}from"./VertexAttribute.js";import{MagnifierPassParameters as f,build as T}from"../shaders/Magnifier.glsl.js";import{loadMagnifierResources as v}from"../../../magnifier/resources.js";import{PrimitiveType as k,BlendFactor as y,PixelFormat as S,TextureWrapMode as x}from"../../../webgl/enums.js";import{makePipelineState as P,simpleBlendingParams as L,defaultColorWriteParams as j}from"../../../webgl/renderState.js";import{Texture as R}from"../../../webgl/Texture.js";import{TextureDescriptor as b}from"../../../webgl/TextureDescriptor.js";let w=class extends s{constructor(){super(...arguments),this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new f,this.events=new t,this.attributeLocations=new Map([[d.POSITION,0]]),this._tmpScreenPoint=o(),this._tmpRenderPoint=n()}get updating(){return null==this._imageSources&&null!=this._imageLoadTask&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const s=()=>{this._updateResourceLoading(),this.events.emit("request-render")};null!=this._magnifier&&this.addHandles(a((()=>this._magnifier?.version),s)),s()}get enabled(){return null!=this._validMagnifier}get _validMagnifier(){return null!=this._magnifier&&this._magnifier.visible&&null!=this._magnifier.position&&this._magnifier.size>0?this._magnifier:null}get _factor(){return null!=this._magnifier&&this._magnifier.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,s){const r=this._validMagnifier;if(null==r)return;const t=s.camera.pixelRatio,a=Math.ceil(t*r.size);if(this._updateResources(e,a),null==this._resources)return;const o=this._passParameters.textures,n=Math.ceil(1/this._factor*a);o.input.resize(n,n),l(r.position,this._tmpScreenPoint);const u=s.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),m=s.camera.fullWidth,p=s.camera.fullHeight,h=.5*n,c=.5*n;u[0]=i(u[0],h,m-h-1),u[1]=i(u[1],c,p-c-1);const _=Math.floor(u[0]-h),g=Math.floor(u[1]-c),d=this._resources.program;d.bindTexture("textureInput",o.input),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,_,g,n,n,0),this._passParameters.magnifier=r,e.useProgram(d),d.bindPass(this._passParameters,s),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(k.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(null==e)return;const s=e.maskUrl,t=e.overlayUrl;null==this._imageLoadTask||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===t||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),null==this._imageSources&&null==this._imageLoadTask&&(this._imageLoadTask={maskUrl:s,overlayUrl:t,task:r((async e=>{const r=null==s||null==t?v(e):null,i=null!=s?h(s,{signal:e}):r.then((e=>e.mask)),a=null!=t?h(t,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await a},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,s){if(!this.enabled)return void this._disposeResources();if(null!=this._resources){if(this._passParameters.textures.size!==s){const r=this._createTextureResources(e,s);if(null==r)return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=r}return}const r=this._createTextureResources(e,s);null!=r&&(this._resources={program:this._createProgram(e),vao:_(e,c,this.attributeLocations,0,1),pipelineState:P({blending:L(y.ONE,y.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:j})},this._passParameters.textures=r)}_disposeResources(){null!=this._resources&&(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,s){if(null==this._imageSources)return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const r=new b;r.internalFormat=S.RGBA,r.wrapMode=x.CLAMP_TO_EDGE,r.flipped=!0,r.preMultiplyAlpha=!u(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result;const t=new R(e,r,this._imageSources.overlay);r.pixelFormat=r.internalFormat=S.ALPHA,r.preMultiplyAlpha=!1;const i=new R(e,r,this._imageSources.mask);r.pixelFormat=r.internalFormat=S.RGBA,r.flipped=!1;return{input:new R(e,r),mask:i,overlay:t,size:s}}_createProgram(e){return new g(e,T(),this.attributeLocations)}};e([m()],w.prototype,"_imageSources",void 0),e([m()],w.prototype,"_imageLoadTask",void 0),e([m({readOnly:!0})],w.prototype,"updating",null),w=e([p("esri/views/3d/webgl-engine/lib/MagnifierHelper")],w);export{w as MagnifierHelper};
