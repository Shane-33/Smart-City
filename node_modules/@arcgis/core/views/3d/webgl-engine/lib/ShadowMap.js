/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import has from"../../../../core/has.js";import{clamp as t,lerp as s,acosClamped as e}from"../../../../core/mathUtils.js";import{releaseMaybe as a}from"../../../../core/maybe.js";import{a as i}from"../../../../chunks/mat3f64.js";import{w as r,m as h,i as n,u as c}from"../../../../chunks/mat4.js";import{I as o,a as u}from"../../../../chunks/mat4f64.js";import{s as l,i as _,a as d,l as m,k as f,c as p,g,n as x,e as b,j as M}from"../../../../chunks/vec2.js";import{a as w}from"../../../../chunks/vec2f64.js";import{h as C,c as j,E as T,e as y,s as D}from"../../../../chunks/vec3.js";import{c as H}from"../../../../chunks/vec3f64.js";import{s as v,t as S}from"../../../../chunks/vec4.js";import{c as F}from"../../../../chunks/vec4f64.js";import{ViewingMode as R}from"../../../ViewingMode.js";import{ColorFormat as O,DepthFormat as E}from"../core/FBOCache.js";import{CascadeCamera as U}from"./CascadeCamera.js";import{applyTextureResizeModulo as B}from"./textureUtils.js";import{assert as k,logWithBase as L,verify as N,rayRay2D as Q}from"./Util.js";import{TextureType as V,ClearBufferBit as I}from"../../../webgl/enums.js";import{Texture as A}from"../../../webgl/Texture.js";var W;!function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"}(W||(W={}));class z{constructor(){this.camera=new U,this.lightMat=u()}}class P{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class q{get depthTexture(){return this._handle?.colorTexture}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return v(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(t,s){this._fbos=t,this._viewingMode=s,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new P,this._projectionView=u(),this._projectionViewInverse=u(),this._modelViewLight=u(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=F(),this._cascades=[new z,new z,new z,new z],this._lastOrigin=null,this._maxTextureWidth=Math.min(has("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=a(this._handle),this._discardSnapshots()}set maxCascades(s){this.settings.maxNumCascadesHighQuality=t(Math.floor(s),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let t=0;t<this._numCascades;++t)et[t]=this._cascades[t];return et.length=this._numCascades,et}start(t,s,e,a,i){k(this.enabled);const{near:r,far:h}=this._clampNearFar(e);this._computeCascadeDistances(r,h,a),this._textureHeight=this._computeTextureHeight(t,i,a),this._setupMatrices(t,s);const{viewMatrix:n,projectionMatrix:c}=t;for(let o=0;o<this._numCascades;++o)this._constructCascade(o,c,n,s);this._lastOrigin=null,this.clear()}finish(){k(this.enabled),this._handle?.releaseDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!C(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||H(),j(this._lastOrigin,t);for(let s=0;s<this._numCascades;++s){r(at,this._cascades[s].lightMat,t);for(let t=0;t<16;++t)it[16*s+t]=at[t]}}return it}moveSnapshot(t){k(this.enabled),this._handle?.releaseDepth(),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle=null}copySnapshot(t){const s=this._handle?.colorTexture?.descriptor;if(!this.enabled||!s)return;this._snapshots[t]?.release();const{width:e,height:a}=s;this._snapshots[t]=this._fbos.acquire(O.RGBA4,e,a);const i=this._fbos.rctx;this._bindFbo();const r=i.bindTexture(this._snapshots[t]?.colorTexture,A.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(V.TEXTURE_2D,0,0,0,0,0,e,a),i.bindTexture(r,A.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){return this.enabled?this._snapshots[t]?.colorTexture:null}clear(){const t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(I.COLOR_BUFFER_BIT|I.DEPTH_BUFFER_BIT)}_computeTextureHeight(t,s,e){const a=Math.min(window.devicePixelRatio,s)/t.pixelRatio,i=e?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,r=B(Math.floor(Math.max(t.fullWidth,t.fullHeight)*a*i));return Math.min(this._maxTextureWidth,this._numCascades*r)/this._numCascades}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(O.RGBA4,this._textureWidth,this._textureHeight)),this._handle.acquireDepth(E.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=a(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){const t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,s,e,a){const i=this._cascades[t],n=-this._cascadeDistances[t],c=-this._cascadeDistances[t+1],o=(s[10]*n+s[14])/Math.abs(s[11]*n+s[15]),u=(s[10]*c+s[14])/Math.abs(s[11]*c+s[15]);k(o<u);for(let r=0;r<8;++r){v(X,r%4==0||r%4==3?-1:1,r%4==0||r%4==1?-1:1,r<4?o:u,1);const t=J[r];S(t,X,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}T(st,J[0]),i.camera.viewMatrix=r(G,this._modelViewLight,st);for(let r=0;r<8;++r)y(J[r],J[r],i.camera.viewMatrix);let l=J[0][2],_=J[0][2];for(let r=1;r<8;++r)l=Math.min(l,J[r][2]),_=Math.max(_,J[r][2]);l-=200,_+=200,i.camera.near=-_,i.camera.far=-l,Ct(e,a,l,_,i.camera),h(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this._textureHeight;i.camera.viewport=[t*d,0,d,d]}_setupMatrices(t,s){h(this._projectionView,t.projectionMatrix,t.viewMatrix),n(this._projectionViewInverse,this._projectionView);const e=this._viewingMode===R.Global?t.eye:D(st,0,0,1);c(this._modelViewLight,[0,0,0],[-s[0],-s[1],-s[2]],e)}_clampNearFar(t){let{near:s,far:e}=t;return s<2&&(s=2),e<2&&(e=2),s>=e&&(s=2,e=4),{near:s,far:e}}_computeCascadeDistances(t,e,a){const i=a?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(L(e/t,4)),i);const r=(e-t)/this._numCascades,h=(e/t)**(1/this._numCascades);let n=t,c=t;for(let o=0;o<this._numCascades+1;++o)this._cascadeDistances[o]=s(n,c,this.settings.splitSchemeLambda),n*=h,c+=r}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const G=u(),X=F(),J=[];for(let jt=0;jt<8;++jt)J.push(F());const K=w(),Y=w(),Z=w(),$=w(),tt=w(),st=H(),et=[],at=u(),it=o.concat(o,o,o,o),rt=w(),ht=w(),nt=[w(),w(),w(),w()],ct=w(),ot=w(),ut=w(),lt=w(),_t=w(),dt=w(),mt=w();function ft(t,s,e,a,i,r,h,n){l(rt,0,0);for(let l=0;l<4;++l)_(rt,rt,t[l]);d(rt,rt,.25),l(ht,0,0);for(let l=4;l<8;++l)_(ht,ht,t[l]);d(ht,ht,.25),m(nt[0],t[4],t[5],.5),m(nt[1],t[5],t[6],.5),m(nt[2],t[6],t[7],.5),m(nt[3],t[7],t[4],.5);let c=0,o=f(nt[0],rt);for(let l=1;l<4;++l){const t=f(nt[l],rt);t<o&&(o=t,c=l)}p(ct,nt[c],t[c+4]);const u=ct[0];let w,C;ct[0]=-ct[1],ct[1]=u,p(ot,ht,rt),g(ot,ct)<0&&x(ct,ct),m(ct,ct,ot,e),b(ct,ct),w=C=g(p(ut,t[0],rt),ct);for(let l=1;l<8;++l){const s=g(p(ut,t[l],rt),ct);s<w?w=s:s>C&&(C=s)}M(a,rt),d(ut,ct,w-s),_(a,a,ut);let j=-1,T=1,y=0,D=0;for(let l=0;l<8;++l){p(lt,t[l],a),b(lt,lt);const s=ct[0]*lt[1]-ct[1]*lt[0];s>0?s>j&&(j=s,y=l):s<T&&(T=s,D=l)}N(j>0,"leftArea"),N(T<0,"rightArea"),d(_t,ct,w),_(_t,_t,rt),d(dt,ct,C),_(dt,dt,rt),mt[0]=-ct[1],mt[1]=ct[0];const H=Q(a,t[D],dt,_(ut,dt,mt),1,i),v=Q(a,t[y],dt,ut,1,r),S=Q(a,t[y],_t,_(ut,_t,mt),1,h),F=Q(a,t[D],_t,ut,1,n);N(H,"rayRay"),N(v,"rayRay"),N(S,"rayRay"),N(F,"rayRay")}function pt(t,s){return 3*s+t}const gt=w();function xt(t,s){return l(gt,t[s],t[s+3]),gt}const bt=w(),Mt=i();function wt(t,s,e,a,i){p(bt,e,a),d(bt,bt,.5),Mt[0]=bt[0],Mt[1]=bt[1],Mt[2]=0,Mt[3]=bt[1],Mt[4]=-bt[0],Mt[5]=0,Mt[6]=bt[0]*bt[0]+bt[1]*bt[1],Mt[7]=bt[0]*bt[1]-bt[1]*bt[0],Mt[8]=1,Mt[pt(0,2)]=-g(xt(Mt,0),t),Mt[pt(1,2)]=-g(xt(Mt,1),t);let r=g(xt(Mt,0),e)+Mt[pt(0,2)],h=g(xt(Mt,1),e)+Mt[pt(1,2)],n=g(xt(Mt,0),a)+Mt[pt(0,2)],c=g(xt(Mt,1),a)+Mt[pt(1,2)];r=-(r+n)/(h+c),Mt[pt(0,0)]+=Mt[pt(1,0)]*r,Mt[pt(0,1)]+=Mt[pt(1,1)]*r,Mt[pt(0,2)]+=Mt[pt(1,2)]*r,r=1/(g(xt(Mt,0),e)+Mt[pt(0,2)]),h=1/(g(xt(Mt,1),e)+Mt[pt(1,2)]),Mt[pt(0,0)]*=r,Mt[pt(0,1)]*=r,Mt[pt(0,2)]*=r,Mt[pt(1,0)]*=h,Mt[pt(1,1)]*=h,Mt[pt(1,2)]*=h,Mt[pt(2,0)]=Mt[pt(1,0)],Mt[pt(2,1)]=Mt[pt(1,1)],Mt[pt(2,2)]=Mt[pt(1,2)],Mt[pt(1,2)]+=1,r=g(xt(Mt,1),s)+Mt[pt(1,2)],h=g(xt(Mt,2),s)+Mt[pt(2,2)],n=g(xt(Mt,1),e)+Mt[pt(1,2)],c=g(xt(Mt,2),e)+Mt[pt(2,2)],r=-.5*(r/h+n/c),Mt[pt(1,0)]+=Mt[pt(2,0)]*r,Mt[pt(1,1)]+=Mt[pt(2,1)]*r,Mt[pt(1,2)]+=Mt[pt(2,2)]*r,r=g(xt(Mt,1),s)+Mt[pt(1,2)],h=g(xt(Mt,2),s)+Mt[pt(2,2)],n=-h/r,Mt[pt(1,0)]*=n,Mt[pt(1,1)]*=n,Mt[pt(1,2)]*=n,i[0]=Mt[0],i[1]=Mt[1],i[2]=0,i[3]=Mt[2],i[4]=Mt[3],i[5]=Mt[4],i[6]=0,i[7]=Mt[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Mt[6],i[13]=Mt[7],i[14]=0,i[15]=Mt[8]}function Ct(t,s,a,i,r){const h=1/J[0][3],n=1/J[4][3];k(h<n);let c=h+Math.sqrt(h*n);const o=Math.sin(e(t[2]*s[0]+t[6]*s[1]+t[10]*s[2]));c/=o,ft(J,c,o,K,Y,Z,$,tt),wt(K,Y,$,tt,r.projectionMatrix),r.projectionMatrix[10]=2/(a-i),r.projectionMatrix[14]=-(a+i)/(a-i)}export{q as ShadowMap,W as SnapshotSlot};
