/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import t from"../../../../../core/PooledArray.js";import{b as n,c as o}from"../../../../../chunks/mat3.js";import{a as e}from"../../../../../chunks/mat3f64.js";import{a as r}from"../../../../../chunks/quat.js";import{a}from"../../../../../chunks/quatf64.js";import{j as s,u as f,v as c,s as l,p as u,c as i,t as h,g as m}from"../../../../../chunks/vec3.js";import{c as p}from"../../../../../chunks/vec3f64.js";import{signedDistance as b}from"../../../../../geometry/support/plane.js";import{projectedRadius as j,intersectPlane as d}from"../../../support/orientedBoundingBox.js";import{empty as g,within as k,union as w}from"../../lib/depthRange.js";function z(t,n){const o=g(),{eye:e,frustum:r,viewForward:a}=t;n.forAll((t=>{const n=null!=t.offsetObb?t.offsetObb:t.obb,c=s(f(E,n.center,e),a),l=j(n,a);if(k(o,c-l)&&k(o,c+l))return;const u=R(n,r);if(-1===u)return;if(0===u)return v.far=c+l,v.near=c-l,void w(o,v);const i=S.pushNew();i.near=c-l,i.far=c+l,i.mask=u,i.object=t}));for(let c=0;c<S.length;c++){const t=S.data[c];if(k(o,t.near)&&k(o,t.far))continue;v.far=t.far,v.near=1/0;const n=M(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,e,O,(n=>{let o=A;for(let e=0;e<P&&n.length>0;e++){if(0==(t.mask&1<<e))continue;x(r[e],n,o);const a=n;n=o,o=a}for(let t=0;t<n.length;t+=3){l(q,n.data[t],n.data[t+1],n.data[t+2]);const o=s(f(q,q,e),a);v.near=Math.min(v.near,o)}}));0===n&&(v.near=0),w(o,v)}return S.length=0,o}const S=new t({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),v=g(),q=p(),y=p(),O=new t({deallocator:null}),A=new t({deallocator:null});function x(t,n,o){o.length=0;const e=n.length-3;B(q,n,e);const r=b(t,q);r<=0&&(o.push(q[0]),o.push(q[1]),o.push(q[2]));let a=0,s=r;for(;a<e;a+=3){B(y,n,a);const e=b(t,y);if(s*e<0){u(q,y,q,e/(e-s)),F(o,q)}e<=0&&F(o,y),s=e,i(q,y)}if(s*r<0){B(y,n,e);u(q,y,q,r/(r-s)),F(o,q)}}function B(t,n,o){return l(t,n.data[o],n.data[o+1],n.data[o+2])}function F(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function M(t,e,a,s){r(D,t.quaternion),f(E,e,t.center),c(E,E,D);const u=8*((E[0]<-t.halfSize[0]?-1:E[0]>t.halfSize[0]?1:0)+3*(E[1]<-t.halfSize[1]?-1:E[1]>t.halfSize[1]?1:0)+9*(E[2]<-t.halfSize[2]?-1:E[2]>t.halfSize[2]?1:0)+13),i=N[u];if(0===i)return i;n(C,t.quaternion),o(C,C,t.halfSize);const p=(n,o)=>{const e=N[u+o+1];return l(n,((1&e)<<1)-1,(2&e)-1,((4&e)>>1)-1),h(n,n,C),m(n,t.center,n)};return a.length=0,F(a,p(G,0)),F(a,p(H,1)),F(a,p(E,2)),F(a,p(I,3)),s(a),1===i?i:(a.length=0,F(a,G),F(a,I),F(a,p(E,4)),F(a,p(J,5)),s(a),2===i||(a.length=0,F(a,G),F(a,J),F(a,p(E,6)),F(a,H),s(a)),i)}const N=(()=>{const t=new Array(216);let n=0;const o=o=>{for(let e=0;e<o.length;e++)t[n+e]=o[e];n+=8};return o([3,0,6,2,3,1,5,4]),o([2,0,2,3,1,5,4,0]),o([3,1,0,2,3,7,5,4]),o([2,0,1,3,2,6,4,0]),o([1,0,1,3,2,0,0,0]),o([2,1,5,7,3,2,0,0]),o([3,2,0,1,3,7,6,4]),o([2,2,0,1,3,7,6,0]),o([3,3,0,1,5,7,6,2]),o([2,0,1,5,4,6,2,0]),o([1,0,1,5,4,0,0,0]),o([2,1,3,7,5,4,0,0]),o([1,0,2,6,4,0,0,0]),o([0,0,0,0,0,0,0,0]),o([1,1,3,7,5,0,0,0]),o([2,2,3,7,6,4,0,0]),o([1,2,3,7,6,0,0,0]),o([2,3,1,5,7,6,2,0]),o([3,4,0,1,5,7,6,2]),o([2,5,7,6,4,0,1,0]),o([3,5,0,1,3,7,6,4]),o([2,4,5,7,6,2,0,0]),o([1,4,5,7,6,0,0,0]),o([2,5,1,3,7,6,4,0]),o([3,6,0,2,3,7,5,4]),o([2,6,2,3,7,5,4,0]),o([3,7,6,2,3,1,5,4]),t})(),P=4;function R(t,n){let o=0;for(let e=0;e<P;e++){const r=d(t,n[e]);if(r>0)return-1;0===r&&(o|=1<<e)}return o}const C=e(),D=a(),E=p(),G=p(),H=p(),I=p(),J=p();export{z as computeDepthRange};
