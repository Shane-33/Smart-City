/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import"../../../../geometry.js";import{lengthDimensionMeasureType as t,LengthDimensionMeasureType as n}from"../../../../analysis/dimensionUtils.js";import{cyclicalDegrees as r}from"../../../../core/Cyclical.js";import{rad2deg as i}from"../../../../core/mathUtils.js";import{watch as o,initial as a}from"../../../../core/reactiveUtils.js";import{pt2px as s}from"../../../../core/screenUtils.js";import{g as c,b as m}from"../../../../chunks/mat4.js";import{a as l}from"../../../../chunks/mat4f64.js";import{i as d,c as u,f as p,b as f,j as g,h,l as v,s as y,u as w}from"../../../../chunks/vec3.js";import{c as S,Z as j,f as b}from"../../../../chunks/vec3f64.js";import{c as x}from"../../../../chunks/vec4f64.js";import{fromPositionAndNormal as H,create as M,signedDistance as P,normal as C}from"../../../../geometry/support/plane.js";import{sv3d as T}from"../../../../geometry/support/vectorStacks.js";import{clonePoint as O}from"../../../../layers/graphics/hydratedFeatures.js";import{isValidComputation as U,computeGeometryFromDimension as R,computationToGeometryDependencies as z,headingFromGeometry as k,computeOffsetForPoint as A,computeSegmentForMeasureType as D,computeOffsetAxis as _,directUp as F,directStartToEnd as L,dimensionStartToEnd as E}from"./lengthDimensionUtils.js";import{getTransparentAccentColor as I,pointRadius as G,lengthFraction as B,markerLineSizeFraction as N,orientationCalloutOffsetPx as V,orientationCalloutWidth as W,orientationDiscScale as q,orientationFocusMultiplier as Z,orientationSnapThresholdDegrees as J,minLengthMeters as K,linePaddingPx as Q,focusedLinePaddingPx as X}from"./settings.js";import{Manipulator3D as Y}from"../../interactive/Manipulator3D.js";import{createManipulatorMaterial as $,worldScaledManipulatorSettings as ee,calculateInputRotationTransform as te,calculateTranslateRotateFromBases as ne,rotateManipulatorDefaults as re}from"../../interactive/manipulatorUtils.js";import{RenderObject as ie}from"../../interactive/RenderObject.js";import{screenToMap3D as oe,screenToRenderPlane as ae,hideManipulatorWhileDragging as se}from"../../interactive/editingTools/dragEventPipeline3D.js";import{EuclideanSegment as ce}from"../../interactive/visualElements/support/Segment.js";import{markerSizePerLineWidth as me}from"../../support/engineContent/marker.js";import{Attribute as le}from"../../webgl-engine/lib/Attribute.js";import{Geometry as de}from"../../webgl-engine/lib/Geometry.js";import{createSphereGeometry as ue,createPolylineGeometry as pe}from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as fe}from"../../webgl-engine/lib/Material.js";import{VertexAttribute as ge}from"../../webgl-engine/lib/VertexAttribute.js";import{ImageMaterial as he}from"../../webgl-engine/materials/ImageMaterial.js";import{RibbonLineMaterial as ve}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createManipulatorDragEventPipeline as ye,resetProperties as we,EventPipeline as Se}from"../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as je,ManipulatorStateFlags as be}from"../../../interactive/interfaces.js";import xe from"../../../../geometry/Point.js";class He{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const n of t)e(this.manipulatorForMeasureType(n),n)}manipulatorForMeasureType(e){switch(e){case n.Direct:return this.direct;case n.Horizontal:return this.horizontal;case n.Vertical:return this.vertical}}}class Me extends Y{constructor(t,n){const r=$(e.toUnitRGBA(I(t.effectiveTheme))),i=[new ie(ue(r,1,32,32),tt)];super({view:t,renderObjects:i,metadata:n.metadata,available:!1,grabCursor:"crosshair",radius:G,collisionPriority:1}),this._themeHandle=o((()=>({color:e.toUnitRGBA(I(t.effectiveTheme))})),(e=>r.setParameters(e)))}destroy(){this._themeHandle.remove(),super.destroy()}}function Pe(e,t){const n=[b(-.5,0,0),b(.5,0,0)],r=pe(t.unfocusedMaterial,n.map((e=>d(S(),e,B)))),i=r.instantiate({material:t.focusedMaterial});return new Y({view:e,renderObjects:[new ie(r,be.Unfocused|be.Selected|tt),new ie(i,be.Focused|tt)],collisionType:{type:"line",paths:[n]},radius:$e(t.lineSizePt)/2,metadata:t.metadata,available:!1,...ee})}class Ce extends Y{constructor(t,{lineSizePt:n,material:r,metadata:i}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:i}),this._options={calloutColor:x(),lineSizePt:n,material:r},this._themeHandle=o((()=>e.toUnitRGBA(I(t.effectiveTheme))),(e=>{this._options.calloutColor=e,et(this,Te({...this._options,metadata:this.metadata}))}),a)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,et(this,Te({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Te({calloutColor:e,lineSizePt:t,material:n,metadata:r}){return{calloutLength:.25*me*N*s(t)+V,calloutColor:e,calloutWidth:W,customStateMask:tt,discScale:q,focusMultiplier:Z,material:n,metadata:r}}function Oe(e,t){const n=[b(-.5,0,0),b(.5,0,0)],r=pe(t.thinOffsetManipulatorMaterial,n),i=pe(t.unfocusedMaterial,n.map((e=>d(S(),e,B)))),o=i.instantiate({material:t.focusedMaterial});return new Y({view:e,renderObjects:[new ie(i,be.Unfocused|tt),new ie(o,be.Focused|tt),new ie(r,tt)],collisionType:{type:"line",paths:[n]},radius:$e(t.lineSizePt)/2,available:!1,metadata:t.metadata,...ee})}function Ue(e,{isStart:t,createSnappingPipelineStep:n,dimension:r,onUpdate:i,view:o}){const a=t?"startPoint":"endPoint",s=ye(e,((e,t,s,c)=>{const m=se(e),{snappingStep:l,cancelSnapping:d}=n(c);s=s.next(m).next(we(r,[a,"measureType","orientation"])).next(d),t.next(m).next(oe(o)).next(...l).next((e=>{const t=O(e.mapEnd,new xe);i("startPoint"===a?{startPoint:t}:{endPoint:t})}))}));return[s]}function Re(e,{computation:t,view:n}){return[ye(e,((e,r,i)=>{if(!U(t)||!e.selected)return;const{geometry:o,dimension:a}=t,s=se(e);r.next(s).next(Le(n,a,o.dimensionSegment,o.primaryOffsetAxis)),i.next(s).next(we(a,["offset"]))}))]}function ze(e,{computation:t,view:n}){return[ye(e,((e,r,i)=>{De({cancel:i,computation:t,settingHeading:!0,steps:r,view:n})}))]}function ke(e,{computation:t,view:n}){return[ye(e,((e,r,i)=>{De({cancel:i,computation:t,settingHeading:!1,steps:r,view:n})})),e.events.on("immediate-click",(e=>{Ae(e,t,n)}))]}function Ae(e,t,n){const{dimension:i,geometry:o}=t;if(90===i.orientation||270===i.orientation)return i.orientation=0,void e.stopPropagation();if(null==o)return;const{renderCoordsHelper:a}=n,s=R({...z(t),orientation:90},a),c=R({...z(t),orientation:270},a);if(null==s||null==c)return;const m=k(s,a),l=k(c,a),d=Ee(o,n),u=r.shortestSignedDiff(d,m),p=r.shortestSignedDiff(d,l);i.orientation=Math.abs(u)<Math.abs(p)?90:270,e.stopPropagation()}function De(e){const{cancel:t,computation:n,settingHeading:r,steps:o,view:a}=e;if(!U(n))return;const{renderCoordsHelper:s}=a,{dimension:c,geometry:m}=n,l=S(),d=Ze(S(),m,m.directSegment,s),p=Je(T.get(),{forHeading:r,geometry:m,renderCoordsHelper:s}),f=H(d,p,M()),g=r?c.orientation??k(m,a.renderCoordsHelper):c.orientation??0;o.next(ae(a,f)).next((e=>{"start"===e.action&&u(l,e.renderStart);const t=C(f),n=te(l,e.renderEnd,d,t);let o=g-i(n);r||(o=_e(o)),c.orientation=o})),t.next(we(c,["orientation"]))}function _e(e){const t=r.normalize(e)%90;return t<J?e-t:90-t<J?e+(90-t):e}function Fe(e,{computation:t,manipulatorMeasureType:r,view:i}){let o=n.Direct,a=0,s=0;return[e.events.on("grab-changed",(n=>{if("start"!==n.action||!U(t))return;const{dimension:c,geometry:m}=t;o=c.measureType,a=c.offset,s=c.orientation;const l=u(T.get(),e.renderLocation);c.measureType=r,c.offset=A(l,r,m,i.renderCoordsHelper),c.orientation=0})),ye(e,((e,n,c)=>{if(!U(t))return;const{geometry:m,dimension:l}=t,{renderCoordsHelper:d}=i,u=D(ot,r,t,d),p=_(T.get(),{measureType:r,directSegment:m.directSegment,renderCoordsHelper:d}),f=se(e);n.next(f).next(Le(i,l,u,p)),c.next(f).next((e=>(l.measureType=o,l.offset=a,l.orientation=s,e)))}))]}function Le(e,t,n,r){const i=p(T.get(),n.endRenderSpace,n.startRenderSpace);f(i,i,r);const o=H(n.startRenderSpace,i,M()),a=H(n.startRenderSpace,r,M()),s=t.offset;let c,m=0;const l=new Se;return l.next(ae(e,o)).next((n=>{"start"===n.action&&(m=P(a,n.renderStart));const r=(P(a,n.renderEnd)-m)*e.renderCoordsHelper.unitInMeters;t.offset=s+r,c=n})),e=>(l.execute(e),c)}function Ee(e,t){const{directSegment:n}=e,{renderCoordsHelper:r}=t,i=F(T.get(),e,r),o=L(T.get(),e),a=f(T.get(),o,i),{viewForward:s}=t.state.camera;g(a,s)>0&&d(a,a,-1);const c=n.eval(.5,T.get());return r.headingAtPosition(c,a)}function Ie(e,t,n){const{dimensionSegment:r,primaryOffsetAxis:i}=t,o=E(nt,t),a=h(o,j)?c(it):ne(o,i,j,it),s=Math.max(v(o),K/n.unitInMeters);m(a,a,y(nt,s,s,s)),e.modelTransform=a,e.renderLocation=r.eval(.5,nt)}function Ge(e,t,n){Ne(e,t,n,{forHeading:!0})}function Be(e,t,n){Ne(e,t,n,{forHeading:!1})}function Ne(e,t,n,{forHeading:r}){const{dimension:i,geometry:o}=t,{primaryOffsetAxis:a}=o,s=d(Ve,a,i.offset>=0?1:-1),c=Je(We,{forHeading:r,geometry:o,renderCoordsHelper:n});f(c,c,s);const m=ne(s,c,j,it);e.modelTransform=m,e.renderLocation=Ze(nt,o,o.dimensionSegment,n)}const Ve=S(),We=S();function qe(e,t,n,r){const{geometry:i}=t,o=D(ot,n,t,r),a=_(nt,{measureType:n,directSegment:i.directSegment,renderCoordsHelper:r}),s=w(rt,o.endRenderSpace,o.startRenderSpace),c=ne(s,a,j,it),l=v(s);m(c,c,y(rt,l,l,l)),e.modelTransform=c,e.renderLocation=o.eval(.5,rt)}function Ze(e,t,n,r){const{startRenderSpace:i,endRenderSpace:o}=n,a=Ke(t,r)?i:o;return u(e,a)}function Je(e,{forHeading:t,geometry:n,renderCoordsHelper:r}){return t?F(e,n,r):E(e,n,{invert:!0})}function Ke(e,t){const n=L(Qe,e),r=F(Xe,e,t);return g(n,r)>0}const Qe=S(),Xe=S();function Ye(e){return s(e)+Q}function $e(e){return s(e)+X}function et(e,t){const n=t.material??new he({transparent:!0,writeDepth:!1,textureId:t.texture?.id,renderOccluded:fe.Opaque,isDecoration:!0}),r=t.focusMultiplier??re.focusMultiplier,i=t.calloutLength??re.calloutLength,o=re.discRadius*(t.discScale??1),a=o*r,s=(e,t)=>{const n=[0,1,2,2,3,0];return new de(t,[[ge.POSITION,new le([i-e,-e,0,i+e,-e,0,i+e,e,0,i-e,e,0],n,3,!0)],[ge.UV0,new le([0,0,1,0,1,1,0,1],n,2,!0)]])},c=t.calloutWidth??re.calloutWidth,m=new ve({width:c,color:t.calloutColor,renderOccluded:fe.OccludeAndTransparent,isDecoration:!0}),l=pe(m,[[0,0,0],[i-o,0,0]]),d=pe(m,[[0,0,0],[i-a,0,0]]),u=t.customStateMask??je.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[i,0,0]},e.focusMultiplier=r,e.metadata=t.metadata,e.radius=o,e.renderObjects=[new ie(s(o,n),be.Unfocused|u),new ie(l,be.Unfocused|u),new ie(s(a,n),be.Focused|u),new ie(d,be.Focused|u)]}const tt=je.Custom1,nt=S(),rt=S(),it=l(),ot=new ce;export{tt as DidPointerMoveRecentlyFlag,He as LengthDimensionManipulators,Me as LengthDimensionPointManipulator,Ce as LineOfSightOrientationManipulator,Ee as automaticHeadingFromCamera,Oe as createMeasureTypeManipulator,Pe as createOffsetManipulator,$e as focusedOffsetWidth,ze as headingManipulatorHandles,Fe as measureTypeManipulatorHandles,Re as offsetManipulatorHandles,Ue as pointManipulatorHandles,ke as rotationManipulatorHandles,_e as snapOrientationToNearestRightAngle,Ye as unfocusedOffsetWidth,Ge as updateHeadingManipulatorTransform,qe as updateMeasureTypeManipulatorTransform,Ie as updateOffsetManipulatorTransform,Be as updateRotationManipulatorTransform};
