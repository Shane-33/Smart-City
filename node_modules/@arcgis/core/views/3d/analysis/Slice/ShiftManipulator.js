/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{getContrast as t}from"../../../../core/colorUtils.js";import{watch as r,initial as o}from"../../../../core/reactiveUtils.js";import{g as n,w as s,b as a,F as i,m as c}from"../../../../chunks/mat4.js";import{a as l}from"../../../../chunks/mat4f64.js";import{r as m}from"../../../../chunks/quat.js";import{f as u,n as p,i as f,g as d,s as g}from"../../../../chunks/vec3.js";import{c as h,f as b}from"../../../../chunks/vec3f64.js";import{sv3d as j,sm4d as O,sq4d as w}from"../../../../geometry/support/vectorStacks.js";import{shiftRestartOffsetDistance as M,shiftRestartTipRadius as R,shiftRestartTipLength as v,shiftRestartArrowOutlineWidth as C,shiftRestartArrowLength as T,shiftRestartTubeRadius as U,shiftRestartTubeFocusMultiplier as _,shiftRestartTipFocusMultiplier as A}from"./sliceToolConfig.js";import{DidPointerMoveRecentlyFlag as E,IsShiftEdgeOnScreenFlag as N}from"./sliceToolUtils.js";import{Manipulator3D as k}from"../../interactive/Manipulator3D.js";import{RenderObject as F}from"../../interactive/RenderObject.js";import{CullFaceOptions as y}from"../../webgl-engine/lib/basicInterfaces.js";import{createPolylineGeometry as B,createConeGeometry as D,createPathExtrusionGeometry as L}from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as P}from"../../webgl-engine/lib/Material.js";import{ColorMaterial as G}from"../../webgl-engine/materials/ColorMaterial.js";import{RibbonLineMaterial as q}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{ManipulatorStateFlags as x}from"../../../interactive/interfaces.js";var H;!function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(H||(H={}));class I extends k{constructor(n,s){const a=new q({width:1,renderOccluded:P.OccludeAndTransparent,isDecoration:!0}),i=new G({cullFace:y.Back,renderOccluded:P.Opaque,isDecoration:!0}),c=new G({cullFace:y.Back,renderOccluded:P.Opaque,isDecoration:!0}),l=new G({cullFace:y.Back,renderOccluded:P.Opaque,isDecoration:!0}),m=new G({writeDepth:!1,cullFace:y.Front,renderOccluded:P.Transparent,isDecoration:!0});super({view:n,...S({offsetMode:s,tubeMaterial:i,tipMaterial:c,capMaterial:l,outlineMaterial:m,calloutMaterial:a})}),this._themeHandle=r((()=>n.effectiveTheme.accentColor),(r=>{const o=t(r),n=e.toUnitRGBA(r),s=e.toUnitRGBA(o),u=e.toUnitRGBA(e.blendColors(o,r,.4)),p=e.toUnitRGBA(e.blendColors(o,r,.14));a.setParameters({color:n}),i.setParameters({color:p}),c.setParameters({color:s}),l.setParameters({color:u}),m.setParameters({color:n})}),o)}destroy(){this._themeHandle.remove(),super.destroy()}}function S({offsetMode:e,tubeMaterial:t,tipMaterial:r,capMaterial:o,outlineMaterial:n,calloutMaterial:s}){const a=e===H.CENTER_ON_CALLOUT?M:0,i=[b(a,0,-T/2),b(a,0,T/2)],c=J(i,!0),l=W({vertices:i,padding:0,materials:{tube:t,tip:r,cap:o}}),m=W({vertices:i,padding:C,materials:{tube:n,tip:n,cap:n}}),u=B(s,[[a,0,0],[a-M,0,0]]),p=B(s,[[a,0,0],[a-M,0,0]]);return{renderObjects:[...l.normal.map((e=>new F(e,x.Unfocused|E))),...m.normal.map((e=>new F(e,x.Unfocused|E))),new F(u,x.Unfocused|E|N),...l.focused.map((e=>new F(e,x.Focused|E))),...m.focused.map((e=>new F(e,x.Focused|E))),new F(p,x.Focused|E|N)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[c]},collisionPriority:1,radius:R,state:E}}function W({vertices:e,padding:t,materials:r}){const o=o=>{const M=e.slice(0),C=u(j.get(),M[0],M[1]);p(C,C);const T=u(j.get(),M[M.length-1],M[M.length-2]);if(p(T,T),t>0){const e=f(h(),T,-t);M[M.length-1]=d(e,e,M[M.length-1]);const r=f(h(),C,-t);M[0]=d(r,r,M[0])}const E=o?A:1,N=v*E,k=R*E,F=n(O.get());if(t>0){const e=N/4,r=g(j.get(),0,e,0),o=1+t/e;s(F,F,r),a(F,F,g(j.get(),o,o,o)),s(F,F,f(r,r,-1/o))}const y=n(l()),B=b(0,1,0),L=i(l(),m(w.get(),B,T));L[12]=M[M.length-1][0],L[13]=M[M.length-1][1],L[14]=M[M.length-1][2],c(L,L,F);const P=r.tube,G=z(U*(o?_:1)+t,M,P);G.transformation=y;const q=[G],x=r.tip,H=D(x,N,k,24,!1,!1,!0);H.transformation=L,q.push(H);const I=r.cap,S=D(I,N,k,24,!1,!0,!1);S.transformation=L,q.push(S);const W=i(l(),m(w.get(),B,C));return W[12]=M[0][0],W[13]=M[0][1],W[14]=M[0][2],c(W,W,F),q.push(H.instantiate({transformation:W})),q.push(S.instantiate({transformation:W})),q};return{normal:o(!1),focused:o(!0)}}function z(e,t,r){const o=[],n=12;for(let s=0;s<n;s++){const t=s/n*2*Math.PI;o.push([Math.cos(t)*e,Math.sin(t)*e])}return L(r,o,t,[],[],!1)}function J(e,t){const r=u(h(),e[e.length-1],e[e.length-2]);if(p(r,r),f(r,r,v),d(r,r,e[e.length-1]),t){const t=u(h(),e[0],e[1]);return p(t,t),f(t,t,v),d(t,t,e[0]),[t,...e,r]}return[...e,r]}export{H as OffsetMode,I as ShiftManipulator};
