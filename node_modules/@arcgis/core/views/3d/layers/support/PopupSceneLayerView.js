/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Error.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import{unpackFieldNames as t,populateMissingFields as a}from"../../../../layers/support/fieldUtils.js";import{getFetchPopupTemplate as o,getRequiredFields as p}from"../../../layers/support/popupUtils.js";const i=i=>{let c=class extends i{_validateFetchPopupFeatures(e){const{layer:s}=this,{popupEnabled:t}=s;if(!t)throw new r("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:s});if(!o(s,e))throw new r("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}async prepareFetchPopupFeatures(e){}async fetchPopupFeatures(e,r){this._validateFetchPopupFeatures(r);const s=null!=r?r.clientGraphics:null;if(!s||0===s.length)return[];const i="scene"===this.layer.type&&null!=this.layer.associatedLayer?this.layer.associatedLayer:this.layer;let c=[];"fieldsIndex"in this.layer&&(c=t(this.layer.fieldsIndex,await p(i,o(this.layer,r)))),await this.prepareFetchPopupFeatures(c);const l=new Set,n=[],u=[];for(const t of s)a(c,t,l)?u.push(t):n.push(t);return 0===u.length?n:this.whenGraphicAttributes(u,[...l]).catch((()=>u)).then((e=>n.concat(e)))}};return c=e([s("esri.views.3d.layers.support.PopupSceneLayerView")],c),c};export{i as PopupSceneLayerView};
