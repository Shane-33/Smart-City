/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{destroyMaybe as t}from"../../../../core/maybe.js";import{throwIfAborted as s,createAbortError as o}from"../../../../core/promiseUtils.js";import{property as u}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{fromFeatureSetJSON as y}from"../../../../layers/graphics/dehydratedFeatures.js";import{runQuery as i,executeQuery as n}from"../../../../rest/query/operations/query.js";import{PBFDecoder as l}from"../../support/PBFDecoder.js";let p=class extends r{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,r=e&&e.query,t=r&&r.supportsFormatPBF,u=this.layer.parsedUrl;if(t){null==this._decoder&&(this._decoder=new l(this.controller));const e={sourceSpatialReference:this.layer.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeLength:1024};return(r,t)=>i(u,r,"pbf",this._createRequestOptions(t)).then((r=>(s(t),null!=this._decoder?this._decoder.invoke({buffer:r.data,options:e},t.signal):Promise.reject(o()))))}return(e,r)=>n(u,e,this.layer.spatialReference,this._createRequestOptions(r)).then((e=>y(e.data)))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=t(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};e([u({constructOnly:!0})],p.prototype,"layer",void 0),e([u({constructOnly:!0})],p.prototype,"controller",void 0),e([u({readOnly:!0})],p.prototype,"queryFeaturesDehydrated",null),p=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],p);let c=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};e([u({constructOnly:!0})],c.prototype,"layer",void 0),e([u({readOnly:!0})],c.prototype,"queryFeaturesDehydrated",null),c=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],c);let d=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};e([u({constructOnly:!0})],d.prototype,"layer",void 0),d=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],d);let h=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(y,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function m(e,r){return"feature"===e.type&&"feature-layer"===e.source.type?null!=e.infoFor3D?new c({layer:e}):new p({layer:e,controller:r}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"oriented-imagery"===e.type||"wfs"===e.type?new h({layer:e,source:e.source}):"ogc-feature"===e.type?new d({layer:e}):null}e([u({constructOnly:!0})],h.prototype,"layer",void 0),e([u({constructOnly:!0})],h.prototype,"source",void 0),h=e([a("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],h);export{m as createFeatureTileQuery3D};
