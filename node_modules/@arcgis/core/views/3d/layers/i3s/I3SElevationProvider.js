/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import r from"../../../../core/Evented.js";import i from"../../../../core/Logger.js";import{property as n}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import{F as o}from"../../../../chunks/mat4.js";import{a}from"../../../../chunks/mat4f64.js";import{e as l}from"../../../../chunks/vec3.js";import{c}from"../../../../chunks/vec3f64.js";import{projectBoundingSphere as p}from"../../../../geometry/projection/projectBoundingSphere.js";import{empty as m,expand as u}from"../../../../geometry/support/aaBoundingRect.js";import{f as h}from"../../../../chunks/sphere.js";import{newIntersector as f}from"../../webgl-engine/lib/Intersector.js";import{StoreResults as d}from"../../webgl-engine/lib/IntersectorInterfaces.js";const v=m(),g=a(),x=h(0,0,0,0),y=c(),j=c(),E=c();let _=class extends(r.EventedMixin(t)){get spatialReference(){return this.view?.elevationProvider?.spatialReference}constructor(e){super(e),this._tmpEvent={spatialReference:null,extent:v,context:"scene"}}initialize(){this.view=this.layerView.view,this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersector=f(this.view.state.viewingMode),this._intersector.options.store=d.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}getElevation(e,t,r,n){const s=y;s[0]=e,s[1]=t,s[2]=r;const o=this._renderCoordsHelper;if(!o.toRenderCoords(s,n,s))return i.getLogger(this).error("could not project point to compute elevation"),null;const{layerView:a,_intersector:l,intersectionHandler:c}=this,p=a.i3slayer.fullExtent,m=null!=p&&Number.isFinite(p.xmin)&&Number.isFinite(p.xmax)&&Number.isFinite(p.ymin)&&Number.isFinite(p.ymax)&&Number.isFinite(p.zmin)&&Number.isFinite(p.zmax)?{min:p.zmin,max:p.zmax}:a.elevationRange;if(null==m)return null;const u=a.elevationOffset,h=m.min+u,f=m.max+u,d=j,v=E;return o.setAltitude(d,f,s),o.setAltitude(v,h,s),l.reset(d,v,null),c.intersect(l,null,d,v),l.results.min.getIntersectionPoint(s)?o.getAltitude(s):null}getSphereElevationBounds(e,t){return p(e,t,x,this._renderCoordsHelper.spatialReference),this.layerView.getElevationRange(x)}getRootElevationBounds(){const e=this.layerView.i3slayer.fullExtent;return e?.hasZ?{min:e.zmin,max:e.zmax}:null}layerChanged(){this.spatialReference&&(this._tmpEvent.extent=this._computeLayerExtent(),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._tmpEvent.extent=this._computeObjectExtent(e),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e){return m(v),this._expandExtent(e,v),v}_computeLayerExtent(){m(v);for(const e of this.layerView.getVisibleNodes())this._expandExtent(e,v);return v}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;const i=this.layerView.getNodeComponentObb(e);if(null!=i){o(g,i.quaternion),g[12]=i.center[0],g[13]=i.center[1],g[14]=i.center[2];for(let e=0;e<8;++e)y[0]=1&e?i.halfSize[0]:-i.halfSize[0],y[1]=2&e?i.halfSize[1]:-i.halfSize[1],y[2]=4&e?i.halfSize[2]:-i.halfSize[2],l(y,y,g),this._renderCoordsHelper.fromRenderCoords(y,y,r),u(t,y,t)}}};e([n({constructOnly:!0})],_.prototype,"layerView",void 0),e([n({constructOnly:!0})],_.prototype,"intersectionHandler",void 0),e([n()],_.prototype,"view",void 0),e([n()],_.prototype,"spatialReference",null),_=e([s("esri.views.3d.layers.i3s.I3SElevationProvider")],_);const b=_;export{b as default};
