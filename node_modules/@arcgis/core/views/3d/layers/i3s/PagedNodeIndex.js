/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{create as e,contains as t,intersects as s}from"../../../../geometry/support/aaBoundingBox.js";import{transformObb as n}from"./I3SUtil.js";import{set as i,toAaBoundingBox as o,intersectPlane as r}from"../../support/orientedBoundingBox.js";class p{constructor(e,t,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=s}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);a(t,this._nodeSR,this._renderSR,s),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},g(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[u(e,t)].nodes[l(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[u(e,t)].nodes[l(e,t)].obbInRenderSR}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,t){const s=this.pageSize;i(t,this._pages[u(e,s)].nodes[l(e,s)].obbInRenderSR)}getParentId(e){const t=this.pageSize;return this._pages[u(e,t)].parents[l(e,t)]}hasNodes(e,t){const s=u(e,this.pageSize),n=u(e+t-1,this.pageSize);for(let i=s;i<=n;i++)if(null==this._pages[i])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n)}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:e()};return(e,s)=>h(t,e,s)}}function h(e,n,i){const p=e.index;if(!p.hasNodes(0,1))return;const h=e.queue;h.length=0,h.push(0);const a=e.masks;for(a.length=0,a.push(0);h.length>0;){const g=h.pop();let l=a.pop();const d=p.getNode(g),c=p.getRenderObb(g);let f=!0;if(null!=n.clippingBox){const i=1<<n.frustum.length;if(0==(l&i)){const r=o(c,e.tempAabb);t(n.clippingBox,r)?l|=i:s(n.clippingBox,r)||(f=!1)}}for(let e=0;e<n.frustum.length&&f;e++){const t=1<<e;if(0==(l&t)){const s=r(c,n.frustum[e]);s>0?f=!1:s<0&&(l|=t)}}if(i.predicate(g,d,f)){const e=d.firstChild,t=d.childCount;let s=!1;const n=u(e,p.pageSize),o=u(e+t-1,p.pageSize);for(let r=n;r<=o;r++)if(!p.hasPage(r)){i.pageMiss(g,r),s=!0;break}if(!s)for(let i=0;i<t;i++)h.push(e+i),a.push(l)}}}function a(e,t,s,i){for(let o=0;o<e.length;o++){const r=e[o];n(r.obb,t,r.obbInRenderSR,s,i)}}function g(e,t){const s=[0];for(;s.length;){const n=s.pop(),i=e[u(n,t)].nodes[l(n,t)];for(let o=0;o<i.childCount;o++){const r=i.firstChild+o;null!=e[u(r,t)]&&(e[u(r,t)].parents[l(r,t)]=n,s.push(r))}}}function u(e,t){return e/t|0}function l(e,t){return e%t}export{p as default};
