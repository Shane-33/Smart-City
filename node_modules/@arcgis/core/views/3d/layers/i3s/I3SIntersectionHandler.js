/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{ViewingMode as e}from"../../../ViewingMode.js";import{isValidObb as t,isValidMbs as r}from"./I3SUtil.js";import{I3sTarget as i}from"./Intersector.js";import{intersectLine as s}from"../../support/orientedBoundingBox.js";import{newIntersectorResult as n}from"../../webgl-engine/lib/Intersector.js";import{IntersectorType as l,StoreResults as o}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{getVerticalOffsetI3S as c}from"../../webgl-engine/lib/verticalOffsetUtils.js";class d{constructor(e){this.type=l.I3S,this._needVerticalOffset=!1,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(t,r){this._needVerticalOffset=t&&r===e.Global}intersect(e,l,d,u){const f=e.results,b=e.options.store===o.ALL,m=e.ray.direction,h=e.tolerance;let p=e=>e,y=e=>e;const g=c(null!=e.verticalOffset?e.verticalOffset:this._needVerticalOffset?0:null);null!=e.verticalOffset&&null!=g&&(p=e=>g.applyToMbs(e),y=e=>g.applyToObb(e)),this._traverseNodeHierarchy(((o,c)=>{if(0===o.childrenLoaded)return!1;const O=null!=o.serviceObbInRenderSR&&t(o.serviceObbInRenderSR)?o.serviceObbInRenderSR:null;return!(null!=O&&!s(y(O),d,m,h))&&(!c||null==O&&r(o.renderMbs)&&!a(p(o.renderMbs),d,m,h)||null!=o.geometryObb&&!s(y(o.geometryObb),d,m,h)||this._collection.intersect(c,d,u,h,g,((t,r,s,c)=>{if(r>=0){if(null!=l&&!l(d,u,r))return;const a=e=>{const n=new i(this.layerUid,this.sublayerUid,o.index,t,c);e.set(this.type,n,r,s)};if(this.isGround&&(null==f.ground.dist||r<f.ground.dist)&&a(f.ground),e.options.isFiltered)return;if((null==f.min.dist||r<f.min.dist)&&a(f.min),(null==f.max.dist||r>f.max.dist)&&a(f.max),b){const t=n(e.ray);a(t),e.results.all.push(t)}}})),!0)}))}}function a(e,t,r,i=0){const s=e[3]+i,n=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=r[0],d=r[1],a=r[2],u=c*n+d*l+a*o;return u*u-(c*c+d*d+a*a)*(n*n+l*l+o*o-s*s)>=0}export{d as I3SIntersectionHandler};
