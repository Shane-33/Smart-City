/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{a as e,o as t,l as i,i as s,j as r,m as n,f as o,g as a}from"../../../../chunks/vec3.js";import{c as h}from"../../../../chunks/vec3f64.js";import{c}from"../../../../chunks/vec4.js";import{getReferenceEllipsoid as l}from"../../../../geometry/ellipsoidUtils.js";import{getSphericalPCPF as m}from"../../../../geometry/spatialReferenceEllipsoidUtils.js";import{projectBoundingSphere as p}from"../../../../geometry/projection/projectBoundingSphere.js";import{create as _,fromMatrix as u,intersectsSphere as d}from"../../../../geometry/support/frustum.js";import{isPlateCarree as g}from"../../../../geometry/support/spatialReferenceUtils.js";import{w as v}from"../../../../chunks/sphere.js";import{makeDehydratedPoint as b}from"../../../../layers/graphics/dehydratedPoint.js";import{evaluateElevationAlignmentAtPoint as x}from"../graphics/elevationAlignmentUtils.js";import{ElevationContext as f}from"../graphics/ElevationContext.js";import{createContextWithoutExpressionSupport as M,extractExpressionInfo as R}from"../graphics/featureExpressionInfoUtils.js";import{expandElevationRange as C}from"./ElevationRange.js";import{LodMetric as D}from"./I3SNode.js";import{isValidMbs as S,isValidObb as E,transformObb as P,intersectBoundingRectWithMbs as O,MbsIntersectResult as L}from"./I3SUtil.js";import{create as j,computeOffsetObb as B,isVisible as F}from"../../support/orientedBoundingBox.js";const y=1e5;class I{constructor(e,t,i,s,r,n,o,a,c={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=r,this._elevationProvider=n,this._viewingMode=o,this._options=c,this._frustum=_(),this._useFrustumCulling=!1,this._poi=h(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=j(),this._tmp1=h(),this._tmp2=h(),this._tmp3=h(),this._tmp0=h(),this._screenspaceErrorBias=c.screenspaceErrorBias||1,this._progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i,s),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(a),this._tmpPoint=b(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||g(this.engineSR)),this._indexSREllipsoidRadius=l(this._indexSR).radius}updateElevationInfo(e){null!=e?(this._elevationContext=f.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(M(R(e,!1)))):this._elevationContext=null}updateCamera(e,t){this._useFrustumCulling=t,t&&u(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,i){if(null==this._elevationContext)return;const s=e.mbs;if(!s)return;if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(s,this._indexSR);return void(e&&C(i,e.min,e.max))}const r=s[0],n=s[1],o=s[2],a="relative-to-scene"===this._elevationContext.mode?"scene":"ground",h=this._elevationProvider.getElevation(r,n,o,this._indexSR,a);h&&C(i,h,h);const c=t?null:this._elevationProvider.getRootElevationBounds?.();c&&C(i,c.min,c.max)}getRenderMbs(e){const t=e.renderMbs;if(S(t))return t;e.mbs&&c(t,e.mbs);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let s=0,r=0;const n=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":s=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],r=n-i;break;case"on-the-ground":s=i-t[2],r=n-i}t[2]+=s+.5*r,t[3]+=.5*r}else this._elevationContext&&t[3]<y&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=x(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return p(t,this._indexSR,t,this.engineSR),t}_getVisibilityObb(e){if(null!=e.visibilityObb)return e.visibilityObb;const t=e.serviceObb,i=.01*this._indexSREllipsoidRadius;return null==t||!e.mbs||!E(t)||this._isECEFOBBInLocalMode&&t.halfSize.some((e=>e>i))?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRangeMin,e.elevationRangeMax),e.serviceObbInRenderSR)}_computeRenderObb(e,t,i,s,r){if(null==t)t=j();else if(E(t))return t;let n=0,o=0;if(this._elevationContext&&!Number.isNaN(s)&&Number.isFinite(s))switch(this._elevationContext.mode){case"relative-to-ground":n=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+s-e.center[2],o=r-s;break;case"on-the-ground":n=s-e.center[2],o=r-s}else this._elevationContext&&i<y&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],n=x(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return o>0?(P(e,this._indexSR,this._tmpObb,this.engineSR,n),B(this._tmpObb,0,o,this._viewingMode,t)):P(e,this._indexSR,t,this.engineSR,n),t}isNodeVisible(e){const t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const i=this._getVisibilityObb(e);return i?F(i,this._frustum):d(this._frustum,v(t))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObb;return null!=t?F(t,this._frustum):this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||O(this._clippingArea,e)!==L.OUTSIDE}_screenSpaceDiameterMbs(t,i){const s=this.getRenderMbs(t),r=Math.sqrt(e(s,this._camPos)),n=r-s[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:i/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}calcCameraDistanceToCenter(e){const i=this.getRenderMbs(e),s=t(i,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(e){const s=this.getRenderMbs(e),r=s[3],n=(Math.abs(s[0]*(s[0]-this._camPos[0])+s[1]*(s[1]-this._camPos[1])+s[2]*(s[2]-this._camPos[2]))/i(s)+r)/t(s,this._camPos);return Math.min(1,n)}hasLOD(e){return e.lodMetric!==D.None}_getDistancePlanarMode(e,t){const i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2],n=i*i+s*s,o=t[3];if(n<=o*o)return Math.abs(r);const a=Math.sqrt(n)-o;return Math.sqrt(r*r+a*a)}_getDistanceGlobeMode(h,c){const l=i(c),m=i(h)-l;s(this._tmp0,h,r(h,c)/n(h));const p=e(c,this._tmp0),_=c[3];if(p<=_*_)return Math.abs(m);{const e=s(this._tmp0,c,1/l),n=l,p=_*_/2/n,u=s(this._tmp1,e,n-p),d=h,g=o(this._tmp2,d,u),v=o(this._tmp2,g,s(this._tmp3,e,r(e,g))),b=a(this._tmp2,u,s(this._tmp2,v,_/i(v)));let x=t(d,b);if(m>=2e5){const t=o(this._tmp1,d,b);let s=r(t,e)/i(t);s<.08&&(s=1e-4),x/=s}return x}}_getDistance(e,t){return this.engineSR===m(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===D.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case D.ScreenSpaceRelative:{const i=this.getRenderMbs(e),s=this._getDistance(this._camPos,i),r=2*s/this._screenSizeFactor,n=s+i[3];return this._updateMinMaxDistance(n),e.maxError*t<=r}case D.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case D.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case D.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const i=this.getRenderMbs(e);return t(i,this._poi)-i[3]}distCameraToPOI(){return t(this._camPos,this._poi)}}export{I as default};
