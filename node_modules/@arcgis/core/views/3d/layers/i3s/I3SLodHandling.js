/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../../core/PooledArray.js";import{NodeState as i}from"./I3SNode.js";import{FadeDirection as o}from"../support/I3SLayerView.js";class s{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,i,o,s){this._maxLodLevel=s.maxLodLevel,this._index=o,this._isNodeInScaleBounds=e,this._removeNodes=i}shouldLoadNode(e){if(null==e)return!1;const i=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(i)||!!i.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this._layerView.view.resourceController.memoryController.usedMemory,o=Math.max(0,Math.floor(10*(i-1)));d.clear(),this._lodGlobalHandling(this._index.rootNode,o,!1,!!this._layerView.nodeCrossfadingEnabled);const s=d.length;this._removeNodes(d,e);const t=d.length<s;return 0!==d.length&&(this._lodGlobalDirty=!0),d.clear(),t}_lodGlobalHandling(e,s,t,l){if(null==e)return!1;const r=e.index,n=this._index,a=this._layerView,h=n.nodeTraversalState(e),u=this._isChosenMaxLOD(h),_=e.resources.isEmpty;if(u&&_)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const c=a.isNodeLoaded(r);if(l&&c&&u){const i=!t&&this.hasNoVisibleChildren(e);a.fadeNode(r,o.FadeIn,!i)}const x=c&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(c&&(a.updateNodeState(r,u?i.Leaf:i.Hole),u))return x&&this._removeChildrenRecursive(e),x;const L=e.childCount>0;let y=L;if(L)for(let i=0;i<e.childCount;i++){const e=n.getChildIndex(r,i),o=n.getNode(e);if(null!=o){!(!n.isGeometryVisible(e)||this._lodGlobalHandling(o,s,t||x,l))&&this._isNodeInScaleBounds(o)&&(y=!1)}else n.isNodeVisible(e)&&(y=!1)}const N=c&&!u&&(y||d.length<s);N&&d.push(r),!l||N||!c||t||y||a.fadeNode(r,o.FadeIn,!1);const m=e.resources.isEmpty;return y||x&&!N||m}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&d.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0))),i}_childrenRequireLoading(e){let i=!1,o=!0;return this._index.traverseChildren(e,(e=>{if(!o||!this._index.isNodeVisible(e.index))return!1;const s=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(i=!0),this._layerView.isNodeLoaded(e.index)?(o=!1,!1):e.childrenLoaded>0})),o&&i}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const d=new e({deallocator:null});export{s as default};
