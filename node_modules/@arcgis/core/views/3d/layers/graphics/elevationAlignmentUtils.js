/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{h as e}from"../../../../chunks/mat4.js";import{a as t}from"../../../../chunks/mat4f64.js";import{c as n}from"../../../../chunks/vec3f64.js";import{computeTranslationToOriginAndRotation as o}from"../../../../geometry/projection/computeTranslationToOriginAndRotation.js";import{projectBuffer as r}from"../../../../geometry/projection/projectBuffer.js";import{isDehydratedPoint as i}from"../../../../layers/graphics/dehydratedFeatureUtils.js";import{updateVertexAttributeAuxpos1w as s}from"./graphicUtils.js";import{isSamplePosition as a,getElevationAtPoint as l}from"../../support/ElevationProvider.js";function u(e,t,n,o,i,s,a,l,u,c,f){const d=j[f.mode];let m,p,g=0;if(r(e,t,n,o,u.spatialReference,i,l))return d.requiresAlignment(f)?(g=d.applyElevationAlignmentBuffer(o,i,s,a,l,u,c,f),m=s,p=a):(m=o,p=i),r(m,u.spatialReference,p,s,c.spatialReference,a,l)?g:void 0}function c(e,t,n,o,r){const s=(i(e)?e.z:a(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":{const n=l(t,e,"ground")??0;return r.verticalDistanceToGround=0,r.sampledElevation=n,void(r.z=n)}case"relative-to-ground":{const i=l(t,e,"ground")??0,a=n.geometryZWithOffset(s,o);return r.verticalDistanceToGround=a,r.sampledElevation=i,void(r.z=a+i)}case"relative-to-scene":{const i=l(t,e,"scene")??0,a=n.geometryZWithOffset(s,o);return r.verticalDistanceToGround=a,r.sampledElevation=i,void(r.z=a+i)}case"absolute-height":{const i=n.geometryZWithOffset(s,o),a=l(t,e,"ground")??0;return r.verticalDistanceToGround=i-a,r.sampledElevation=a,void(r.z=i)}default:return void(r.z=0)}}function f(e,t,n,o){return c(e,t,n,o,x),x.z}function d(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?T.UPDATE:e.onTheGroundChanged}function m(e){return"relative-to-ground"===e||"relative-to-scene"===e}function p(e){return"absolute-height"!==e}function g(t,n,r,i,a){c(n,r,a,i,x),s(t,x.verticalDistanceToGround);const l=x.sampledElevation,u=e(O,t.transformation);z[0]=n.x,z[1]=n.y,z[2]=x.z;return o(n.spatialReference,z,u,i.spatialReference)?t.transformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),l}function v(e,t,n,o,r,i){let s=0;const a=i.spatialReference;t*=3,o*=3;for(let l=0;l<r;++l){const r=e[t],l=e[t+1],u=e[t+2],c=i.getElevation(r,l,u,a,"ground")??0;s+=c,n[o]=r,n[o+1]=l,n[o+2]=c,t+=3,o+=3}return s/r}function h(e,t,n,o,r,i,s,a){let l=0;const u=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let d=0;d<r;++d){const r=e[t],s=e[t+1],a=e[t+2],d=i.getElevation(r,s,a,f,"ground")??0;l+=d,n[o]=r,n[o+1]=s,n[o+2]=null==c?a+d+u:d+u,t+=3,o+=3}return l/r}function E(e,t,n,o,r,i,s,a){let l=0;const u=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let d=0;d<r;++d){const r=e[t],s=e[t+1],a=e[t+2],d=i.getElevation(r,s,a,f,"scene")??0;l+=d,n[o]=r,n[o+1]=s,n[o+2]=null==c?a+d+u:d+u,t+=3,o+=3}return l/r}function y(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}function A(e,t,n,o,r,i,s,a){const l=a.calculateOffsetRenderUnits(s),u=a.featureExpressionInfoContext;t*=3,o*=3;for(let c=0;c<r;++c){const r=e[t],i=e[t+1],s=e[t+2];n[o]=r,n[o+1]=i,n[o+2]=null==u?s+l:l,t+=3,o+=3}return 0}class R{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var T;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(T||(T={}));const j={"absolute-height":{applyElevationAlignmentBuffer:A,requiresAlignment:y},"on-the-ground":{applyElevationAlignmentBuffer:v,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:h,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:E,requiresAlignment:()=>!0}},O=t(),x=new R,z=n();export{R as SampleElevationInfo,T as SymbolUpdateType,g as applyElevationAlignmentForHUD,u as applyPerVertexElevationAlignment,d as elevationModeChangeUpdateType,f as evaluateElevationAlignmentAtPoint,c as evaluateElevationInfoAtPoint,m as needsElevationUpdates2D,p as needsElevationUpdates3D};
