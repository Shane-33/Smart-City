/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import{throwIfAborted as e}from"../../../../core/promiseUtils.js";import{projectPointToVectorWithEngine as o}from"../../../../geometry/projection/projectPointToVectorWithEngine.js";import{makeDehydratedPoint as t}from"../../../../layers/graphics/dehydratedPoint.js";import{getGeometryEffectiveElevationInfo as r}from"../../../../support/elevationInfoUtils.js";import{evaluateElevationInfoAtPoint as n,SampleElevationInfo as i}from"./elevationAlignmentUtils.js";import{ElevationContext as s}from"./ElevationContext.js";import{extractExpressionInfo as a,createContext as p}from"./featureExpressionInfoUtils.js";import f from"../../../../geometry/SpatialReference.js";async function c(t,i,s,c,u){const{elevationProvider:g,renderCoordsHelper:v}=t,{elevationInfo:y}=i,{pointsInFeatures:I,spatialReference:h}=c,x=f.fromJSON(h),w=a(y,!0),E=await p(w,x,u);e(u);const R=[],S=new Set,z=new Set;l.spatialReference=x;const P=t.elevationProvider.spatialReference??t.spatialReference;for(const{objectId:e,points:a}of I){const t=s(e);if(null==t){for(const e of a)R.push(e.z??0);S.add(e);continue}t.isDraped&&z.add(e);const p=t.graphic.geometry;m.setFromElevationInfo(r(p,y)),m.updateFeatureExpressionInfoContext(E,t.graphic,i);for(const{x:e,y:r,z:i}of a)l.x=e,l.y=r,l.z=i??0,await o(l,j,P,0,{signal:u}),n(j,g,m,v,d),R.push(d.z)}return{elevations:R,drapedObjectIds:z,failedObjectIds:S}}const m=new s,l=t(0,0,0,f.WGS84),d=new i,j=[0,0,0];export{c as elevationAlignPointsInFeatures};
