/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import s from"../../../core/Logger.js";import e from"../../../core/PooledArray.js";import{WorkerHandle as o}from"../../../core/workers/WorkerHandle.js";import{canProjectWithoutEngine as t}from"../../../geometry/projection.js";import{projectVectorToVector as r}from"../../../geometry/projection/projectVectorToVector.js";import{ModificationType as p}from"../../../libs/i3s/enums.js";class h extends o{constructor(s){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer],project:s=>[s.positions.buffer],transformNormals:s=>[s.normals.buffer]},s,{hasInitialize:!0})}setModifications(s,e,o,t){const r={context:s,modifications:u(e,o,t),isGeodetic:t.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(s,e){const o=JSON.stringify(e);return this.broadcast({context:s,jsonSchema:o},"setLegacySchema")}destroyContext(s){return this.broadcast(s,"destroyContext")}project(s,e){return this.invokeMethod("project",s,e)}transformNormals(s,e){return this.invokeMethod("transformNormals",s,e)}}const n=new e({deallocator:null}),i=[0,0,0];function u(e,o,h){n.clear();let u=1/0,a=1/0,c=-1/0,f=-1/0,l=!1;for(const d of o){const e="clip"===d.type?p.Inside:"mask"===d.type?p.Outside:p.Replace,o=d.geometry;let m=s=>s;if(o.spatialReference){if(!t(o.spatialReference,h)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}m=s=>(r(s,o.spatialReference,i,h),i)}else o.hasZ||(i[2]=0,m=s=>(i[0]=s[0],i[1]=s[1],i));l=l||e===p.Outside,n.push(e),n.push(o.rings.length);for(const s of o.rings){n.push(s.length);for(const e of s){const s=m(e);n.push(s[0]),n.push(s[1]),n.push(s[2]),u=Math.min(u,s[0]),a=Math.min(a,s[1]),c=Math.max(c,s[0]),f=Math.max(f,s[1])}}}if(null!=e)if(l){const s=1e-4;n.push(p.Inside),n.push(2),n.push(4),n.push(u-s),n.push(a-s),n.push(0),n.push(c+s),n.push(a-s),n.push(0),n.push(c+s),n.push(f+s),n.push(0),n.push(u-s),n.push(f+s),n.push(0),n.push(4),n.push(e[0]),n.push(e[1]),n.push(0),n.push(e[2]),n.push(e[1]),n.push(0),n.push(e[2]),n.push(e[3]),n.push(0),n.push(e[0]),n.push(e[3]),n.push(0)}else n.push(p.Outside),n.push(1),n.push(4),n.push(e[0]),n.push(e[1]),n.push(0),n.push(e[2]),n.push(e[1]),n.push(0),n.push(e[2]),n.push(e[3]),n.push(0),n.push(e[0]),n.push(e[3]),n.push(0);n.push(p.Finished);const m=new Float64Array(n.length);for(let s=0;s<n.length;++s)m[s]=n.at(s);return m}export{h as I3SMeshWorkerHandle,u as toWasmModification};
