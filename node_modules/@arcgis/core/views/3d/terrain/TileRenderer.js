/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{disposeMaybe as e,releaseMaybe as t}from"../../../core/maybe.js";import{s as r,j as s}from"../../../chunks/vec2.js";import{Z as o}from"../../../chunks/vec2f64.js";import{isBaseLayer as a,isGroupLayer as i}from"../../../layers/support/layerUtils.js";import{isImageWithType as n}from"../support/StreamDataLoader.js";import{BlendLayersPassParameters as u}from"./BlendLayersTechnique.js";import{TextureUpdate as c}from"./interfaces.js";import{NeighborIndex as l}from"./ITile.js";import{LayerClass as p}from"./LayerClass.js";import{isBlendableLayerView as h,isVectorTileLayerView as d,isVectorTileRenderInfo as m,isImageryTileRenderInfo as _,isRasterTileRenderInfo as f,isTextureTileRenderInfo as y,isVectorTilePerLayerInfo as T}from"./terrainUtils.js";import{ActivationTime as g}from"./TextureFader.js";import{TextureReference as b}from"./TextureReference.js";import{TileCompositor as x}from"./TileCompositor.js";import{TileRenderInfo as I}from"./TileRenderInfo.js";import w from"./TileTexture.js";import{TileUpdate as k}from"./TileUpdate.js";import{blendModeFromString as P}from"../webgl-engine/core/shaderLibrary/output/BlendOptions.js";import{BlendLayersOutput as A,BaseOpacityMode as O}from"../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl.js";import{createEmptyTexture as R}from"../webgl-engine/lib/glUtil3D.js";import{TextureSamplingMode as E,TextureWrapMode as M,PixelFormat as D}from"../../webgl/enums.js";import{Texture as L}from"../../webgl/Texture.js";import{TextureDescriptor as j}from"../../webgl/TextureDescriptor.js";class N{constructor(e,t,r,s,o,a){this.start=e,this.end=t,this.blendMode=r,this.opacity=s,this.output=o,this.baseOpacity=a}}class C{constructor(e,t,r,s){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=s,this._passParameters=new u,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new x(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=e(this._composition),this._backgroundTexture=t(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let o=0,n=0,u=this.tileSize,c=!1,l=!1;const m=r.view.state.contentPixelRatio;let _=!1;F.clear(),q.length=0;const f=e.layerInfo[p.MAP];let y=0,T=null;for(;y<f.length;y++){const t=r.layerViewByIndex(y,p.MAP),g=t.layer.opacity,b=t.fullOpacity;if(l=l||a(t.layer),h(t)){let e="normal"!==t.layer.blendMode;if(i(t.layer.parent)){const r=S(t.layer.parent);null!=r&&""!==r&&(e=U(t.layer.parent)||e)}e&&(_=e,c=!1)}if(0===g&&!_){f[y].pendingUpdates&=~(k.TEXTURE_NOFADING&k.TEXTURE_FADING);continue}++n;const x=d(t),I=B(e,y,x);if(I){if(f[y].pendingUpdates&=~(k.TEXTURE_NOFADING&k.TEXTURE_FADING),i(t.layer.parent)){const e=S(t.layer.parent);null!=e&&""!==e&&G(t.layer.parent,y)}x?u=Math.max(u,this.tileSize*m):1===s&&1===b&&(t.isOpaque||this._dataToTexture(I)&&I.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++o,null===T&&(T=y)}}const g=u/this.tileSize;0!==o&&null!==T?1===o&&!_&&this._useLayerTexture(e,T)||this._composeMapLayers(e,t,y-1,l,u,g,!c||_,F,_):this._useBackgroundTexture(e,n)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=o,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useBackgroundTexture(e,t){const r=this._ensureBackgroundTexture(this.tileSize);let s=g.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(s=g.Delayed);const o=e.renderData;null==o.textureReference&&(s=g.Immediate),o.setTextureReference(new b(r,c.FADING,z,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,p.MAP),s=a(r.layer),o=s?e.surface.baseOpacity:1,i=s?1:e.surface.baseOpacity,n=r.fullOpacity,u=B(e,t,!1);return!!this._dataToTexture(u)&&(e.renderData.setTextureReference(new b(u.sourceLayerInfo.data,c.FADING,u,o,i,n)),!0)}_composeMapLayers(e,t,r,s,i,n,u,c,l){this._composition.ensureBuffer(i);const f=e.surface.baseOpacity;let y=!1,T=E.LINEAR_MIPMAP_LINEAR,g=!1,x=0;for(let b=r;b>=0;b--){const t=e.surface.layerViewByIndex(b,p.MAP),r=d(t),I=B(e,b,r),w=t.layer.opacity;if(!I||0===w&&!l)continue;const k=!a(t.layer)&&!y;k&&(y=!0);let R=!1;c.forEach((e=>{e.start===b&&(e.output=s?A.Composite:u&&k?this.backgroundIsGrid?A.GridComposite:A.ColorComposite:A.Composite,e.baseOpacity=k?f:1,q.push(e),this._composition.openGroup(i),R=!0)})),this._passParameters.baseOpacity=k&&!R&&f<1?f:1;const M=this._passParameters.baseOpacity<1?O.Required:O.NotRequired,D=0===x,L=R?A.GroupBackgroundComposite:u&&D?this.backgroundIsGrid?A.GridComposite:A.ColorComposite:A.Composite,j=P[h(t)?t.layer.blendMode:"normal"];for(this._passParameters.opacity=w,m(I)?g=this._composition.drawVectorData(this._passParameters,L,i,j,M,I,n,this.tileSize,g):_(I)?(this._composition.drawImageryTileData(this._passParameters,L,i,j,M,I),this._hasNearestInterpolation(I)&&(T=E.NEAREST)):this._dataToTexture(I)&&(this._passParameters.texture=I.sourceLayerInfo.data.texture,this._passParameters.offset=I.offset,this._passParameters.scale=I.scale,this._composition.drawRasterData(this._passParameters,L,i,j,M));q.length>0&&q[q.length-1].end===b;){const e=q.pop();this._passParameters.baseOpacity=e.baseOpacity;const t=this._passParameters.baseOpacity<1?O.Required:O.NotRequired;this._passParameters.opacity=e.opacity,this._passParameters.offset=o,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,e.output,i,P[e.blendMode],t)}x++}const I=e.renderData,w=l||y&&f<1,k=I.ensureTexture(i,w,(()=>this._buildTexture(i,w,T)));this._composition.copyFBOToTexture(k),this._composition.unbind(),I.setTextureReference(new b(k,t,z,y?1:f,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if(f(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return y(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,r=E.LINEAR_MIPMAP_LINEAR){if(null==e)return null;const s=new j;s.wrapMode=M.CLAMP_TO_EDGE,s.samplingMode=r,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=D.RGB);const o=this._rctx;let a;if("number"==typeof e){s.width=s.height=e;const t=`${e} ${s.pixelFormat}`;a=this._cache.pop(t),a?a.retain():a=new w(new L(o,s),this._cache)}else if(n(e)){s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=D.RGB);const t=`${e} ${s.pixelFormat}`;a=this._cache.pop(t),a?(a.retain(),a.texture.setData(e.image)):a=new w(new L(o,s,e.image),this._cache),e.release()}else try{s.width=e.width,s.height=e.height,a=new w(new L(o,s,e))}catch(u){a=new w(R(o)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const i=o.bindTexture(a.texture,L.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),o.bindTexture(i,L.TEXTURE_UNIT_FOR_UPDATES),a}get test(){return{backgroundTexture:this._backgroundTexture}}}function B(e,t,o){v.layerIndex=t,v.vtlNeighborInfos.clear();const a=e.layerInfo[p.MAP][t];if(r(v.offset,0,0),v.tile=e,v.scale=1,v.sourceLod=e.lij,v.sourceLayerInfo=a,v.isVTLBackground=o,a.data)return o&&e.forEachLoadedNeighbor(((r,s)=>{if(r.level!==e.level)return;const o=r.layerInfo[p.MAP][t];if(!T(o)||a.data===o.data)return;const i=v.vtlNeighborInfos.pushNew();i.offset=H[s],i.sourceLod=r.lij,i.sourceLayerInfo=o})),v;const i=a.upsampleInfo;if(i){const e=i.tile.layerInfo[p.MAP][t];return v.tile=i.tile,s(v.offset,i.offset),v.scale=i.scale,v.sourceLod=i.tile.lij,v.sourceLayerInfo=e,v}return o?v:null}function S(e){return e.uid}function U(e){let t="normal"!==e.blendMode;return i(e.parent)&&(t=U(e.parent)||t),t}function G(e,t){i(e.parent)&&G(e.parent,t);const r=S(e);if(null!=r&&""!==r){const s=F.get(r);s?s.start=t:F.set(r,new N(t,t,e.blendMode,e.opacity,A.Composite,1))}}const F=new Map,q=new Array,v=new I,z={offset:[0,0],scale:1},H=new Array;H[l.NORTH]=[0,-1],H[l.NORTH_EAST]=[-1,-1],H[l.EAST]=[-1,0],H[l.SOUTH_EAST]=[-1,1],H[l.SOUTH]=[0,1],H[l.SOUTH_WEST]=[1,1],H[l.WEST]=[1,0],H[l.NORTH_WEST]=[1,-1];export{N as GroupInfo,C as TileRenderer};
