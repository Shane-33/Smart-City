/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import r from"../../core/Error.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import"../../core/has.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import{combinedViewLayerTimeExtentProperty as i}from"../../layers/support/commonProperties.js";import{projectDatasetExtent as a,getDefaultDatumTransformationForDataset as n}from"../../layers/support/rasterFunctions/rasterProjectionHelper.js";import{getFetchPopupTemplate as l}from"./support/popupUtils.js";const p=p=>{let u=class extends p{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return a(this.layer.rasterInfo,this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return n(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(e){return!!a(this.layer.rasterInfo,e)}async fetchPopupFeatures(e,o){const{layer:s}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:i}=s,a=l(s,o);if(!i||null==a)throw new r("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:a});const n=[],{value:p,magdirValue:u,processedValue:c}=await s.identify(e,{timeExtent:this.timeExtent});let f="";if(p&&p.length){f="imagery-tile"===s.type&&s.hasStandardTime()&&null!=p[0]?p.map((e=>s.getStandardTimeValue(e))).join(", "):p.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]=c?.join(", ")??f,e[r+".Raw"]=f;const o=s.rasterInfo.attributeTable;if(null!=o){const{fields:t,features:r}=o,s=t.find((({name:e})=>"value"===e.toLowerCase())),i=s?r.find((e=>String(e.attributes[s.name])===f)):null;if(i)for(const o in i.attributes)if(i.attributes.hasOwnProperty(o)){e[this._rasterFieldPrefix+o]=i.attributes[o]}}const i=s.rasterInfo.dataType;"vector-magdir"!==i&&"vector-uv"!==i||(e["Raster.Magnitude"]=u?.[0],e["Raster.Direction"]=u?.[1]);const a=new t(this.fullExtent.clone(),null,e);a.layer=s,a.sourceLayer=a.layer,n.push(a)}return n}};return e([o()],u.prototype,"layer",void 0),e([o(i)],u.prototype,"timeExtent",void 0),e([o()],u.prototype,"view",void 0),e([o()],u.prototype,"fullExtent",null),e([o()],u.prototype,"tileInfo",void 0),e([o({readOnly:!0})],u.prototype,"hasTilingEffects",null),e([o()],u.prototype,"datumTransformation",null),u=e([s("esri.views.layers.ImageryTileLayerView")],u),u};export{p as default};
