/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import e from"../../../../Viewpoint.js";import"../../tiling/TileInfoView.js";import t from"../../tiling/TileKey.js";import"../../tiling/TileQueue.js";import"../../tiling/TileStrategy.js";import s from"../../ViewState.js";import{StyleLayerType as i}from"./style/StyleDefinition.js";import{RenderableTile as n}from"../webgl/RenderableTile.js";import{CompareFunction as r,StencilOperation as l}from"../../../webgl/enums.js";import a from"../../../../geometry/Point.js";const o=.125;class d{constructor(){this._renderParams={context:null,drawPhase:1,state:new s({viewpoint:new e({targetGeometry:new a(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new n(new t(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,s,i,n,r,l,a,o,d){const c=this._backgroundTile;this._updateRenderParams(e,t,c,s,n,r,l,a,o,d),this._renderParams.stencilSymbols=!1,s.drawBackground(this._renderParams,c,i)}renderContent(e,t,s,i,n,l,a,o,d,c,m,u){this._stencilSymbols(e,t,s,i,n,l,a,Math.round(1/o),d,c,m,u);let p=1;s.stencilRef=p++,e.setStencilFunction(r.EQUAL,s.stencilRef,255),this._render(e,t,s,n,l,a,o,d,c,m,u),i.forAll((t=>{t.sourceLayerInfo.data.stencilRef=p++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,n,l,a,Math.round(1/o),t.offset,c,m,u)}))}_stencilSymbols(e,t,s,i,n,a,o,d,c,m,u,p){let y=1;s.stencilRef=y++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(l.KEEP,l.KEEP,l.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(r.ALWAYS,s.stencilRef,255),this._stencilTileSymbols(e,t,s,n,a,o,d,c,m,u,p);for(const l of i.toArray()){const{sourceLod:t,offset:s,sourceLayerInfo:i}=l;i.data.stencilRef=y++,e.setStencilFunction(r.ALWAYS,i.data.stencilRef,255),this._stencilTileSymbols(e,t,i.data,n,a,o,d,s,m,u,p)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,s,n,l,a,o,d,c,m,u){e.setStencilFunction(r.EQUAL,s.stencilRef,255),this._render(e,t,s,n,l,a,o,d,c,m,u,i.SYMBOL)}_render(e,t,s,i,n,r,l,a,o,d,c,m){this._updateRenderParams(e,t,s,i,r,l,a,o,d,c),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,s,n,m)}_stencilTileSymbols(e,t,s,i,n,r,l,a,o,d,c){this._updateRenderParams(e,t,s,i,r,l,a,o,d,c),this._renderParams.stencilSymbols=!0,s.triangleCount=0,i.drawSymbols(this._renderParams,s,n)}_updateRenderParams(e,t,s,i,n,r,l,a,d,c){"type"in s&&"vector-tile"===s.type&&!s.stage&&s.attachWithContext(e);const m=t[0]-n.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=i,u.glyphMosaic=i.glyphMosaic,u.spriteMosaic=i.spriteMosaic,u.pixelRatio=d*c,u.displayLevel=m,u.requiredLevel=m;const p=n.getScale(t[0]),[y,h]=n.getOffset(t,r*p),f=o*r*p/a,g=s.transforms.dvs;g[0]=f,g[4]=-f,g[6]=-1-y-l[0]*r*2,g[7]=1+h+(1-l[1])*r*2-2,u.state.size[0]=a/c,u.state.size[1]=a/c,u.state.pixelRatio=c}}export{d as VectorTileRendererHelper3D};
