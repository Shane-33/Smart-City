/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{makeHandle as t}from"../../../../../core/handleUtils.js";import{Milliseconds as e}from"../../../../../core/time.js";import{imageTypeToCanvas as r}from"../../../../../geometry/support/meshUtils/exporters/gltf/imageutils.js";import{AnimatedSymbolRepeatType as i}from"../../../../../symbols/cim/enums.js";import{getMaterialGroup as a,getRandomValue as n}from"../grouping.js";function o(t){return e(t.frameDurations.reduce(((t,e)=>t+e),0))}function s(t){const{width:e,height:r}=t,i=t.frameDurations.reverse(),a=e=>{const r=t.frameDurations.length-1-e;return t.getFrame(r)};return{frameCount:t.frameCount,duration:t.duration,frameDurations:i,getFrame:a,width:e,height:r}}function m(t,r){const{width:i,height:a,getFrame:n}=t,o=r/t.duration,s=t.frameDurations.map((t=>e(t*o)));return{frameCount:t.frameCount,duration:t.duration,frameDurations:s,getFrame:n,width:i,height:a}}function u(t,r){const{width:i,height:a,getFrame:n}=t,o=t.frameDurations.slice(),s=o.shift();return o.unshift(e(s+r)),{frameCount:t.frameCount,duration:t.duration+r,frameDurations:o,getFrame:n,width:i,height:a}}function h(t,r){const{width:i,height:a,getFrame:n}=t,o=t.frameDurations.slice(),s=o.pop();return o.push(e(s+r)),{frameCount:t.frameCount,duration:t.duration+r,frameDurations:o,getFrame:n,width:i,height:a}}class c{constructor(t,e,r,i){this._animation=t,this._repeatType=r,this._onFrameData=i,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let a=0;for(;e>a;)a+=this.timeToFrame,this.nextFrame();const n=this._animation.getFrame(this._currentFrame);this._onFrameData(n)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case i.None:this._currentFrame-=this._direction;break;case i.Loop:this._currentFrame=0;break;case i.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case i.None:this._currentFrame-=this._direction;break;case i.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case i.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}}function f(t,r,f,l){let d,{repeatType:g}=r;if(null==g&&(g=i.Loop),!0===r.reverseAnimation&&(t=s(t)),null!=r.duration&&(t=m(t,e(1e3*r.duration))),null!=r.repeatDelay){const a=1e3*r.repeatDelay;g===i.Loop?t=h(t,e(a)):g===i.Oscillate&&(t=u(h(t,e(a/2)),e(a/2)))}if(null!=r.startTimeOffset)d=e(1e3*r.startTimeOffset);else if(null!=r.randomizeStartTime){const i=a(f),s=82749913,m=null!=r.randomizeStartSeed?r.randomizeStartSeed:s,u=n(i,m);d=e(u*o(t))}else d=e(0);return new c(t,d,g,l)}function l(e,r,i,a){const n=null==r.playAnimation||r.playAnimation,o=f(e,r,i,a);let s,m=o.timeToFrame;function u(){s=n?setTimeout((()=>{o.nextFrame(),m=o.timeToFrame,u()}),m):void 0}return u(),t((()=>n&&clearTimeout(s)))}let d,g;function F(){return d??=document.createElement("canvas"),g??=d.getContext("2d"),{canvas:d,ctx:g}}function _(t,e,i){const{canvas:a,ctx:n}=F();a.width=e,a.height=i;const o=[],s=t.frameDurations.length;for(let m=0;m<s;m++){const a=t.getFrame(m);n.clearRect(0,0,e,i),a instanceof ImageData?n.drawImage(r(a),0,0,e,i):n.drawImage(a,0,0,e,i),o.push(n.getImageData(0,0,e,i))}return{width:e,height:i,frameDurations:t.frameDurations,getFrame:t=>o[t],frameCount:t.frameCount,duration:t.duration}}export{c as Player,m as adjustDuration,h as appendDelay,f as createPlayer,o as getDuration,l as play,u as prependDelay,_ as resize,s as reverse};
