/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import t from"../../../../core/Error.js";import e from"../../../../core/Logger.js";import{watch as r}from"../../../../core/reactiveUtils.js";import{c as s}from"../../../../chunks/mat3f32.js";import{DisplayObject as i}from"../DisplayObject.js";import o from"./Mesh2D.js";import{VertexArrayObject as h}from"../../../webgl/VertexArrayObject.js";const a=t=>parseFloat(t)/100;class c extends i{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=r((()=>e.version),(()=>this._invalidate())),this.ready()}static fromClipArea(t,e){return new c(t,e)}_destroyGL(){null!=this._cache.mesh&&(this._cache.mesh.destroy(),this._cache.mesh=null),null!=this._cache.vao&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(t,e,r,s){const[i,o]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===i&&this._lastHeight===o||(this._lastWidth=i,this._lastHeight=o,this._destroyGL()),null==this._cache.vao){const i=this._createMesh(e,this._clip),o=i.getIndexBuffer(t),a=i.getVertexBuffers(t);this._cache.mesh=i,this._cache.vao=new h(t,r,s,a,o)}return this._cache.vao}_createTransforms(){return{dvs:s()}}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?a(e.left)*r:e.left,o="string"==typeof e.right?a(e.right)*r:e.right,h="string"==typeof e.top?a(e.top)*s:e.top,c="string"==typeof e.bottom?a(e.bottom)*s:e.bottom,n=i,l=h;return{x:n,y:l,width:Math.max(r-o-n,0),height:Math.max(s-c-l,0)}}_createMesh(r,s){switch(s.type){case"rect":return o.fromRect(this._createScreenRect(r,s));case"path":return o.fromPath(s);case"geometry":return o.fromGeometry(r,s);default:return e.getLogger("esri.views.2d.engine.webgl.ClippingInfo").error(new t("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),o.fromRect({x:0,y:0,width:1,height:1})}}}export{c as default};
