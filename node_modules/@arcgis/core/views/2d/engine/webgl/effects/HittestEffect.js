/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{hittestRadius as t,attributeDataGpgpu as e}from"../definitions.js";import{Effect as i}from"./Effect.js";import{PixelFormat as s,PixelType as r}from"../../../../webgl/enums.js";class o extends i{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:e},i,s=t){if(!i.length)return null;const r=i.shift(),o=r.x,n=r.y;return this._outstanding=r,{type:"hittest",distance:s*e,position:[o,n]}}bind(t){const{context:i,attributeView:s}=t;if(!s.size)return;const r=s.getBlock(e);if(null==r)return;const o=r.getFBO(i);i.setViewport(0,0,s.size,s.size),i.bindFramebuffer(o),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT)}unbind(t){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,i){const{context:o,attributeView:n}=t,c=n.getBlock(e);if(null==c)return void i.forEach((t=>t.resolve([])));const l=c.getFBO(o),d=new Uint8Array(l.width*l.height*4);try{await l.readPixelsAsync(0,0,l.width,l.height,s.RGBA,r.UNSIGNED_BYTE,d)}catch(u){return void i.forEach((t=>t.resolve([])))}const a=[];for(let e=0;e<d.length;e+=4){const t=d[e],i=d[e+3];t&&a.push({id:e/4,directHits:i})}a.sort(((t,e)=>e.directHits===t.directHits?e.id-t.id:e.directHits-t.directHits));const h=a.map((t=>t.id));i.forEach((t=>t.resolve(h)))}}export{o as HittestEffect};
