/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../../../core/Logger.js";import{disposeMaybe as t}from"../../../../../core/maybe.js";import{WGLSymbologyType as r}from"../enums.js";import i from"../VertexStream.js";import s from"./WGLGeometryBrushMarker.js";import{Effect as a}from"../effects/Effect.js";import{assertRendererSchema as u}from"../techniques/utils.js";import{ContextType as n}from"../../../../webgl/contextUtils.js";import{CompareFunction as o,DataType as l,BlendFactor as f,ClearBufferBit as c,TextureWrapMode as h,RenderbufferFormat as m,TextureSamplingMode as p,PixelType as d}from"../../../../webgl/enums.js";import{FramebufferObject as _}from"../../../../webgl/FramebufferObject.js";import{loadHeatmapTextureConfiguration as b}from"../../../../webgl/heatmapTextureUtils.js";import{Renderbuffer as w}from"../../../../webgl/Renderbuffer.js";import{RenderbufferDescriptor as F}from"../../../../webgl/RenderbufferDescriptor.js";import{Texture as g}from"../../../../webgl/Texture.js";import{TextureDescriptor as S}from"../../../../webgl/TextureDescriptor.js";const T=e.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");function v(e){return"heatmap"===e.type}function B(e,t){const{referenceScale:r,radius:i}=e;return i*(0!==r?r/t.scale:1)}class E extends s{constructor(){super(...arguments),this.brushEffect=new G}supportsSymbology(e){return e===r.HEATMAP}dispose(){super.dispose(),this.brushEffect.dispose(),this.brushEffect=null}prepareState(){}drawGeometry(e,t,r,i){const{defines:s}=this.brushEffect.loadQualityProfile(e.context);super.drawGeometry(e,t,r,i?[...i,...s]:s)}_drawMarkers(e,t,r,i,s,a,n){const{context:f,rendererInfo:c,state:h}=e,{rendererSchema:m}=c;u(m,"heatmap");const{isFieldActive:p}=m;r.setUniform1f("u_radius",B(m,h)),n||(r.setUniform1f("u_isFieldActive",p),f.setStencilFunction(o.GEQUAL,t.stencilRef,255)),f.drawElements(i,s,l.UNSIGNED_INT,a)}}const O={vsPath:"heatmap/heatmapResolve",fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])},x=.25,y=1/(2*x);function P(e){return e<y?1:x}class G extends a{constructor(){super(...arguments),this.name=this.constructor.name}createOptions({passOptions:e}){return e}dispose(){this._prevFBO=null,null!=this._accumulateFramebuffer&&this._accumulateFramebuffer.detachDepthStencilBuffer(),this._accumulateOutputStencilBuffer=t(this._accumulateOutputStencilBuffer),this._accumulateFramebuffer=t(this._accumulateFramebuffer),this._resolveGradientTexture=t(this._resolveGradientTexture),this._tileQuad=t(this._tileQuad)}bind(e){const{context:t,rendererInfo:r,passOptions:i,state:s}=e,{rendererSchema:a}=r;!(null!=i&&"hittest"===i.type)&&v(a)&&(this._prevFBO=t.getBoundFramebufferObject(),this._prevViewport=t.getViewport(),u(a,"heatmap"),this._loadResources(e),this._updateResources(t,a,s),t.bindFramebuffer(this._accumulateFramebuffer),t.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0),t.setBlendFunction(f.ONE,f.ONE),t.setClearColor(0,0,0,0),t.clear(c.COLOR_BUFFER_BIT))}unbind(){this._prevFBO=null,this._prevViewport=null}draw(e){const{context:t,painter:r,rendererInfo:i,passOptions:s}=e,{rendererSchema:a}=i;if(null!=s&&"hittest"===s.type||!v(a))return;const{defines:u}=this.loadQualityProfile(t),n=r.materialManager.getProgram(O,u);t.useProgram(n),t.bindFramebuffer(this._prevFBO),t.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),t.setBlendFunction(f.ONE,f.ONE_MINUS_SRC_ALPHA),t.setStencilTestEnabled(!1);const{radius:o,minDensity:l,densityRange:c}=a;t.bindTexture(this._accumulateFramebuffer.colorTexture,8),t.bindTexture(this._resolveGradientTexture,9),n.setUniform1i("u_texture",8),n.setUniform1i("u_gradient",9),n.setUniform2f("u_densityMinAndInvRange",l,1/c),n.setUniform1f("u_densityNormalization",3/(o*o*Math.PI)),this._tileQuad.draw()}_loadResources({context:e,painter:t}){const{dataType:r,samplingMode:s,pixelFormat:a,internalFormat:u,requiresSharedStencilBuffer:n}=this.loadQualityProfile(e),{width:o,height:l}=this._prevViewport,f=n?1:x,c=o*f,p=l*f;let d=new S(c,p);d.pixelFormat=a,d.internalFormat=u,d.dataType=r,d.samplingMode=s,d.wrapMode=h.CLAMP_TO_EDGE,n||(this._accumulateOutputStencilBuffer??=new w(e,new F(m.DEPTH_STENCIL,c,p))),this._accumulateFramebuffer??=new _(e,d,n?t.getSharedStencilBuffer():this._accumulateOutputStencilBuffer),d=new S,d.wrapMode=h.CLAMP_TO_EDGE,this._resolveGradientTexture??=new g(e,d),this._tileQuad??=new i(e,[0,0,1,0,0,1,1,1])}_updateResources(e,t,r){const{gradientHash:i,gradient:s}=t;this._prevGradientHash!==i&&(this._resolveGradientTexture.resize(s.length/4,1),this._resolveGradientTexture.setData(s),this._prevGradientHash=i);const{requiresSharedStencilBuffer:a}=this.loadQualityProfile(e),u=a?1:P(B(t,r)),{width:n,height:o}=this._prevViewport,l=n*u,f=o*u,{width:h,height:m}=this._accumulateFramebuffer;if(h!==l||m!==f){const e=this._accumulateFramebuffer.depthStencil;if(a&&null!=e){const{width:t,height:r}=e.descriptor;t===l&&r===f||(T.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer())}this._accumulateFramebuffer.resize(l,f)}a||e.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,c.STENCIL_BUFFER_BIT,p.NEAREST)}loadQualityProfile(e){if(null==this._qualityProfile){const t=b(e,T),r=e.type===n.WEBGL1;this._qualityProfile={...t,requiresSharedStencilBuffer:r,defines:t.dataType!==d.FLOAT?["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile}}export{E as default};
