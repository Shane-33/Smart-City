/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{nextPowerOfTwo as t}from"../../../../../core/mathUtils.js";import{c as e}from"../../../../../chunks/mat3f32.js";import{f as r}from"../../../../../chunks/vec4f32.js";import{vtlTextureBindingUnitSprites as o,vtlHighResCutoff as i}from"../definitions.js";import{WGLDrawPhase as s}from"../enums.js";import{u32to4Xu8 as a}from"../number.js";import n from"./WGLBrush.js";import{BufferObject as c}from"../../../../webgl/BufferObject.js";import{TextureSamplingMode as l,CompareFunction as m,PrimitiveType as f,Usage as u}from"../../../../webgl/enums.js";import{VertexArrayObject as p}from"../../../../webgl/VertexArrayObject.js";class _ extends n{constructor(){super(...arguments),this._color=r(1,0,0,1),this._patternMatrix=e(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(e,r){const{context:n,painter:c,styleLayerUID:u,requestRender:p,allowDelayedRender:_}=e;this._loadWGLResources(e);const d=e.displayLevel,h=e.styleLayer,g=h.backgroundMaterial,v=c.vectorTilesMaterialManager,y=h.getPaintValue("background-color",d),b=h.getPaintValue("background-opacity",d),x=h.getPaintValue("background-pattern",d),M=void 0!==x,j=y[3]*b,U=1|window.devicePixelRatio,w=e.spriteMosaic;let L,A;const P=U>i?2:1,I=e.drawPhase===s.HITTEST,R=this._programOptions;R.id=I,R.pattern=M;const k=v.getMaterialProgram(n,g,R);if(!_||null==p||k.compiled){if(n.bindVAO(this._vao),n.useProgram(k),M){const t=w.getMosaicItemPosition(x,!0);if(null!=t){const{tl:e,br:r,page:i}=t;L=r[0]-e[0],A=r[1]-e[1];const s=w.getPageSize(i);null!=s&&(w.bind(n,l.LINEAR,i,o),k.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),k.setUniform2fv("u_mosaicSize",s),k.setUniform1i("u_texture",o))}k.setUniform1f("u_opacity",b)}else this._color[0]=j*y[0],this._color[1]=j*y[1],this._color[2]=j*y[2],this._color[3]=j,k.setUniform4fv("u_color",this._color);if(k.setUniform1f("u_depth",h.z||0),I){const t=a(u+1);k.setUniform4fv("u_id",t)}for(const e of r){if(k.setUniform1f("u_coord_range",e.rangeX),k.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),M){const r=Math.max(2**(Math.round(d)-e.key.level),1),o=P*e.width*r,i=o/t(L),s=o/t(A);this._patternMatrix[0]=i,this._patternMatrix[4]=s,k.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}n.setStencilFunction(m.EQUAL,0,255),n.drawArrays(f.TRIANGLE_STRIP,0,4)}}else p()}_loadWGLResources(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),s=c.createVertex(e,u.STATIC_DRAW,i),a=new p(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:s});this._vao=a}}export{_ as WGLBrushVTLBackground};
