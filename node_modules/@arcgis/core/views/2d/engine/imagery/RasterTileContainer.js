/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{create as e}from"../../../../geometry/support/aaBoundingRect.js";import{getWorldWidth as r}from"../../viewpointUtils.js";import s from"./BrushRasterBitmap.js";import{RasterTile as t}from"./RasterTile.js";import{WGLDrawPhase as i}from"../webgl/enums.js";import n from"../webgl/TileContainer.js";class o extends n{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(e){const r=this._getTileBounds(e),[s,i]=this._tileInfoView.tileInfo.size,n=this._tileInfoView.getTileResolution(e.level);return new t(e,n,r[0],r[3],s,i)}prepareRenderPasses(e){const r=e.registerRenderPass({name:"imagery (tile)",brushes:[s],target:()=>this.children.map((e=>e.bitmap)),drawPhase:i.MAP});return[...super.prepareRenderPasses(e),r]}doRender(e){if(!this.visible||e.drawPhase!==i.MAP)return;const{rasterFunctionChain:r}=this;if(!r)return e.renderPass="raster-bitmap",void super.doRender(e);if(!r.hasFocalFunction){const[r,s]=this._tileInfoView.tileInfo.size;e.renderPass="raster",e.rasterFunction={name:"Reproject",parameters:{targetImageSize:[r,s],requireBilinear:!1},pixelType:"f32",id:0,isNoopProcess:!1},super.doRender(e)}if(r?.functions.length){const{functions:s,hasBranches:t}=r;for(let r=0;r<s.length;r++){const i=s[r];"Constant"!==i.name&&"Identity"!==i.name&&(e.renderPass="raster",e.rasterFunction=i,e.hasBranches=t,super.doRender(e))}}e.rasterFunction=null,e.renderPass="bitmap",super.doRender(e)}_getTileBounds(s){const t=this._tileInfoView.getTileBounds(e(),s);if(this.isCustomTilingScheme&&s.world){const{tileInfo:e}=this._tileInfoView,i=r(e.spatialReference);if(i){const r=e.lodAt(s.level);if(!r)return t;const{resolution:n}=r,o=i/n%e.size[0],a=o?(e.size[0]-o)*n:0;t[0]-=a*s.world,t[2]-=a*s.world}}return t}}export{o as RasterTileContainer};
