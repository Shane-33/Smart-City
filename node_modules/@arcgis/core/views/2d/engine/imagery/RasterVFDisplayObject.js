/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{g as t,h as e,r as s,l as a,m as r}from"../../../../chunks/mat3.js";import{c as i}from"../../../../chunks/mat3f32.js";import{f as o}from"../../../../chunks/vec2f32.js";import{createVFMesh as l,createVFMeshScalar as n}from"../../../../layers/support/rasterFunctions/vectorFieldUtils.js";import{DisplayObject as c}from"../DisplayObject.js";import{createProgramDescriptor as h}from"../webgl/Utils.js";import{BufferObject as m}from"../../../webgl/BufferObject.js";import{Usage as u,DataType as d}from"../../../webgl/enums.js";import{VertexArrayObject as v}from"../../../webgl/VertexArrayObject.js";class f extends c{constructor(t=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.key=null,this.offset=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.vaoData=null,this.width=null,this.source=t}destroy(){null!=this.vaoData&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(t){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(t)&&(this._symbolizerParameters=t,this.invalidateVAO())}get source(){return this._source}set source(t){this._source=t,this.invalidateVAO()}invalidateVAO(){this._vaoInvalidated||null==this.vaoData||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(t){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,null!=this.source&&null==this.vaoData){const{style:e}=this.symbolizerParameters;switch(e){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const e=l(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(t.context,e);this.vaoData={magdir:s}}break;case"simple_scalar":{const e=n(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(t.context,e);this.vaoData={scalar:s}}break;case"wind_speed":{const e=l(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(t.context,e),a=n(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(t.context,a);this.vaoData={magdir:s,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:i()}}setTransform(i){const l=t(this.transforms.dvs),[n,c]=i.toScreenNoRotation([0,0],[this.x,this.y]),h=this.resolution/this.pixelRatio/i.resolution,m=h*this.width,u=h*this.height,d=Math.PI*this.rotation/180;e(l,l,o(n,c)),e(l,l,o(m/2,u/2)),s(l,l,-d),e(l,l,o(-m/2,-u/2)),a(l,l,o(m,u)),r(this.transforms.dvs,i.displayViewMat3,l)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(t,e){const{vertexData:s,indexData:a}=e,r=m.createVertex(t,u.STATIC_DRAW,new Float32Array(s)),i=m.createIndex(t,u.STATIC_DRAW,new Uint32Array(a)),o=h("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:d.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:d.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:d.FLOAT,normalized:!1}]});return{vao:new v(t,o.attributes,o.bufferLayouts,{geometry:r},i),elementCount:a.length}}}export{f as RasterVFDisplayObject};
