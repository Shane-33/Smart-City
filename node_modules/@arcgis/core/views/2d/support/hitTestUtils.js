/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../../../Graphic.js";import{isSome as r}from"../../../core/arrayUtils.js";import{isIterable as t}from"../../../core/iteratorUtils.js";import{isSupportedScreenPointEvent as a,createScreenPointFromSupportedEvent as i}from"../../support/screenUtils.js";async function l(e,t,l){const p=a(t)?i(e,t):t;if(!e.ready||isNaN(p.x)||isNaN(p.y))return{screenPoint:p,results:[]};let d=new Set;const f=new Set;let u=!1,y=null,h=null;l?.include?n(l.include,s(e,(e=>{d.add(e),c(e,(e=>f.add(e)))}),((e,r)=>{f.add(e),d.add(r)}),(e=>{y||(y=new Set),y.add(e)}),(e=>d.add(e)),(()=>u=!0))):(u=!0,d=new Set(e.allLayerViews),d.forEach((e=>{c(e,(e=>f.add(e)))}))),l?.exclude&&n(l.exclude,s(e,(e=>{d.delete(e),c(e,(e=>f.delete(e)))}),(e=>f.delete(e)),(e=>{h||(h=new Set),h.add(e)})));const g=e.allLayerViews.filter((e=>!e.suspended&&d.has(e))).reverse(),w=e.toMap(p);let m=[...u?e.graphicsView.hitTest(w).map((e=>({type:"graphic",graphic:e,layer:null,mapPoint:w}))):[],...await Promise.all(g.map((e=>e.hitTest(w,p))).toArray())].filter(r).flat().filter(r);return m=m.filter((e=>"graphic"!==e.type||"subtype-group"!==e.layer?.type||f.has(e.graphic.layer))),y&&(m=m.filter((e=>!("graphic"in e)||!e.graphic||y?.has(o(e.graphic))))),h&&(m=m.filter((e=>!("graphic"in e)||!e.graphic||!h?.has(o(e.graphic))))),{screenPoint:p,results:m}}function s(r,t,a,i,l,s){return n=>{if(n instanceof e){if(n.layer===r)s?.();else{const e=r.allLayerViews.find((e=>e.layer===n.layer));e&&l?.(e)}i(o(n))}else if("subtype-sublayer"===n.type){const e=r.allLayerViews.find((e=>e.layer===n.parent));e&&a(n,e)}else{const e=r.allLayerViews.find((e=>e.layer===n));e&&t(e)}}}function n(e,r){if(e)if(t(e))for(const a of e)if(t(a))for(const e of a)r(e);else r(a);else r(e)}function o(e){const r=e.getObjectId();return r?`${e.layer?.uid??e.sourceLayer?.uid??"MapView"}/${r}`:`"MapView/${e.uid}`}function c({layer:e},r){"subtype-group"===e.type&&e.sublayers.forEach((e=>{r(e)}))}export{l as hitTest};
