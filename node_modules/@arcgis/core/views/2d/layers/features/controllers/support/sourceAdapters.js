/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import has from"../../../../../../core/has.js";import e from"../../../../../../core/workers/Connection.js";import{toQuantizationTransform as t}from"../../../../../../geometry/support/quantizationUtils.js";import{convertFromFeatureSet as r,quantizeOptimizedFeatureSet as a}from"../../../../../../layers/graphics/featureConversionUtils.js";import{queryOptimizedFeatureSet as s}from"../../../../../../layers/ogc/ogcFeatureUtils.js";import i from"../../../../../../layers/support/FieldsIndex.js";import{executeQueryPBFBuffer as o,executeQuery as n}from"../../../../../../rest/query/operations/query.js";import{FeatureSetReaderJSON as c}from"../../support/FeatureSetReaderJSON.js";import{FeatureSetReaderPBF as u}from"../../support/FeatureSetReaderPBF.js";class m{constructor(e){this.service=e,this._arcadeLayerSchema={...e,fieldsIndex:i.fromJSON(e.fieldsIndex)}}destroy(){}}function p(e){return Array.isArray(e.source)}function l(e){return"ogc-source"===e?.type}function y(e){const{capabilities:t}=e;return l(e.source)?new F(e):p(e)?new h(e):t.query.supportsFormatPBF&&has("featurelayer-pbf")?new d(e):new S(e)}async function f(t){const r=new e;return await r.open(t,{}),r}class h extends m{constructor(e){super(e),this._portsOpen=f(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return c.fromFeatureSet(r,this._arcadeLayerSchema)}}class d extends m{async executeQuery(e,t){const{data:r}=await o(this.service.source,e,t),a=!e.quantizationParameters;return u.fromBuffer(r,this._arcadeLayerSchema,a)}}class S extends m{async executeQuery(e,s){const{source:i,capabilities:o,spatialReference:u,objectIdField:m,geometryType:p}=this.service;if(null!=e.quantizationParameters&&!o.query.supportsQuantization){const o=e.clone(),p=t(o.quantizationParameters);o.quantizationParameters=null;const{data:l}=await n(i,o,u,s),y=r(l,m);return a(p,y),c.fromOptimizedFeatureSet(y,this._arcadeLayerSchema)}const{data:l}=await n(i,e,this.service.spatialReference,s);return"esriGeometryPoint"===p&&(l.features=l.features?.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),c.fromFeatureSet(l,this._arcadeLayerSchema)}}class F extends m{async executeQuery(e,r){const{capabilities:i}=this.service;if(e.quantizationParameters&&!i.query.supportsQuantization){const i=e.clone(),o=t(i.quantizationParameters);i.quantizationParameters=null;const n=await s(this.service.source,e,r);return a(o,n),c.fromOptimizedFeatureSet(n,this._arcadeLayerSchema)}const o=await s(this.service.source,e,r);return c.fromOptimizedFeatureSet(o,this._arcadeLayerSchema)}}export{m as SourceAdapter,y as createSourceAdapter};
