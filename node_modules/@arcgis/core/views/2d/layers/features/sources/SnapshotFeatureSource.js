/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../core/has.js";import t from"../../../../../core/Logger.js";import{assertIsSome as s}from"../../../../../core/maybe.js";import{throwIfAborted as r,after as o}from"../../../../../core/promiseUtils.js";import a from"../../../../../core/RandomLCG.js";import{subclass as n}from"../../../../../core/accessorSupport/decorators/subclass.js";import{BaseFeatureSource as i}from"./BaseFeatureSource.js";import{FeatureSetReaderIndirect as d}from"../support/FeatureSetReaderPBFIndirect.js";import{UpdateToken as u}from"../support/UpdateToken.js";function l(e,t,s){const r=e.getXHydrated(),o=e.getYHydrated(),a=t.getColumnForX(r),n=Math.floor(t.normalizeCol(a));return`${s}/${Math.floor(t.getRowForY(o))}/${n}`}function h(e,t){if(null==e)return null;const s=t.transform,r=e.getQuantizationTransform();if(null==r){const[t,r]=s.scale,[o,a]=s.translate,n=-o/t,i=1/t,d=a/r,u=1/-r;return e.transform(n,d,i,u)}const[o,a]=r.scale,[n,i]=r.translate,[d,u]=s.scale,[l,h]=s.translate,c=o/d,g=(n-l)/d,p=a/u,_=(-i+h)/u;return e.transform(g,_,c,p)}let c=class extends i{constructor(e){super(e),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new a(1e3),this._store=e.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(e,t){super.update(e,t),this._featureCount??=t.initialFeatureCount,null!=t.changedFeatureCount&&(this._featureCount=t.changedFeatureCount),this._hasAggregates=!!e.targets?.aggregate}async resend(e=!1){if(await this._downloadPromise,this._invalidated||e){const e=this._featureCount;return s(e,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach((e=>e.clear())),this._downloadPromise=this._download(e),void await this._downloadPromise}const t=this._queries.map((({query:e,reader:t})=>this._sendPatchQuery(e,t)));await Promise.all(t),this._subscriptions.forEach((e=>{e.requests.done.forEach((e=>this._onMessage(e.message)))}))}async refresh(e,t){t&&(this._featureCount=t.featureCount),await this.resend(!0)}async _sendPatchQuery(e,t){const s=null!=e.outFields?e.outFields:[],o=this._queryInfo.outFields,a=o.filter((e=>!s.includes(e)));if(!a.length)return;const n=e.clone(),i=this._signal;n.returnGeometry=!1,n.returnCentroid=!1,n.outFields=a,e.outFields=o;const d=await this.enqueueQuery({query:n,depth:0,signal:i});r({signal:i}),t.joinAttributes(d)}async _fetchDataTile(e){this._downloadPromise??=this._download(this._featureCount);const t=this._store.search(e),s=this._subscriptions.get(e.key.id),r=t.length-1;for(let d=0;d<r;d++){const r=h(t[d],e),a={type:"append",id:e.id,addOrUpdate:r,end:!1,status:u.empty()};s.add({query:null,message:a}),this._hasAggregates||await o(1),this._onMessage(a)}const a=h(r>=0?t[r]:null,e),n=this._didSendEnd,i={type:"append",id:e.id,addOrUpdate:a,end:n,status:u.empty()};s.add({query:null,message:i}),this._onMessage(i)}async _download(e){try{await this.whenInitialized();const t=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;t.clear();const r=Math.ceil(e/this.pageSize),o=Array.from({length:r},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())).map((e=>this._downloadPage(e,t,s)));await Promise.all(o),this._store.sweepFeatures(t,this._store.storage),this._store.sweepFeatureSets(s)}catch(s){t.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",s)}this._sendEnd(),this._loading=!1}async _downloadPage(e,t,s){const o=this.pageSize,a={start:e*o,num:o,cacheHint:!0};null!=this.maxRecordCountFactor&&(a.maxRecordCountFactor=this.maxRecordCountFactor);const n=this.createQuery(a),i=this._signal,d=await this.enqueueQuery({query:n,depth:e,signal:i});r({signal:i}),this._queries.push({query:n,reader:d}),this._store.insert(d),s.add(d.instance);const u=d.getCursor();for(;u.next();)t.set(u.getDisplayId());this._send(d)}_send(e){if(!this._subscriptions.size)return;let t=null;const s=new Map,r=new Set,o=new Map;this._subscriptions.forEach((e=>{const a=e.tile;s.set(a.key.id,null),t=a.tileInfoView,r.add(a.level);const{row:n,col:i}=a.key,d=`${a.level}/${n}/${i}`,u=o.get(d)??[];u.push(e),o.set(d,u)}));for(const a of r){const r=t.getLODInfoAt(a),n=e.getCursor();for(;n.next();){const e=l(n,r,a),t=n.getIndex();if(o.has(e))for(const r of o.get(e)){const e=r.tile.id;let o=s.get(e);null==o&&(o=[],s.set(e,o)),o.push(t)}}}s.forEach(((t,s)=>{if(null!=t){const r=this._subscriptions.get(s),o={type:"append",id:s,addOrUpdate:h(d.from(e,t),r.tile),end:!1,status:u.empty()};r.add({query:null,message:o}),this._onMessage(o)}}))}_sendEnd(){this._subscriptions.forEach((e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:u.empty()};e.add({query:null,message:t}),this._onMessage(t)})),this._didSendEnd=!0}};c=e([n("esri.view.2d.layers.features.sources.SnapshotFeatureSource")],c);export{c as SnapshotFeatureSource};
