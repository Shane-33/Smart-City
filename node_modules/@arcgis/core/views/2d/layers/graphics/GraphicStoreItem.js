/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{create as t,containsPointWithMargin as e}from"../../../../geometry/support/aaBoundingRect.js";import{polygonCentroid as s}from"../../../../geometry/support/centroid.js";import{isPolygon as r,getJsonType as i}from"../../../../geometry/support/jsonUtils.js";import{quantizePoint as o,quantizeGeometry as n}from"../../../../geometry/support/quantizationUtils.js";import{getInfo as l}from"../../../../geometry/support/spatialReferenceUtils.js";import{convertFromPolyline as u,generalizeOptimizedGeometry as h,quantizeOptimizedGeometry as a,convertToPolyline as m}from"../../../../layers/graphics/featureConversionUtils.js";import c from"../../../../layers/graphics/OptimizedGeometry.js";const p=new c,y=new c,g="esriGeometryPolyline";function f(t){t.coords.length=0,t.lengths.length=0}class d{constructor(){this.bounds=t(),this.graphic=null}static acquire(t=null,e,s,r,i){let o;return 0===d._pool.length?o=new d:(o=d._pool.pop(),this._set.delete(o)),o.acquire(t,e,s,r,i),o}static release(t){t&&!this._set.has(t)&&(t.release(),this._pool.push(t),this._set.add(t))}static getCentroidQuantized(t,e){if(r(t.geometry)){const r=t.symbol;if(null==r)return null;if(r?.layers.length>0&&r.layers.some((t=>"text"===t.type||"marker"===t.type))){const r=s(t.geometry);return null!==r?o(e,{},{x:r[0],y:r[1]},!1,!1):null}}return null}acquire(t=null,e,s,r,i){t&&this.set(t,e,s,r,i)}release(){this.graphic=null,this.symbolResource=null,this.geometry=null}get symbol(){return this.symbolResource.symbol}set(t,e,s,r,i){this.graphic=t,this.geometry=s,this.symbolResource=e,this.bounds=r,i&&(this.size=i)}getGeometryQuantized(t,s,r,o){const c=this.geometry,d=i(c);if(null==d)return null;switch(d){case"esriGeometryPolygon":{const e=c,{rings:s}=e;if(!s||0===s.length)return null;let r;if(r=1===s.length&&2===s[0].length?n(t,{paths:[[s[0][0],s[0][1]]]}):n(t,this.geometry),!r){const e={x:s[0][0][0],y:s[0][0][1]};if(r=n(t,e),r){const{x:t,y:e}=r;return{rings:[[[t-1,e],[1,-1],[1,1],[-1,1],[-1,-1]]]}}}return r}case"esriGeometryPolyline":{const e=c;f(p),f(y);const s=e.hasZ??!1,r=e.hasM??!1;return u(p,e),h(y,p,s,r,g,t.scale[0]),a(p,y,s,r,g,t),m(p,e.hasZ??!1,e.hasM??!1)}case"esriGeometryMultipoint":{const i=c,u=.5*o*Math.max(Math.abs(this.size[0])+this.size[2]-this.size[0],Math.abs(this.size[1])+this.size[3]-this.size[1]),h=l(r);let a=i.points;if(h){const[t,r]=h.valid,i=r-t;a=a.filter((o=>{if(o[0]+u>r||o[0]-u<t){const t=[...o];return o[0]+u>r?t[0]-=i:t[0]+=i,e(s,o,u)||e(s,t,u)}return e(s,o,u)}))}return 0===a.length?{points:a}:n(t,{points:a})}}return n(t,this.geometry)}}d._pool=[],d._set=new Set;export{d as default};
